<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿ QR Code é»åç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ jsQR æƒæåº« -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.0.4/dist/jsQR.min.js"></script>
    <!-- è¼‰å…¥ qrcode.js ç”¢ç”Ÿ QR Code å‡½å¼åº« (æ–°å¢) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        body { font-family: 'Inter', sans-serif; }
        /* ç‚ºäº† QR æƒæå™¨ï¼Œç¢ºä¿ video å’Œ canvas ä½”æ»¿å®¹å™¨ */
        .scanner-container {
            position: relative;
            width: 100%;
            height: 400px; /* å›ºå®šé«˜åº¦æ–¹ä¾¿ä½ˆå±€ */
            overflow: hidden;
            background-color: #1f2937;
        }
        .scanner-container video, 
        .scanner-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* æ°´å¹³ç¿»è½‰ç›¸æ©Ÿç•«é¢ */
        }
        #highlightCanvas {
            z-index: 10;
        }
        /* æƒææ¡†å‹•ç•« */
        @keyframes scan-line {
            0% { top: 0; opacity: 1; }
            50% { top: 100%; opacity: 0.5; }
            100% { top: 0; opacity: 1; }
        }
        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 80%;
            max-width: 300px;
            max-height: 300px;
            transform: translate(-50%, -50%);
            border: 4px solid #34d399; /* ç¶ è‰²é‚Šæ¡† */
            z-index: 5;
        }
        .scan-frame::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, transparent, #34d399, transparent);
            animation: scan-line 2s infinite linear;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">ğŸ“ å­¸ç”Ÿ QR Code é»åç³»çµ±</h1>
            <p class="text-gray-500">ä½¿ç”¨æ‚¨çš„è¨­å‚™ç›¸æ©Ÿæƒæå­¸ç”Ÿçš„ QR Code ä»¥è¨˜éŒ„å‡ºå¸­ã€‚</p>
            <div id="auth-status" class="text-sm mt-2 p-2 rounded-md bg-yellow-100 text-yellow-800 hidden">
                èº«ä»½é©—è­‰ä¸­...
            </div>
        </header>

        <!-- å°èˆªæ¨™ç±¤ -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button type="button" onclick="switchTab('scanner')" id="tab-scanner" class="tab-button inline-flex items-center px-4 py-2 border-b-2 font-medium text-sm focus:outline-none transition-colors duration-200 text-green-600 border-green-500">
                    é»åæƒæå™¨
                </button>
                <button type="button" onclick="switchTab('roster')" id="tab-roster" class="tab-button inline-flex items-center px-4 py-2 border-b-2 font-medium text-sm focus:outline-none transition-colors duration-200 text-gray-500 border-transparent hover:border-gray-300 hover:text-gray-700">
                    å­¸ç”Ÿåå–®ç®¡ç†
                </button>
                <button type="button" onclick="switchTab('records')" id="tab-records" class="tab-button inline-flex items-center px-4 py-2 border-b-2 font-medium text-sm focus:outline-none transition-colors duration-200 text-gray-500 border-transparent hover:border-gray-300 hover:text-gray-700">
                    é»åè¨˜éŒ„
                </button>
            </nav>
        </div>

        <!-- 1. é»åæƒæå™¨ (Tab) -->
        <div id="content-scanner" class="tab-content">
            <div class="lg:flex lg:space-x-8">
                <!-- æƒæå€åŸŸ -->
                <div class="lg:w-1/2 mb-6 lg:mb-0">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç›¸æ©Ÿæƒæ</h2>
                    <div id="scanner-area" class="scanner-container rounded-xl shadow-2xl relative">
                        <video id="video" playsinline autoplay></video>
                        <canvas id="canvas" class="hidden"></canvas>
                        <canvas id="highlightCanvas"></canvas>
                        <div class="scan-frame"></div>
                        <div id="camera-message" class="absolute inset-0 bg-gray-800/90 text-white flex items-center justify-center p-4 rounded-xl text-center z-20">
                            æ­£åœ¨è¼‰å…¥ç›¸æ©Ÿ...
                        </div>
                    </div>
                    <div id="scan-result" class="mt-4 p-4 bg-gray-800 rounded-xl text-white text-center text-lg shadow-inner">
                        è«‹å°‡ QR Code ç½®æ–¼æƒææ¡†å…§
                    </div>
                </div>

                <!-- é»åå³æ™‚çµæœ -->
                <div class="lg:w-1/2">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">æœ€æ–°é»å</h2>
                    <div id="latest-attendance" class="p-6 bg-white border border-green-500 rounded-xl shadow-lg space-y-4">
                        <p class="text-gray-500">ç­‰å¾…ç¬¬ä¸€æ¬¡æƒæ...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. å­¸ç”Ÿåå–®ç®¡ç† (Tab) -->
        <div id="content-roster" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">æ–°å¢æˆ–æ›´æ–°å­¸ç”Ÿåå–®</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <form id="add-student-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label for="studentId" class="block text-sm font-medium text-gray-700">å­¸è™Ÿ (ä½œç‚º QR Code å…§å®¹)</label>
                        <input type="text" id="studentId" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="e.g. S1001">
                    </div>
                    <div class="md:col-span-2">
                        <label for="studentName" class="block text-sm font-medium text-gray-700">å§“å</label>
                        <input type="text" id="studentName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="e.g. ç‹å°æ˜">
                    </div>
                    <button type="submit" class="md:col-span-1 w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-150 shadow-md">
                        æ–°å¢ / æ›´æ–°å­¸ç”Ÿ
                    </button>
                </form>
            </div>
            
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç•¶å‰å­¸ç”Ÿåå–®</h2>
            <div id="roster-list" class="bg-white rounded-xl shadow-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å­¸è™Ÿ (QR å…§å®¹)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å§“å</th>
                            <!-- å°‡æ“ä½œæ¬„æ¨™é¡Œå°é½Šå³å´ -->
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="roster-tbody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="3" class="text-center py-4 text-gray-500">æ­£åœ¨è¼‰å…¥åå–®...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 p-4 rounded-xl bg-blue-100 text-blue-800">
                <p>è«‹æ³¨æ„ï¼šå­¸è™Ÿæ¬„ä½çš„å€¼å°‡è¢«ç”¨ä½œå­¸ç”Ÿçš„ QR Code å…§å®¹ã€‚æ‚¨ç¾åœ¨å¯ä»¥ç›´æ¥é»æ“Šã€Œç”¢ç”Ÿ QR Codeã€æŒ‰éˆ•ç²å–åœ–åƒã€‚</p>
            </div>
        </div>

        <!-- 3. é»åè¨˜éŒ„ (Tab) -->
        <div id="content-records" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">æ‰€æœ‰é»åè¨˜éŒ„</h2>
                <button type="button" onclick="exportToCSV()" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-150 shadow-md flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2-8H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2z"></path></svg>
                    åŒ¯å‡ºç‚º Excel (CSV)
                </button>
            </div>
            <div id="records-list" class="bg-white rounded-xl shadow-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å­¸è™Ÿ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å§“å</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é»åæ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody id="records-tbody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="3" class="text-center py-4 text-gray-500">æ­£åœ¨è¼‰å…¥è¨˜éŒ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- éŒ¯èª¤/æç¤ºè¨Šæ¯æ¨¡æ…‹æ¡† -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl space-y-4">
            <h3 id="modal-title" class="text-xl font-bold text-gray-900">æç¤º</h3>
            <p id="modal-message" class="text-gray-700"></p>
            <div class="flex justify-end">
                <button onclick="closeModal()" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-150">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- QR Code é¡¯ç¤ºæ¨¡æ…‹æ¡† (æ–°å¢) -->
    <div id="qr-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-8 w-full max-w-md shadow-2xl space-y-6">
            <h3 id="qr-modal-title" class="text-2xl font-bold text-gray-900 text-center"></h3>
            <p class="text-center text-gray-600">è«‹å°‡æ­¤ QR Code åœ–åƒï¼ˆå³éµæˆ–é•·æŒ‰ï¼‰å„²å­˜æˆ–åˆ—å°çµ¦å­¸ç”Ÿä½¿ç”¨ã€‚</p>
            <div id="qrcode-container" class="flex justify-center p-4 border border-gray-200 rounded-lg bg-gray-50">
                <!-- QR Code å°‡è¢«ç¹ªè£½åˆ°æ­¤è™• -->
            </div>
            <p id="qr-content-display" class="text-center font-mono text-sm text-gray-800 break-all"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeQRModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 transition duration-150">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- è¼‰å…¥ Firebase SDK å’Œæ‡‰ç”¨ç¨‹å¼é‚è¼¯ -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, onSnapshot, collection, serverTimestamp, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- è®Šæ•¸åˆå§‹åŒ– ---
        setLogLevel('debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth, userId;
        let rosterData = {}; // ç”¨æ–¼å¿«å–åå–®ï¼ŒåŠ é€Ÿé»å

        // UI å…ƒç´ 
        const authStatusEl = document.getElementById('auth-status');
        const rosterTbody = document.getElementById('roster-tbody');
        const recordsTbody = document.getElementById('records-tbody');
        
        // --- UI æ§åˆ¶å‡½å¼ ---
        // æ¨¡æ…‹æ¡†å‡½æ•¸ (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('modal').classList.add('hidden');
        };

        // QR Code æ¨¡æ…‹æ¡†å‡½æ•¸ (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.showQRCodeModal = (studentId, studentName) => {
            const modalEl = document.getElementById('qr-modal');
            const titleEl = document.getElementById('qr-modal-title');
            const containerEl = document.getElementById('qrcode-container');
            const contentDisplayEl = document.getElementById('qr-content-display');

            containerEl.innerHTML = '';
            
            titleEl.textContent = `${studentName} çš„ QR Code`;
            contentDisplayEl.textContent = `å…§å®¹ (å­¸è™Ÿ): ${studentId}`;

            // ç”¢ç”Ÿ QR Code
            new QRCode(containerEl, {
                text: studentId, 
                width: 256,
                height: 256,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            modalEl.classList.remove('hidden');
        };

        window.closeQRModal = () => {
            document.getElementById('qr-modal').classList.add('hidden');
        };

        // Tab åˆ‡æ› (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => {
                el.classList.remove('text-green-600', 'border-green-500');
                el.classList.add('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');
            });

            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            const button = document.getElementById(`tab-${tabName}`);
            button.classList.add('text-green-600', 'border-green-500');
            button.classList.remove('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');
            
            // å¦‚æœåˆ‡æ›åˆ°æƒæå™¨ï¼Œç¢ºä¿ç›¸æ©Ÿå•Ÿå‹• (é˜²æ­¢åœ¨å…¶ä»–æ¨™ç±¤æ™‚ä½”ç”¨ç›¸æ©Ÿ)
            if (tabName === 'scanner' && userId) {
                 // é‡æ–°å•Ÿå‹•ç›¸æ©Ÿ
                 startCamera();
            } else if (video.srcObject) {
                 // åœæ­¢ç›¸æ©Ÿæµï¼Œé‡‹æ”¾è³‡æº
                 video.srcObject.getTracks().forEach(track => track.stop());
            }
        };

        // --- 1. Firebase èªè­‰å’Œåˆå§‹åŒ– ---
        const initializeFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                authStatusEl.textContent = 'éŒ¯èª¤ï¼šFirebase é…ç½®éºå¤±ã€‚';
                authStatusEl.classList.replace('bg-yellow-100', 'bg-red-100');
                authStatusEl.classList.replace('text-yellow-800', 'text-red-800');
                authStatusEl.classList.remove('hidden');
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                authStatusEl.textContent = 'èº«ä»½é©—è­‰ä¸­...';
                authStatusEl.classList.remove('hidden');

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // ç‹€æ…‹æ”¹è®Šå¾Œï¼Œç¢ºä¿ userId å­˜åœ¨æ‰é–‹å§‹ Firestore æ“ä½œ
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusEl.textContent = `èªè­‰æˆåŠŸã€‚ä½¿ç”¨è€… ID: ${userId.substring(0, 8)}...`;
                        authStatusEl.classList.replace('bg-yellow-100', 'bg-green-100');
                        authStatusEl.classList.replace('text-yellow-800', 'text-green-800');
                        
                        // èªè­‰æˆåŠŸå¾Œå•Ÿå‹•æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒåŠŸèƒ½
                        startAppFeatures(); 
                    } else {
                        userId = null;
                        authStatusEl.textContent = 'æœªèªè­‰ã€‚';
                        authStatusEl.classList.replace('bg-yellow-100', 'bg-red-100');
                        authStatusEl.classList.replace('text-yellow-800', 'text-red-800');
                    }
                });

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–æˆ–èªè­‰å¤±æ•—:", error);
                authStatusEl.textContent = `éŒ¯èª¤ï¼š${error.message}`;
                authStatusEl.classList.replace('bg-yellow-100', 'bg-red-100');
                authStatusEl.classList.replace('text-yellow-800', 'text-red-800');
            }
        };

        // --- 2. å­¸ç”Ÿåå–®ç®¡ç†åŠŸèƒ½ (Firestore) ---
        const getRosterCollectionRef = () => {
            if (!db || !userId) {
                console.error("Firestore æˆ– userId å°šæœªåˆå§‹åŒ–ã€‚");
                return null;
            }
            const path = `/artifacts/${appId}/users/${userId}/roster`;
            return collection(db, path);
        };

        const renderRoster = (students) => {
            rosterTbody.innerHTML = '';
            rosterData = {}; 
            if (students.length === 0) {
                rosterTbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">åå–®ç‚ºç©ºã€‚è«‹æ–°å¢å­¸ç”Ÿã€‚</td></tr>';
                return;
            }
            
            students.forEach(student => {
                rosterData[student.studentId] = { name: student.name, studentId: student.studentId };
                
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors duration-100';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.studentId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex space-x-2 justify-end">
                        <button onclick="window.showQRCodeModal('${student.studentId}', '${student.name}')" class="text-blue-600 hover:text-blue-900 transition-colors duration-100 p-1 rounded-md bg-blue-50">ç”¢ç”Ÿ QR Code</button>
                        <button onclick="window.deleteStudent('${student.studentId}')" class="text-red-600 hover:text-red-900 transition-colors duration-100 p-1 rounded-md bg-red-50">åˆªé™¤</button>
                    </td>
                `;
                rosterTbody.appendChild(tr);
            });
        };

        const setupRosterListener = () => {
            const colRef = getRosterCollectionRef();
            if (!colRef) return;

            onSnapshot(colRef, (snapshot) => {
                const students = [];
                snapshot.forEach(doc => {
                    students.push(doc.data());
                });
                renderRoster(students);
            }, (error) => {
                console.error("ç›£è½åå–®å¤±æ•—:", error);
                showModal('éŒ¯èª¤', 'ç„¡æ³•è¼‰å…¥å­¸ç”Ÿåå–®ã€‚');
            });
        };
        
        document.getElementById('add-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('studentId').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            
            if (!studentId || !studentName) {
                showModal('éŒ¯èª¤', 'å­¸è™Ÿå’Œå§“åä¸èƒ½ç‚ºç©ºã€‚');
                return;
            }

            const rosterRef = getRosterCollectionRef();
            if (!rosterRef) return;

            const docRef = doc(rosterRef, studentId); 
            const data = { studentId, name: studentName };

            try {
                await setDoc(docRef, data);
                showModal('æˆåŠŸ', `å­¸ç”Ÿ ${studentName} (${studentId}) å·²æ–°å¢/æ›´æ–°ã€‚`);
                document.getElementById('add-student-form').reset();
            } catch (e) {
                console.error("æ–°å¢/æ›´æ–°å­¸ç”Ÿå¤±æ•—:", e);
                showModal('éŒ¯èª¤', 'æ–°å¢/æ›´æ–°å­¸ç”Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚');
            }
        });
        
        // åˆªé™¤å­¸ç”Ÿ (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.deleteStudent = async (studentId) => {
            
            const rosterRef = getRosterCollectionRef();
            if (!rosterRef) return;

            const docRef = doc(rosterRef, studentId);
            try {
                showModal('ç¢ºèªåˆªé™¤', `æ­£åœ¨åˆªé™¤å­¸è™Ÿ ${studentId} çš„å­¸ç”Ÿ...`);
                
                await deleteDoc(docRef);
                // é‡æ–°æ‰“é–‹ä¸€å€‹æˆåŠŸçš„æ¨¡æ…‹æ¡†ï¼Œè®“ç”¨æˆ¶çŸ¥é“æ“ä½œå·²å®Œæˆ
                setTimeout(() => {
                    showModal('æˆåŠŸ', `å­¸ç”Ÿ ${studentId} å·²åˆªé™¤ã€‚`);
                }, 500); 
            } catch (e) {
                console.error("åˆªé™¤å­¸ç”Ÿå¤±æ•—:", e);
                showModal('éŒ¯èª¤', 'åˆªé™¤å­¸ç”Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚');
            }
        };

        // --- 3. é»åè¨˜éŒ„åŠŸèƒ½ (Firestore) ---
        const getAttendanceCollectionRef = () => {
            if (!db || !userId) {
                console.error("Firestore æˆ– userId å°šæœªåˆå§‹åŒ–ã€‚");
                return null;
            }
            const path = `/artifacts/${appId}/users/${userId}/attendance_records`; 
            return collection(db, path);
        };

        const renderRecords = (records) => {
            recordsTbody.innerHTML = '';
            if (records.length === 0) {
                recordsTbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">å°šç„¡é»åè¨˜éŒ„ã€‚</td></tr>';
                return;
            }

            records.forEach(record => {
                const checkInDate = record.checkInTime && record.checkInTime.toDate ? new Date(record.checkInTime.toDate()).toLocaleString('zh-TW') : 'N/A';
                
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors duration-100';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.studentId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${checkInDate}</td>
                `;
                recordsTbody.appendChild(tr);
            });
        };

        const setupRecordsListener = () => {
            const colRef = getAttendanceCollectionRef();
            if (!colRef) return;
            
            onSnapshot(colRef, (snapshot) => {
                const records = [];
                snapshot.forEach(doc => {
                    records.push(doc.data());
                });
                // åœ¨å®¢æˆ¶ç«¯æ’åº (å€’åº)
                records.sort((a, b) => {
                    const timeA = a.checkInTime && a.checkInTime.toDate ? a.checkInTime.toDate().getTime() : 0;
                    const timeB = b.checkInTime && b.checkInTime.toDate ? b.checkInTime.toDate().getTime() : 0;
                    return timeB - timeA; 
                });
                renderRecords(records);
            }, (error) => {
                console.error("ç›£è½é»åè¨˜éŒ„å¤±æ•—:", error);
                showModal('éŒ¯èª¤', 'ç„¡æ³•è¼‰å…¥é»åè¨˜éŒ„ã€‚');
            });
        };

        // è¨˜éŒ„é»å (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.logAttendance = async (qrContent) => {
            const studentInfo = rosterData[qrContent];
            const scanResultEl = document.getElementById('scan-result');
            const latestAttendanceEl = document.getElementById('latest-attendance');

            if (!studentInfo) {
                const msg = `éŒ¯èª¤ï¼šå­¸è™Ÿ ${qrContent} æœªåœ¨åå–®ä¸­ã€‚`;
                scanResultEl.textContent = msg;
                scanResultEl.classList.replace('bg-gray-800', 'bg-red-600');
                latestAttendanceEl.innerHTML = `<p class="text-red-600 font-bold">${msg}</p>`;
                return false;
            }
            
            const attendanceRef = getAttendanceCollectionRef();
            if (!attendanceRef) return false;

            const attendanceRecord = {
                studentId: studentInfo.studentId,
                name: studentInfo.name,
                checkInTime: serverTimestamp() 
            };

            try {
                await addDoc(attendanceRef, attendanceRecord);
                
                const successMsg = `é»åæˆåŠŸï¼å­¸ç”Ÿï¼š${studentInfo.name} (${studentInfo.studentId})`;
                scanResultEl.textContent = successMsg;
                scanResultEl.classList.replace('bg-red-600', 'bg-gray-800');
                
                latestAttendanceEl.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <p class="text-xl font-bold text-green-700">${studentInfo.name}</p>
                    </div>
                    <p class="text-gray-600">å­¸è™Ÿ: ${studentInfo.studentId}</p>
                    <p class="text-sm text-gray-500">é»åæ™‚é–“: ${new Date().toLocaleTimeString('zh-TW')}</p>
                `;
                return true;
            } catch (e) {
                console.error("è¨˜éŒ„é»åå¤±æ•—:", e);
                showModal('éŒ¯èª¤', 'è¨˜éŒ„é»åå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°æˆ–ç¶²è·¯ã€‚');
                return false;
            }
        };

        // --- 4. è³‡æ–™åŒ¯å‡ºåŠŸèƒ½ (CSV) ---
        // åŒ¯å‡ºç‚º CSV (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.exportToCSV = async () => {
            const colRef = getAttendanceCollectionRef();
            if (!colRef) {
                showModal('éŒ¯èª¤', 'Firebase å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™ã€‚');
                return;
            }
            
            try {
                const snapshot = await getDocs(colRef);
                let records = [];
                snapshot.forEach(doc => records.push(doc.data()));
                
                if (records.length === 0) {
                    showModal('æç¤º', 'æ²’æœ‰é»åè¨˜éŒ„å¯ä»¥åŒ¯å‡ºã€‚');
                    return;
                }

                // åœ¨å®¢æˆ¶ç«¯æ’åº (å‡åº)
                records.sort((a, b) => {
                    const timeA = a.checkInTime && a.checkInTime.toDate ? a.checkInTime.toDate().getTime() : 0;
                    const timeB = b.checkInTime && b.checkInTime.toDate ? b.checkInTime.toDate().getTime() : 0;
                    return timeA - timeB; 
                });

                // æº–å‚™ CSV å…§å®¹
                let csvContent = "å­¸è™Ÿ,å§“å,é»åæ™‚é–“\n";

                records.forEach(record => {
                    const studentId = record.studentId || '';
                    const name = (record.name || '').replace(/"/g, '""'); // è™•ç†å§“åä¸­çš„å¼•è™Ÿ
                    const checkInDate = record.checkInTime && record.checkInTime.toDate ? new Date(record.checkInTime.toDate()).toLocaleString('zh-TW', {
                        year: 'numeric', month: '2-digit', day: '2-digit', 
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    }) : '';
                    
                    // ç¢ºä¿å§“åè¢«é›™å¼•è™ŸåŒ…åœï¼Œä»¥è™•ç†ä¸­æ–‡æˆ–é€—è™Ÿ
                    csvContent += `${studentId},"${name}",${checkInDate}\n`;
                });

                // å‰µå»º Blob ä¸¦ä¸‹è¼‰ (æ–°å¢ BOM ç¢ºä¿ Excel æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡)
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `é»åè¨˜éŒ„_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showModal('æˆåŠŸ', `å·²åŒ¯å‡º ${records.length} æ¢é»åè¨˜éŒ„ç‚º CSV æª”æ¡ˆã€‚`);

            } catch (e) {
                console.error("åŒ¯å‡ºå¤±æ•—:", e);
                showModal('éŒ¯èª¤', 'åŒ¯å‡ºé»åè¨˜éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚');
            }
        };


        // --- 5. QR Code æƒæå™¨é‚è¼¯ ---
        const video = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvas = canvasElement.getContext('2d');
        const highlightCanvas = document.getElementById('highlightCanvas');
        const highlightContext = highlightCanvas.getContext('2d');
        const cameraMessage = document.getElementById('camera-message');

        let lastScannedCode = null;
        let lastScanTime = 0;
        const scanCooldown = 3000; // 3 ç§’å†·å»æ™‚é–“

        const drawLine = (context, begin, end, color) => {
            context.beginPath();
            context.moveTo(begin.x, begin.y);
            context.lineTo(end.x, end.y);
            context.lineWidth = 4;
            context.strokeStyle = color;
            context.stroke();
        }

        const tick = () => {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                cameraMessage.classList.add('hidden'); 

                // è¨­ç½® canvas å°ºå¯¸èˆ‡ video ä¸€è‡´
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                highlightCanvas.height = video.videoHeight;
                highlightCanvas.width = video.videoWidth;

                // å°‡è¦–è¨Šå¹€ç¹ªè£½åˆ°éš±è—çš„ canvas ä¸Š
                // ç‚ºäº†æ­£ç¢ºæƒæï¼Œé€™è£¡ä¸éœ€è¦ scaleX(-1)ï¼Œåªéœ€è¦åœ¨ CSS è¦–è¦ºä¸Šç¿»è½‰
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                
                highlightContext.clearRect(0, 0, highlightCanvas.width, highlightCanvas.height);

                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    // ç¹ªè£½é«˜äº®æ¡†
                    drawLine(highlightContext, code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
                    drawLine(highlightContext, code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
                    drawLine(highlightContext, code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
                    drawLine(highlightContext, code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");
                    
                    document.getElementById('scan-result').textContent = `å·²æƒæï¼š${code.data}`;
                    
                    const currentTime = Date.now();
                    if (userId && (code.data !== lastScannedCode || currentTime - lastScanTime > scanCooldown)) {
                        
                        if (Object.keys(rosterData).length > 0) {
                            window.logAttendance(code.data);
                            lastScannedCode = code.data;
                            lastScanTime = currentTime;
                        } else {
                             document.getElementById('scan-result').textContent = `å·²æƒæï¼š${code.data} (è­¦å‘Šï¼šåå–®æœªè¼‰å…¥ï¼Œç„¡æ³•è¨˜éŒ„)`;
                             document.getElementById('scan-result').classList.replace('bg-gray-800', 'bg-yellow-600');
                        }
                    } else if (!userId) {
                        document.getElementById('scan-result').textContent = `å·²æƒæï¼š${code.data} (ç­‰å¾… Firebase èªè­‰...)`;
                    } else if (code.data === lastScannedCode && currentTime - lastScanTime < scanCooldown) {
                         document.getElementById('scan-result').textContent = `å·²æƒæï¼š${code.data} (å†·å»ä¸­...)`;
                    }
                } else {
                    document.getElementById('scan-result').textContent = "è«‹å°‡ QR Code ç½®æ–¼æƒææ¡†å…§";
                    document.getElementById('scan-result').classList.replace('bg-red-600', 'bg-gray-800');
                    document.getElementById('scan-result').classList.replace('bg-yellow-600', 'bg-gray-800');
                }
            }

            requestAnimationFrame(tick);
        }

        // å•Ÿå‹•ç›¸æ©Ÿ
        const startCamera = () => {
             // å¦‚æœç›¸æ©Ÿå·²ç¶“åœ¨é‹è¡Œï¼Œå…ˆåœæ­¢å®ƒ
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }

            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                cameraMessage.textContent = 'æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...';

                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment", // å„ªå…ˆä½¿ç”¨å¾Œç½®é¡é ­
                        width: { ideal: 1280 }, 
                        height: { ideal: 720 } 
                    } 
                }) 
                .then(function(stream) {
                    video.srcObject = stream;
                    video.play();
                    requestAnimationFrame(tick);
                })
                .catch(function(err) {
                    console.error("ç„¡æ³•å­˜å–ç›¸æ©Ÿè©³ç´°éŒ¯èª¤:", err);
                    let errorMessage = 'éŒ¯èª¤ï¼šç„¡æ³•å­˜å–ç›¸æ©Ÿã€‚';
                    
                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        errorMessage += ' è«‹æª¢æŸ¥ç€è¦½å™¨ï¼ˆSafari/Chromeï¼‰å’Œ Mac/iPad ç³»çµ±è¨­å®šä¸­çš„ç›¸æ©Ÿæ¬Šé™ã€‚';
                    } else if (err.name === 'NotFoundError') {
                        errorMessage += ' æœªæ‰¾åˆ°ç›¸æ©Ÿè¨­å‚™ã€‚';
                    } else if (err.name === 'NotReadableError') {
                         errorMessage += ' ç›¸æ©Ÿå¯èƒ½å·²è¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ã€‚';
                    } else {
                        errorMessage += ` æœªçŸ¥éŒ¯èª¤é¡å‹: ${err.name || 'æœªçŸ¥'}`;
                    }

                    cameraMessage.textContent = errorMessage;
                    document.getElementById('scan-result').textContent = "ç›¸æ©Ÿå­˜å–å¤±æ•—ã€‚";
                    document.getElementById('scan-result').classList.replace('bg-gray-800', 'bg-red-600');
                });
            } else {
                cameraMessage.textContent = 'éŒ¯èª¤ï¼šæ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿå­˜å–ã€‚';
                document.getElementById('scan-result').textContent = "ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿã€‚";
                document.getElementById('scan-result').classList.replace('bg-gray-800', 'bg-red-600');
            }
        };

        // --- 6. å•Ÿå‹•æ‰€æœ‰åŠŸèƒ½ ---
        const startAppFeatures = () => {
            // ç¢ºä¿ä¾è³´ Firebase èªè­‰çš„æœå‹™å·²å•Ÿå‹•
            setupRosterListener();  
            setupRecordsListener(); 
            // åªæœ‰åœ¨æƒæå™¨æ¨™ç±¤å•Ÿç”¨æ™‚æ‰å•Ÿå‹•ç›¸æ©Ÿ
            if (document.getElementById('content-scanner').classList.contains('hidden') === false) {
                 startCamera();
            }
        };

        // åˆå§‹å•Ÿå‹•
        initializeFirebase();
        // é è¨­åˆ‡æ›åˆ°æƒæå™¨ï¼Œä¸¦è§¸ç™¼ camera å•Ÿå‹•é‚è¼¯
        window.switchTab('scanner'); 

    </script>
</body>
</html>