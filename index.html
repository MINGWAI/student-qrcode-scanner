<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿ QR Code é»åç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ jsQR æƒæåº« -->
    <script src="https://cdn.jsdelivr.net/npm/jsQR@1.0.4/dist/jsQR.min.js"></script>
    <!-- è¼‰å…¥ qrcode.js ç”¢ç”Ÿ QR Code å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        body { font-family: 'Inter', sans-serif; }
        /* ç‚ºäº† QR æƒæå™¨ï¼Œç¢ºä¿ video å’Œ canvas ä½”æ»¿å®¹å™¨ */
        .scanner-container {
            position: relative;
            width: 100%;
            height: 400px; /* å›ºå®šé«˜åº¦æ–¹ä¾¿ä½ˆå±€ */
            overflow: hidden;
            background-color: #1f2937;
        }
        .scanner-container video, 
        .scanner-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* æ°´å¹³ç¿»è½‰ç›¸æ©Ÿç•«é¢ */
        }
        #highlightCanvas {
            z-index: 10;
        }
        /* æƒææ¡†å‹•ç•« */
        @keyframes scan-line {
            0% { top: 0; opacity: 1; }
            50% { top: 100%; opacity: 0.5; }
            100% { top: 0; opacity: 1; }
        }
        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 80%;
            max-width: 300px;
            max-height: 300px;
            transform: translate(-50%, -50%);
            border: 4px solid #34d399; /* ç¶ è‰²é‚Šæ¡† */
            z-index: 5;
        }
        .scan-frame::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, transparent, #34d399, transparent);
            animation: scan-line 2s infinite linear;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">ğŸ“ å­¸ç”Ÿ QR Code é»åç³»çµ±</h1>
            <p class="text-gray-500">ä½¿ç”¨æ‚¨çš„è¨­å‚™ç›¸æ©Ÿæƒæå­¸ç”Ÿçš„ QR Code ä»¥è¨˜éŒ„å‡ºå¸­ã€‚</p>
            <div id="auth-status" class="text-sm mt-2 p-2 rounded-md bg-yellow-100 text-yellow-800 hidden">
                èº«ä»½é©—è­‰ä¸­...
            </div>
            <div id="secure-context-warning" class="text-sm mt-2 p-2 rounded-md bg-red-100 text-red-800 hidden">
                è­¦å‘Šï¼šæ‚¨æœªåœ¨å®‰å…¨ç’°å¢ƒ (HTTPS) ä¸‹é‹è¡Œï¼Œç›¸æ©ŸåŠŸèƒ½å¯èƒ½è¢«ç€è¦½å™¨é˜»æ“‹ã€‚
            </div>
        </header>

        <!-- å°èˆªæ¨™ç±¤ -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button type="button" onclick="switchTab('scanner')" id="tab-scanner" class="tab-button inline-flex items-center px-4 py-2 border-b-2 font-medium text-sm focus:outline-none transition-colors duration-200 text-green-600 border-green-500">
                    é»åæƒæå™¨
                </button>
                <button type="button" onclick="switchTab('roster')" id="tab-roster" class="tab-button inline-flex items-center px-4 py-2 border-b-2 font-medium text-sm focus:outline-none transition-colors duration-200 text-gray-500 border-transparent hover:border-gray-300 hover:text-gray-700">
                    å­¸ç”Ÿåå–®ç®¡ç†
                </button>
                <button type="button" onclick="switchTab('records')" id="tab-records" class="tab-button inline-flex items-center px-4 py-2 border-b-2 font-medium text-sm focus:outline-none transition-colors duration-200 text-gray-500 border-transparent hover:border-gray-300 hover:text-gray-700">
                    é»åè¨˜éŒ„
                </button>
                <button type="button" onclick="switchTab('account')" id="tab-account" class="tab-button inline-flex items-center px-4 py-2 border-b-2 font-medium text-sm focus:outline-none transition-colors duration-200 text-gray-500 border-transparent hover:border-gray-300 hover:text-gray-700">
                    å¸³æˆ¶ç®¡ç†
                </button>
            </nav>
        </div>

        <!-- 1. é»åæƒæå™¨ (Tab) -->
        <div id="content-scanner" class="tab-content">
            <div class="lg:flex lg:space-x-8">
                <!-- æƒæå€åŸŸ -->
                <div class="lg:w-1/2 mb-6 lg:mb-0">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç›¸æ©Ÿæƒæ</h2>
                    <div id="scanner-area" class="scanner-container rounded-xl shadow-2xl relative">
                        <video id="video" playsinline autoplay></video>
                        <canvas id="canvas" class="hidden"></canvas>
                        <canvas id="highlightCanvas"></canvas>
                        <div class="scan-frame"></div>
                        <div id="camera-message" class="absolute inset-0 bg-gray-800/90 text-white flex items-center justify-center p-4 rounded-xl text-center z-20">
                            æ­£åœ¨è¼‰å…¥ç›¸æ©Ÿ...
                        </div>
                    </div>
                    <div id="scan-result" class="mt-4 p-4 bg-gray-800 rounded-xl text-white text-center text-lg shadow-inner">
                        è«‹å°‡ QR Code ç½®æ–¼æƒææ¡†å…§
                    </div>
                </div>

                <!-- é»åå³æ™‚çµæœ -->
                <div class="lg:w-1/2">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">æœ€æ–°é»å</h2>
                    <div id="latest-attendance" class="p-6 bg-white border border-green-500 rounded-xl shadow-lg space-y-4">
                        <p class="text-gray-500">ç­‰å¾…ç¬¬ä¸€æ¬¡æƒæ...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. å­¸ç”Ÿåå–®ç®¡ç† (Tab) -->
        <div id="content-roster" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">æ–°å¢æˆ–æ›´æ–°å­¸ç”Ÿåå–®</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <form id="add-student-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label for="studentId" class="block text-sm font-medium text-gray-700">å­¸è™Ÿ (ä½œç‚º QR Code å…§å®¹)</label>
                        <input type="text" id="studentId" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="e.g. S1001">
                    </div>
                    <div class="md:col-span-2">
                        <label for="studentName" class="block text-sm font-medium text-gray-700">å§“å</label>
                        <input type="text" id="studentName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="e.g. ç‹å°æ˜">
                    </div>
                    <button type="submit" class="md:col-span-1 w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-150 shadow-md">
                        æ–°å¢ / æ›´æ–°å­¸ç”Ÿ
                    </button>
                </form>
            </div>
            
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç•¶å‰å­¸ç”Ÿåå–®</h2>
            <div id="roster-list" class="bg-white rounded-xl shadow-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å­¸è™Ÿ (QR å…§å®¹)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å§“å</th>
                            <!-- å°‡æ“ä½œæ¬„æ¨™é¡Œå°é½Šå³å´ -->
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="roster-tbody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="3" class="text-center py-4 text-gray-500">æ­£åœ¨è¼‰å…¥åå–®...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 p-4 rounded-xl bg-blue-100 text-blue-800">
                <p>è«‹æ³¨æ„ï¼šå­¸è™Ÿæ¬„ä½çš„å€¼å°‡è¢«ç”¨ä½œå­¸ç”Ÿçš„ QR Code å…§å®¹ã€‚æ‚¨ç¾åœ¨å¯ä»¥ç›´æ¥é»æ“Šã€Œç”¢ç”Ÿ QR Codeã€æŒ‰éˆ•ç²å–åœ–åƒã€‚</p>
            </div>
        </div>

        <!-- 3. é»åè¨˜éŒ„ (Tab) -->
        <div id="content-records" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">æ‰€æœ‰é»åè¨˜éŒ„</h2>
                <button type="button" onclick="exportToCSV()" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-150 shadow-md flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2-8H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2z"></path></svg>
                    åŒ¯å‡ºç‚º Excel (CSV)
                </button>
            </div>
            <div id="records-list" class="bg-white rounded-xl shadow-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å­¸è™Ÿ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å§“å</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é»åæ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody id="records-tbody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="3" class="text-center py-4 text-gray-500">æ­£åœ¨è¼‰å…¥è¨˜éŒ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 4. å¸³æˆ¶ç®¡ç† (Tab) - æ–°å¢ -->
        <div id="content-account" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">å¸³æˆ¶ç®¡ç†èˆ‡å‡ç´š</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <div id="current-auth-info" class="mb-4 p-4 border rounded-lg bg-gray-50">
                    <p class="font-bold text-lg text-gray-700">ç•¶å‰èªè­‰ç‹€æ…‹ï¼š</p>
                    <p id="auth-type-display" class="text-gray-600"></p>
                    <p id="user-id-display" class="text-gray-600"></p>
                </div>
                
                <!-- *** æ–°å¢çš„ç™»å…¥å€å¡Š *** -->
                <div id="signin-section" class="bg-white p-6 rounded-xl shadow-lg mb-8 border border-gray-200">
                    <h3 class="text-xl font-bold text-gray-900 mb-3">ä½¿ç”¨æ°¸ä¹…å¸³è™Ÿç™»å…¥</h3>
                    <p class="text-gray-600 mb-4">å¦‚æœæ‚¨å·²ç¶“åœ¨å…¶ä»–è¨­å‚™ä¸Šå‰µå»ºäº†æ°¸ä¹…å¸³è™Ÿ (Email/Password)ï¼Œè«‹åœ¨æ­¤ç™»å…¥ä»¥ç¹¼æ‰¿æ‚¨çš„è³‡æ–™ã€‚</p>
                    <form id="signin-form" class="space-y-4">
                        <div>
                            <label for="signin-email" class="block text-sm font-medium text-gray-700">é›»å­éƒµä»¶</label>
                            <input type="email" id="signin-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                        <div>
                            <label for="signin-password" class="block text-sm font-medium text-gray-700">å¯†ç¢¼</label>
                            <input type="password" id="signin-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                        <button type="submit" id="signin-button" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-150 shadow-md">
                            ç™»å…¥
                        </button>
                    </form>
                </div>
                <!-- *** ç™»å…¥å€å¡ŠçµæŸ *** -->

                <!-- å¸³è™Ÿå‡ç´šå€å¡Š -->
                <div id="upgrade-section" class="pt-6 border-t border-yellow-200">
                    <h3 class="text-xl font-bold text-gray-900 mb-3">å‡ç´šåˆ°æ°¸ä¹…å¸³è™Ÿ</h3>
                    <p class="text-gray-600 mb-4">
                        å°‡æ‚¨ç•¶å‰çš„åŒ¿åå¸³è™Ÿé€£çµåˆ°é›»å­éƒµä»¶ï¼Œä»¥ç¢ºä¿æ‚¨çš„é»åè³‡æ–™æ°¸ä¹…ä¿å­˜ï¼Œä¸¦èƒ½åœ¨ä»»ä½•è£ç½®ä¸Šç™»å…¥ã€‚
                        <span class="font-semibold text-red-600">ï¼ˆè«‹ç¢ºä¿å·²å•Ÿç”¨ Firebase Email/Password ç™»å…¥ï¼‰</span>
                    </p>
                    <form id="upgrade-account-form" class="space-y-4">
                        <div>
                            <label for="upgrade-email" class="block text-sm font-medium text-gray-700">é›»å­éƒµä»¶</label>
                            <input type="email" id="upgrade-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                        <div>
                            <label for="upgrade-password" class="block text-sm font-medium text-gray-700">å¯†ç¢¼ (è‡³å°‘ 6 ä½å…ƒ)</label>
                            <input type="password" id="upgrade-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                        <button type="submit" id="upgrade-button" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-150 shadow-md">
                            å‡ç´šå¸³è™Ÿä¸¦ä¿ç•™è³‡æ–™
                        </button>
                    </form>
                </div>

                <!-- ç™»å‡ºå€å¡Š -->
                <div class="mt-8 pt-6 border-t border-gray-200" id="signout-section">
                    <button onclick="window.handleSignOut()" id="signout-button" class="w-full bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition duration-150 shadow-md">
                        ç™»å‡º
                    </button>
                    <p class="text-sm text-gray-500 mt-2 text-center">ç™»å‡ºå¾Œï¼Œéœ€è¦é‡æ–°æ•´ç†é é¢ä¸¦å†æ¬¡ç™»å…¥ã€‚</p>
                </div>

            </div>
        </div>
        <!-- å¸³æˆ¶ç®¡ç† (Tab) - çµæŸ -->

    </div>

    <!-- éŒ¯èª¤/æç¤ºè¨Šæ¯æ¨¡æ…‹æ¡† -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl space-y-4">
            <h3 id="modal-title" class="text-xl font-bold text-gray-900">æç¤º</h3>
            <p id="modal-message" class="text-gray-700"></p>
            <div class="flex justify-end">
                <button onclick="closeModal()" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-150">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- QR Code é¡¯ç¤ºæ¨¡æ…‹æ¡† -->
    <div id="qr-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-8 w-full max-w-md shadow-2xl space-y-6">
            <h3 id="qr-modal-title" class="text-2xl font-bold text-gray-900 text-center"></h3>
            <p class="text-center text-gray-600">è«‹å°‡æ­¤ QR Code åœ–åƒï¼ˆå³éµæˆ–é•·æŒ‰ï¼‰å„²å­˜æˆ–åˆ—å°çµ¦å­¸ç”Ÿä½¿ç”¨ã€‚</p>
            <div id="qrcode-container" class="flex justify-center p-4 border border-gray-200 rounded-lg bg-gray-50">
                <!-- QR Code å°‡è¢«ç¹ªè£½åˆ°æ­¤è™• -->
            </div>
            <p id="qr-content-display" class="text-center font-mono text-sm text-gray-800 break-all"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeQRModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 transition duration-150">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- è¼‰å…¥ Firebase SDK å’Œæ‡‰ç”¨ç¨‹å¼é‚è¼¯ -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            signOut,
            EmailAuthProvider,
            linkWithCredential,
            signInWithEmailAndPassword // <-- æ–°å¢çš„ç™»å…¥æ–¹æ³•
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, onSnapshot, collection, serverTimestamp, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 1. æ‚¨çš„ Firebase é…ç½® (è«‹åœ¨æ­¤è™•å¡«å…¥) ---
        // !!! VERY IMPORTANT !!!
        const MY_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAFM-0Hi6J1dtWltpCsGGObBxWtO2ZRRpY",
            authDomain: "dsevictory-attendance-system.firebaseapp.com",
            projectId: "dsevictory-attendance-system",
            storageBucket: "dsevictory-attendance-system.firebasestorage.app",
            messagingSenderId: "796565425082",
            appId: "1:796565425082:web:08babee5be08c0ffdc2b83"
        };
        // ------------------------------------------

        // --- è®Šæ•¸åˆå§‹åŒ– ---
        setLogLevel('debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let firebaseConfig = MY_FIREBASE_CONFIG;
        if (typeof __firebase_config !== 'undefined' && __firebase_config !== '') {
             try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.warn("è§£æ __firebase_config å¤±æ•—ï¼Œä½¿ç”¨ MY_FIREBASE_CONFIG ä½œç‚ºå‚™ç”¨ã€‚");
            }
        }
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' && __initial_auth_token !== '' ? __initial_auth_token : null;
        
        let app, db, auth, userId;
        let authMethodType = 'Unknown';
        let rosterData = {}; // ç”¨æ–¼å¿«å–åå–®ï¼ŒåŠ é€Ÿé»å

        // UI å…ƒç´ 
        const authStatusEl = document.getElementById('auth-status');
        const secureContextWarningEl = document.getElementById('secure-context-warning'); 
        const rosterTbody = document.getElementById('roster-tbody');
        const recordsTbody = document.getElementById('records-tbody');
        const upgradeSectionEl = document.getElementById('upgrade-section');
        const signinSectionEl = document.getElementById('signin-section');
        const signoutSectionEl = document.getElementById('signout-section'); // æ–°å¢

        // --- UI æ§åˆ¶å‡½å¼ ---
        // æ¨¡æ…‹æ¡†å‡½æ•¸ (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('modal').classList.add('hidden');
        };

        // QR Code æ¨¡æ…‹æ¡†å‡½æ•¸ (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.showQRCodeModal = (studentId, studentName) => {
            const modalEl = document.getElementById('qr-modal');
            const titleEl = document.getElementById('qr-modal-title');
            const containerEl = document.getElementById('qrcode-container');
            const contentDisplayEl = document.getElementById('qr-content-display');

            containerEl.innerHTML = '';
            
            titleEl.textContent = `${studentName} çš„ QR Code`;
            contentDisplayEl.textContent = `å…§å®¹ (å­¸è™Ÿ): ${studentId}`;

            // ç”¢ç”Ÿ QR Code
            new QRCode(containerEl, {
                text: studentId, 
                width: 256,
                height: 256,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            modalEl.classList.remove('hidden');
        };

        window.closeQRModal = () => {
            document.getElementById('qr-modal').classList.add('hidden');
        };

        // Tab åˆ‡æ› (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => {
                el.classList.remove('text-green-600', 'border-green-500');
                el.classList.add('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');
            });

            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            const button = document.getElementById(`tab-${tabName}`);
            button.classList.add('text-green-600', 'border-green-500');
            button.classList.remove('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');
            
            // å¦‚æœåˆ‡æ›åˆ°æƒæå™¨ï¼Œç¢ºä¿ç›¸æ©Ÿå•Ÿå‹• (é˜²æ­¢åœ¨å…¶ä»–æ¨™ç±¤æ™‚ä½”ç”¨ç›¸æ©Ÿ)
            const video = document.getElementById('video');
            if (tabName === 'scanner' && userId) {
                 // é‡æ–°å•Ÿå‹•ç›¸æ©Ÿ
                 startCamera();
            } else if (video.srcObject) {
                 // åœæ­¢ç›¸æ©Ÿæµï¼Œé‡‹æ”¾è³‡æº
                 video.srcObject.getTracks().forEach(track => track.stop());
            }
            
            // å¦‚æœåˆ‡æ›åˆ°å¸³æˆ¶ç®¡ç†ï¼Œæ›´æ–°è³‡è¨Š
            if (tabName === 'account' && auth.currentUser) {
                updateAccountInfo(auth.currentUser);
            }
        };

        // --- 2. Firebase èªè­‰å’Œåˆå§‹åŒ– ---
        const initializeFirebase = async () => {
            if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                authStatusEl.textContent = 'éŒ¯èª¤ï¼šFirebase é…ç½®éºå¤±ã€‚è«‹åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ‚¨çš„é…ç½®ã€‚';
                authStatusEl.classList.replace('bg-yellow-100', 'bg-red-100');
                authStatusEl.classList.replace('text-yellow-800', 'text-red-800');
                authStatusEl.classList.remove('hidden');
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                authStatusEl.textContent = 'èº«ä»½é©—è­‰ä¸­...';
                authStatusEl.classList.remove('hidden');

                
                try {
                    // åŸ·è¡Œèº«ä»½é©—è­‰ï¼šå„ªå…ˆä½¿ç”¨ Canvas æä¾›çš„è‡ªå®šç¾©ä»¤ç‰Œ
                    if (initialAuthToken) {
                        authMethodType = 'è‡ªå®šç¾©ä»¤ç‰Œ (Custom Token)';
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        // å¤–éƒ¨ç’°å¢ƒå›é€€åˆ°åŒ¿åç™»éŒ„
                        authMethodType = 'åŒ¿åç™»éŒ„ (Anonymous)';
                        await signInAnonymously(auth);
                    }
                } catch (authError) {
                    console.error("èº«ä»½é©—è­‰å¤±æ•—:", authError);
                    if (authError.code === 'auth/admin-restricted-operation') {
                        authStatusEl.textContent = `èº«ä»½é©—è­‰å¤±æ•—ï¼š(${authError.code})ã€‚
                            è«‹åœ¨ Firebase Console > Authentication > Sign-in method ä¸­ï¼Œç¢ºèªå·²å•Ÿç”¨ã€ŒåŒ¿åã€ç™»éŒ„ã€‚`;
                    } else {
                        authStatusEl.textContent = `èº«ä»½é©—è­‰å¤±æ•—ï¼š${authError.message}`;
                    }
                    authStatusEl.classList.replace('bg-yellow-100', 'bg-red-100');
                    authStatusEl.classList.replace('text-yellow-800', 'text-red-800');
                    return; 
                }
                
                // ç‹€æ…‹æ”¹è®Šå¾Œï¼Œç¢ºä¿ userId å­˜åœ¨æ‰é–‹å§‹ Firestore æ“ä½œ
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        
                        // åˆ¤æ–·æ˜¯å¦ç‚ºåŒ¿åå¸³è™Ÿï¼Œä¸¦æ›´æ–° authMethodType
                        const isAnonymous = user.isAnonymous;
                        if (isAnonymous && authMethodType !== 'è‡ªå®šç¾©ä»¤ç‰Œ (Custom Token)') {
                             authMethodType = 'åŒ¿åç™»éŒ„ (Anonymous)';
                        } else if (!isAnonymous) {
                             // æª¢æŸ¥ Email/Password ç™»å…¥é¡å‹
                             const emailProvider = user.providerData.find(p => p.providerId === 'password');
                             if (emailProvider) {
                                 authMethodType = 'é›»å­éƒµä»¶/å¯†ç¢¼ (Email/Password)';
                             } else if (authMethodType !== 'è‡ªå®šç¾©ä»¤ç‰Œ (Custom Token)') {
                                 authMethodType = 'æ°¸ä¹…å¸³è™Ÿ (Unknown)';
                             }
                        }

                        authStatusEl.textContent = `èªè­‰æˆåŠŸ (${authMethodType})ã€‚ä½¿ç”¨è€… ID: ${userId.substring(0, 8)}... (å®Œæ•´ ID: ${userId})`;
                        authStatusEl.classList.replace('bg-yellow-100', 'bg-green-100');
                        authStatusEl.classList.replace('text-yellow-800', 'text-green-800');
                        
                        // æ›´æ–°å¸³æˆ¶ç®¡ç†é é¢è³‡è¨Š
                        updateAccountInfo(user);
                        
                        // èªè­‰æˆåŠŸå¾Œå•Ÿå‹•æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒåŠŸèƒ½
                        startAppFeatures(); 
                    } else {
                        userId = null;
                        authMethodType = 'æœªèªè­‰';
                        authStatusEl.textContent = 'æœªèªè­‰ã€‚';
                        authStatusEl.classList.replace('bg-yellow-100', 'bg-red-100');
                        authStatusEl.classList.replace('text-yellow-800', 'text-red-800');
                        updateAccountInfo(null);
                    }
                });

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                authStatusEl.textContent = `éŒ¯èª¤ï¼š${error.message}`;
                authStatusEl.classList.replace('bg-yellow-100', 'bg-red-100');
                authStatusEl.classList.replace('text-yellow-800', 'text-red-800');
            }
        };

        // --- 3. å¸³è™Ÿç®¡ç†åŠŸèƒ½ ---

        const updateAccountInfo = (user) => {
            const authTypeDisplayEl = document.getElementById('auth-type-display');
            const userIdDisplayEl = document.getElementById('user-id-display');
            
            if (user) {
                authTypeDisplayEl.textContent = `é¡å‹: ${authMethodType}`;
                userIdDisplayEl.textContent = `UID: ${user.uid}`;
                
                // é‚è¼¯æ§åˆ¶ï¼šå·²ç™»å…¥ (ç„¡è«–åŒ¿åæˆ–æ°¸ä¹…)
                signinSectionEl.classList.add('hidden');
                signoutSectionEl.classList.remove('hidden');

                // åªæœ‰åœ¨åŒ¿åç™»éŒ„ä¸”é Canvas ä»¤ç‰Œæ™‚ï¼Œæ‰é¡¯ç¤ºå‡ç´šå€å¡Š
                if (user.isAnonymous && authMethodType === 'åŒ¿åç™»éŒ„ (Anonymous)') {
                    upgradeSectionEl.classList.remove('hidden');
                } else {
                    upgradeSectionEl.classList.add('hidden');
                }
            } else {
                // é‚è¼¯æ§åˆ¶ï¼šæœªç™»å…¥ (Logged Out)
                authTypeDisplayEl.textContent = `é¡å‹: æœªç™»å…¥`;
                userIdDisplayEl.textContent = `UID: N/A`;
                upgradeSectionEl.classList.add('hidden');
                signoutSectionEl.classList.add('hidden');
                
                // é¡¯ç¤ºç™»å…¥å€å¡Š
                signinSectionEl.classList.remove('hidden');
            }
        };
        
        // è™•ç†å¸³è™Ÿå‡ç´š
        document.getElementById('upgrade-account-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('upgrade-email').value.trim();
            const password = document.getElementById('upgrade-password').value.trim();
            const currentUser = auth.currentUser;
            
            if (!currentUser || !currentUser.isAnonymous) {
                showModal('éŒ¯èª¤', 'æ‚¨ç•¶å‰ä¸æ˜¯åŒ¿åå¸³è™Ÿï¼Œç„¡éœ€å‡ç´šã€‚');
                return;
            }

            if (password.length < 6) {
                showModal('éŒ¯èª¤', 'å¯†ç¢¼é•·åº¦å¿…é ˆè‡³å°‘ç‚º 6 å€‹å­—ç¬¦ã€‚');
                return;
            }

            // å‰µå»º Email/Password èªè­‰æ†‘è­‰
            const credential = EmailAuthProvider.credential(email, password);

            try {
                // å°‡åŒ¿åå¸³è™Ÿé€£çµåˆ°æ–°çš„èªè­‰æ†‘è­‰ï¼Œä»¥å¯¦ç¾å‡ç´šä¸¦ä¿ç•™è³‡æ–™
                await linkWithCredential(currentUser, credential);
                
                showModal('å‡ç´šæˆåŠŸ', 'æ‚¨çš„å¸³è™Ÿå·²æˆåŠŸå‡ç´šç‚ºæ°¸ä¹…çš„é›»å­éƒµä»¶/å¯†ç¢¼å¸³è™Ÿï¼Œæ‰€æœ‰è³‡æ–™å·²ä¿ç•™ï¼è«‹å‹¿å¿˜è¨˜æ‚¨çš„ç™»å…¥è³‡è¨Šã€‚');
                document.getElementById('upgrade-account-form').reset();
                updateAccountInfo(auth.currentUser); // æ›´æ–° UI
                
            } catch (error) {
                console.error("å¸³è™Ÿå‡ç´šå¤±æ•—:", error);
                let errorMessage = 'å‡ç´šå¤±æ•—ã€‚è«‹ç¢ºèªï¼š';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage += ' æ­¤é›»å­éƒµä»¶å·²è¢«å…¶ä»–å¸³è™Ÿä½¿ç”¨ã€‚';
                } else if (error.code === 'auth/weak-password') {
                     errorMessage += ' å¯†ç¢¼å¼·åº¦ä¸è¶³ã€‚';
                } else {
                    errorMessage += ` éŒ¯èª¤ä»£ç¢¼: ${error.code}ã€‚æ‚¨éœ€è¦åœ¨ Firebase Console ä¸­å•Ÿç”¨ Email/Password ç™»å…¥ã€‚`;
                }
                showModal('å‡ç´šéŒ¯èª¤', errorMessage);
            }
        });

        // è™•ç†æ°¸ä¹…å¸³è™Ÿç™»å…¥ (æ–°åŠŸèƒ½)
        document.getElementById('signin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signin-email').value.trim();
            const password = document.getElementById('signin-password').value.trim();
            
            showModal('ç™»å…¥ä¸­', 'æ­£åœ¨å˜—è©¦ä½¿ç”¨é›»å­éƒµä»¶/å¯†ç¢¼ç™»å…¥...');

            try {
                // åŸ·è¡Œé›»å­éƒµä»¶å¯†ç¢¼ç™»å…¥
                await signInWithEmailAndPassword(auth, email, password);
                
                // ç™»å…¥æˆåŠŸå¾Œ onAuthStateChanged æœƒè‡ªå‹•æ›´æ–° UI
                closeModal(); // é—œé–‰ã€Œç™»å…¥ä¸­ã€çš„æ¨¡æ…‹æ¡†
                showModal('ç™»å…¥æˆåŠŸ', 'æ‚¨å·²æˆåŠŸç™»å…¥æ°¸ä¹…å¸³è™Ÿï¼Œæ­£åœ¨è¼‰å…¥æ‚¨çš„è³‡æ–™ï¼');
                document.getElementById('signin-form').reset();
                
            } catch (error) {
                console.error("ç™»å…¥å¤±æ•—:", error);
                let errorMessage = 'ç™»å…¥å¤±æ•—ã€‚';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage += ' é›»å­éƒµä»¶æˆ–å¯†ç¢¼éŒ¯èª¤ã€‚';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage += ' é›»å­éƒµä»¶æ ¼å¼ç„¡æ•ˆã€‚';
                } else {
                    errorMessage += ` éŒ¯èª¤ä»£ç¢¼: ${error.code}ã€‚è«‹æª¢æŸ¥æ§åˆ¶å°ã€‚`;
                }
                showModal('ç™»å…¥éŒ¯èª¤', errorMessage);
            }
        });

        // è™•ç†ç™»å‡º
        window.handleSignOut = async () => {
            try {
                await signOut(auth);
                // ç™»å‡ºå¾Œ onAuthStateChanged æœƒå°‡ç”¨æˆ¶è¨­ç‚º nullï¼Œä¸¦è§¸ç™¼é‡æ–°åŒ¿åç™»å…¥
                showModal('ç™»å‡ºæˆåŠŸ', 'æ‚¨å·²ç™»å‡ºã€‚é é¢å°‡é‡æ–°å˜—è©¦åŒ¿åç™»å…¥ã€‚');
            } catch (error) {
                console.error("ç™»å‡ºå¤±æ•—:", error);
                showModal('ç™»å‡ºéŒ¯èª¤', `ç™»å‡ºå¤±æ•—ï¼š${error.message}`);
            }
        };
        
        // --- 4. å­¸ç”Ÿåå–®ç®¡ç†åŠŸèƒ½ (Firestore) ---
        const getRosterCollectionRef = () => {
            if (!db || !userId) {
                console.error("Firestore æˆ– userId å°šæœªåˆå§‹åŒ–ã€‚");
                return null;
            }
            // ç§æœ‰è·¯å¾‘: /artifacts/{appId}/users/{userId}/roster
            const path = `/artifacts/${appId}/users/${userId}/roster`;
            return collection(db, path);
        };

        const renderRoster = (students) => {
            rosterTbody.innerHTML = '';
            rosterData = {}; 
            if (students.length === 0) {
                rosterTbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">åå–®ç‚ºç©ºã€‚è«‹æ–°å¢å­¸ç”Ÿã€‚</td></tr>';
                return;
            }
            
            students.forEach(student => {
                rosterData[student.studentId] = { name: student.name, studentId: student.studentId };
                
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors duration-100';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.studentId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex space-x-2 justify-end">
                        <button onclick="window.showQRCodeModal('${student.studentId}', '${student.name}')" class="text-blue-600 hover:text-blue-900 transition-colors duration-100 p-1 rounded-md bg-blue-50">ç”¢ç”Ÿ QR Code</button>
                        <button onclick="window.deleteStudent('${student.studentId}')" class="text-red-600 hover:text-red-900 transition-colors duration-100 p-1 rounded-md bg-red-50">åˆªé™¤</button>
                    </td>
                `;
                rosterTbody.appendChild(tr);
            });
        };

        const setupRosterListener = () => {
            const colRef = getRosterCollectionRef();
            if (!colRef) return;

            onSnapshot(colRef, (snapshot) => {
                const students = [];
                snapshot.forEach(doc => {
                    // ç¢ºä¿æˆ‘å€‘åªè™•ç†åŒ…å« studentId å’Œ name çš„æ–‡æª”
                    const data = doc.data();
                    if (data.studentId) {
                         students.push(data);
                    }
                });
                renderRoster(students);
            }, (error) => {
                console.error("ç›£è½åå–®å¤±æ•—:", error);
                // åªæœ‰åœ¨åˆå§‹åŒ–æ™‚å‡ºéŒ¯æ‰é¡¯ç¤ºæ¨¡æ…‹æ¡†
                if (rosterTbody.textContent.includes('æ­£åœ¨è¼‰å…¥åå–®')) {
                    showModal('éŒ¯èª¤', 'ç„¡æ³•è¼‰å…¥å­¸ç”Ÿåå–®ã€‚');
                }
            });
        };
        
        document.getElementById('add-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('studentId').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            
            if (!studentId || !studentName) {
                showModal('éŒ¯èª¤', 'å­¸è™Ÿå’Œå§“åä¸èƒ½ç‚ºç©ºã€‚');
                return;
            }

            const rosterRef = getRosterCollectionRef();
            if (!rosterRef) return;

            // ä½¿ç”¨å­¸è™Ÿä½œç‚ºæ–‡ä»¶ IDï¼Œä»¥ä¾¿æ–¼æŸ¥æ‰¾å’Œæ›´æ–°
            const docRef = doc(rosterRef, studentId); 
            const data = { studentId, name: studentName };

            try {
                await setDoc(docRef, data);
                showModal('æˆåŠŸ', `å­¸ç”Ÿ ${studentName} (${studentId}) å·²æ–°å¢/æ›´æ–°ã€‚`);
                document.getElementById('add-student-form').reset();
            } catch (e) {
                console.error("æ–°å¢/æ›´æ–°å­¸ç”Ÿå¤±æ•—:", e);
                showModal('éŒ¯èª¤', 'æ–°å¢/æ›´æ–°å­¸ç”Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚');
            }
        });
        
        // åˆªé™¤å­¸ç”Ÿ (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.deleteStudent = async (studentId) => {
            
            const rosterRef = getRosterCollectionRef();
            if (!rosterRef) return;

            const docRef = doc(rosterRef, studentId);
            try {
                // ä½¿ç”¨éé˜»å¡å¼çš„ UI æç¤º
                showModal('è™•ç†ä¸­', `æ­£åœ¨åˆªé™¤å­¸è™Ÿ ${studentId} çš„å­¸ç”Ÿ...`);
                
                await deleteDoc(docRef);
                // é‡æ–°æ‰“é–‹ä¸€å€‹æˆåŠŸçš„æ¨¡æ…‹æ¡†ï¼Œè®“ç”¨æˆ¶çŸ¥é“æ“ä½œå·²å®Œæˆ
                setTimeout(() => {
                    showModal('æˆåŠŸ', `å­¸ç”Ÿ ${studentId} å·²åˆªé™¤ã€‚`);
                }, 500); 
            } catch (e) {
                console.error("åˆªé™¤å­¸ç”Ÿå¤±æ•—:", e);
                showModal('éŒ¯èª¤', 'åˆªé™¤å­¸ç”Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚');
            }
        };

        // --- 5. é»åè¨˜éŒ„åŠŸèƒ½ (Firestore) ---
        const getAttendanceCollectionRef = () => {
            if (!db || !userId) {
                console.error("Firestore æˆ– userId å°šæœªåˆå§‹åŒ–ã€‚");
                return null;
            }
            // ç§æœ‰è·¯å¾‘: /artifacts/{appId}/users/{userId}/attendance_records
            const path = `/artifacts/${appId}/users/${userId}/attendance_records`; 
            return collection(db, path);
        };

        const renderRecords = (records) => {
            recordsTbody.innerHTML = '';
            if (records.length === 0) {
                recordsTbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">å°šç„¡é»åè¨˜éŒ„ã€‚</td></tr>';
                return;
            }

            records.forEach(record => {
                // å°‡ Firestore Timestamp è½‰æ›ç‚º Date ç‰©ä»¶
                const checkInDate = record.checkInTime && record.checkInTime.toDate ? new Date(record.checkInTime.toDate()).toLocaleString('zh-TW') : 'N/A';
                
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors duration-100';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.studentId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${checkInDate}</td>
                `;
                recordsTbody.appendChild(tr);
            });
        };

        const setupRecordsListener = () => {
            const colRef = getAttendanceCollectionRef();
            if (!colRef) return;
            
            onSnapshot(colRef, (snapshot) => {
                const records = [];
                snapshot.forEach(doc => {
                    records.push(doc.data());
                });
                // åœ¨å®¢æˆ¶ç«¯æ’åº (å€’åºï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
                records.sort((a, b) => {
                    const timeA = a.checkInTime && a.checkInTime.toDate ? a.checkInTime.toDate().getTime() : 0;
                    const timeB = b.checkInTime && b.checkInTime.toDate ? b.checkInTime.toDate().getTime() : 0;
                    return timeB - timeA; 
                });
                renderRecords(records);
            }, (error) => {
                console.error("ç›£è½é»åè¨˜éŒ„å¤±æ•—:", error);
                // åªæœ‰åœ¨åˆå§‹åŒ–æ™‚å‡ºéŒ¯æ‰é¡¯ç¤ºæ¨¡æ…‹æ¡†
                if (recordsTbody.textContent.includes('æ­£åœ¨è¼‰å…¥è¨˜éŒ„')) {
                    showModal('éŒ¯èª¤', 'ç„¡æ³•è¼‰å…¥é»åè¨˜éŒ„ã€‚');
                }
            });
        };

        // è¨˜éŒ„é»å (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.logAttendance = async (qrContent) => {
            const studentInfo = rosterData[qrContent];
            const scanResultEl = document.getElementById('scan-result');
            const latestAttendanceEl = document.getElementById('latest-attendance');

            if (!studentInfo) {
                const msg = `éŒ¯èª¤ï¼šå­¸è™Ÿ ${qrContent} æœªåœ¨åå–®ä¸­ã€‚`;
                scanResultEl.textContent = msg;
                scanResultEl.classList.replace('bg-gray-800', 'bg-red-600');
                latestAttendanceEl.innerHTML = `<p class="text-red-600 font-bold">${msg}</p>`;
                return false;
            }
            
            const attendanceRef = getAttendanceCollectionRef();
            if (!attendanceRef) return false;

            const attendanceRecord = {
                studentId: studentInfo.studentId,
                name: studentInfo.name,
                checkInTime: serverTimestamp() 
            };

            try {
                await addDoc(attendanceRef, attendanceRecord);
                
                const successMsg = `é»åæˆåŠŸï¼å­¸ç”Ÿï¼š${studentInfo.name} (${studentInfo.studentId})`;
                scanResultEl.textContent = successMsg;
                scanResultEl.classList.replace('bg-red-600', 'bg-gray-800');
                
                latestAttendanceEl.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <p class="text-xl font-bold text-green-700">${studentInfo.name}</p>
                    </div>
                    <p class="text-gray-600">å­¸è™Ÿ: ${studentInfo.studentId}</p>
                    <p class="text-sm text-gray-500">é»åæ™‚é–“: ${new Date().toLocaleTimeString('zh-TW')}</p>
                `;
                return true;
            } catch (e) {
                console.error("è¨˜éŒ„é»åå¤±æ•—:", e);
                showModal('éŒ¯èª¤', 'è¨˜éŒ„é»åå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°æˆ–ç¶²è·¯ã€‚');
                return false;
            }
        };

        // --- 6. è³‡æ–™åŒ¯å‡ºåŠŸèƒ½ (CSV) ---
        // åŒ¯å‡ºç‚º CSV (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.exportToCSV = async () => {
            const colRef = getAttendanceCollectionRef();
            if (!colRef) {
                showModal('éŒ¯èª¤', 'Firebase å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™ã€‚');
                return;
            }
            
            try {
                const snapshot = await getDocs(colRef);
                let records = [];
                snapshot.forEach(doc => records.push(doc.data()));
                
                if (records.length === 0) {
                    showModal('æç¤º', 'æ²’æœ‰é»åè¨˜éŒ„å¯ä»¥åŒ¯å‡ºã€‚');
                    return;
                }

                // åœ¨å®¢æˆ¶ç«¯æ’åº (å‡åº)
                records.sort((a, b) => {
                    const timeA = a.checkInTime && a.checkInTime.toDate ? a.checkInTime.toDate().getTime() : 0;
                    const timeB = b.checkInTime && b.checkInTime.toDate ? b.checkInTime.toDate().getTime() : 0;
                    return timeA - timeB; 
                });

                // æº–å‚™ CSV å…§å®¹
                let csvContent = "å­¸è™Ÿ,å§“å,é»åæ™‚é–“\n";

                records.forEach(record => {
                    const studentId = record.studentId || '';
                    const name = (record.name || '').replace(/"/g, '""'); // è™•ç†å§“åä¸­çš„å¼•è™Ÿ
                    const checkInDate = record.checkInTime && record.checkInTime.toDate ? new Date(record.checkInTime.toDate()).toLocaleString('zh-TW', {
                        year: 'numeric', month: '2-digit', day: '2-digit', 
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    }) : '';
                    
                    // ç¢ºä¿å§“åè¢«é›™å¼•è™ŸåŒ…åœï¼Œä»¥è™•ç†ä¸­æ–‡æˆ–é€—è™Ÿ
                    csvContent += `${studentId},"${name}",${checkInDate}\n`;
                });

                // å‰µå»º Blob ä¸¦ä¸‹è¼‰ (æ–°å¢ BOM ç¢ºä¿ Excel æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡)
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `é»åè¨˜éŒ„_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showModal('æˆåŠŸ', `å·²åŒ¯å‡º ${records.length} æ¢é»åè¨˜éŒ„ç‚º CSV æª”æ¡ˆã€‚`);

            } catch (e) {
                console.error("åŒ¯å‡ºå¤±æ•—:", e);
                showModal('éŒ¯èª¤', 'åŒ¯å‡ºé»åè¨˜éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚');
            }
        };


        // --- 7. QR Code æƒæå™¨é‚è¼¯ ---
        const video = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvas = canvasElement.getContext('2d');
        const highlightCanvas = document.getElementById('highlightCanvas');
        const highlightContext = highlightCanvas.getContext('2d');
        const cameraMessage = document.getElementById('camera-message');

        let lastScannedCode = null;
        let lastScanTime = 0;
        const scanCooldown = 3000; // 3 ç§’å†·å»æ™‚é–“

        const drawLine = (context, begin, end, color) => {
            context.beginPath();
            context.moveTo(begin.x, begin.y);
            context.lineTo(end.x, end.y);
            context.lineWidth = 4;
            context.strokeStyle = color;
            context.stroke();
        }

        const tick = () => {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                cameraMessage.classList.add('hidden'); 

                // è¨­ç½® canvas å°ºå¯¸èˆ‡ video ä¸€è‡´
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                highlightCanvas.height = video.videoHeight;
                highlightCanvas.width = video.videoWidth;

                // å°‡è¦–è¨Šå¹€ç¹ªè£½åˆ°éš±è—çš„ canvas ä¸Š
                // ç”±æ–¼ CSS ç¿»è½‰äº† videoï¼Œç¹ªè£½æ™‚ä¹Ÿéœ€è¦è€ƒæ…®ç¿»è½‰ä¾†æ­£ç¢ºè§£æ QR ç¢¼ä½ç½®
                canvas.save();
                canvas.scale(-1, 1);
                canvas.drawImage(video, -canvasElement.width, 0, canvasElement.width, canvasElement.height);
                canvas.restore();

                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                
                highlightContext.clearRect(0, 0, highlightCanvas.width, highlightCanvas.height);

                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    // ç¹ªè£½é«˜äº®æ¡†
                    drawLine(highlightContext, code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
                    drawLine(highlightContext, code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
                    drawLine(highlightContext, code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
                    drawLine(highlightContext, code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");
                    
                    document.getElementById('scan-result').textContent = `å·²æƒæï¼š${code.data}`;
                    
                    const currentTime = Date.now();
                    if (userId && (code.data !== lastScannedCode || currentTime - lastScanTime > scanCooldown)) {
                        
                        if (Object.keys(rosterData).length > 0) {
                            window.logAttendance(code.data);
                            lastScannedCode = code.data;
                            lastScanTime = currentTime;
                        } else {
                             document.getElementById('scan-result').textContent = `å·²æƒæï¼š${code.data} (è­¦å‘Šï¼šåå–®æœªè¼‰å…¥ï¼Œç„¡æ³•è¨˜éŒ„)`;
                             document.getElementById('scan-result').classList.replace('bg-gray-800', 'bg-yellow-600');
                        }
                    } else if (!userId) {
                        document.getElementById('scan-result').textContent = `å·²æƒæï¼š${code.data} (ç­‰å¾… Firebase èªè­‰...)`;
                    } else if (code.data === lastScannedCode && currentTime - lastScanTime < scanCooldown) {
                         document.getElementById('scan-result').textContent = `å·²æƒæï¼š${code.data} (å†·å»ä¸­...)`;
                    }
                } else {
                    document.getElementById('scan-result').textContent = "è«‹å°‡ QR Code ç½®æ–¼æƒææ¡†å…§";
                    document.getElementById('scan-result').classList.replace('bg-red-600', 'bg-gray-800');
                    document.getElementById('scan-result').classList.replace('bg-yellow-600', 'bg-gray-800');
                }
            }

            requestAnimationFrame(tick);
        }

        // å•Ÿå‹•ç›¸æ©Ÿ
        const startCamera = () => {
             // å¦‚æœç›¸æ©Ÿå·²ç¶“åœ¨é‹è¡Œï¼Œå…ˆåœæ­¢å®ƒ
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            
            // æª¢æŸ¥å®‰å…¨ç’°å¢ƒ (HTTPS)
            if (!window.isSecureContext) {
                 secureContextWarningEl.classList.remove('hidden');
                 cameraMessage.textContent = 'åš´é‡éŒ¯èª¤ï¼šå¿…é ˆé€é HTTPS å­˜å–æ‰èƒ½å•Ÿå‹•ç›¸æ©Ÿ (iOS/Safari é™åˆ¶)ã€‚';
                 document.getElementById('scan-result').textContent = "ç›¸æ©Ÿå­˜å–å¤±æ•— (HTTPS éŒ¯èª¤)ã€‚";
                 return; 
            } else {
                 secureContextWarningEl.classList.add('hidden');
            }


            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                cameraMessage.textContent = 'æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...';

                // å˜—è©¦ä½¿ç”¨å¾Œç½®é¡é ­
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment", // å„ªå…ˆä½¿ç”¨å¾Œç½®é¡é ­
                    } 
                }) 
                .then(function(stream) {
                    video.srcObject = stream;
                    video.play();
                    requestAnimationFrame(tick);
                })
                .catch(function(err) {
                    console.error("ç„¡æ³•å­˜å–ç›¸æ©Ÿè©³ç´°éŒ¯èª¤:", err);
                    let errorMessage = 'éŒ¯èª¤ï¼šç„¡æ³•å­˜å–ç›¸æ©Ÿã€‚';
                    
                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        errorMessage += ' è«‹æª¢æŸ¥ç€è¦½å™¨å’Œ iOS ç³»çµ±è¨­å®šä¸­çš„ç›¸æ©Ÿæ¬Šé™ï¼Œä¸¦ç¢ºèªæ‚¨çš„ç¶²ç«™æ˜¯é€é HTTPS è¼‰å…¥ã€‚';
                    } else if (err.name === 'NotFoundError') {
                        errorMessage += ' æœªæ‰¾åˆ°ç›¸æ©Ÿè¨­å‚™ã€‚';
                    } else if (err.name === 'NotReadableError') {
                         errorMessage += ' ç›¸æ©Ÿå¯èƒ½å·²è¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ã€‚è«‹é—œé–‰æ‰€æœ‰ä½¿ç”¨ç›¸æ©Ÿçš„ Appã€‚';
                    } else {
                        errorMessage += ` æœªçŸ¥éŒ¯èª¤é¡å‹: ${err.name || 'æœªçŸ¥'}`;
                    }

                    cameraMessage.textContent = errorMessage;
                    document.getElementById('scan-result').textContent = "ç›¸æ©Ÿå­˜å–å¤±æ•—ã€‚";
                    document.getElementById('scan-result').classList.replace('bg-gray-800', 'bg-red-600');
                });
            } else {
                cameraMessage.textContent = 'éŒ¯èª¤ï¼šæ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿå­˜å–ã€‚';
                document.getElementById('scan-result').textContent = "ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿã€‚";
                document.getElementById('scan-result').classList.replace('bg-gray-800', 'bg-red-600');
            }
        };

        // --- 8. å•Ÿå‹•æ‰€æœ‰åŠŸèƒ½ ---
        const startAppFeatures = () => {
            // ç¢ºä¿ä¾è³´ Firebase èªè­‰çš„æœå‹™å·²å•Ÿå‹•
            setupRosterListener();  
            setupRecordsListener(); 
            // åªæœ‰åœ¨æƒæå™¨æ¨™ç±¤å•Ÿç”¨æ™‚æ‰å•Ÿå‹•ç›¸æ©Ÿ
            if (document.getElementById('content-scanner').classList.contains('hidden') === false) {
                 startCamera();
            }
        };

        // åˆå§‹å•Ÿå‹•
        initializeFirebase();
        // é è¨­åˆ‡æ›åˆ°æƒæå™¨ï¼Œä¸¦è§¸ç™¼ camera å•Ÿå‹•é‚è¼¯
        window.switchTab('scanner'); 

    </script>
</body>
</html><!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿ QR Code é»åç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ jsQR æƒæåº« -->
    <script src="https://cdn.jsdelivr.net/npm/jsQR@1.0.4/dist/jsQR.min.js"></script>
    <!-- è¼‰å…¥ qrcode.js ç”¢ç”Ÿ QR Code å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        body { font-family: 'Inter', sans-serif; }
        /* ç‚ºäº† QR æƒæå™¨ï¼Œç¢ºä¿ video å’Œ canvas ä½”æ»¿å®¹å™¨ */
        .scanner-container {
            position: relative;
            width: 100%;
            height: 400px; /* å›ºå®šé«˜åº¦æ–¹ä¾¿ä½ˆå±€ */
            overflow: hidden;
            background-color: #1f2937;
        }
        .scanner-container video, 
        .scanner-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* æ°´å¹³ç¿»è½‰ç›¸æ©Ÿç•«é¢ */
        }
        #highlightCanvas {
            z-index: 10;
        }
        /* æƒææ¡†å‹•ç•« */
        @keyframes scan-line {
            0% { top: 0; opacity: 1; }
            50% { top: 100%; opacity: 0.5; }
            100% { top: 0; opacity: 1; }
        }
        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 80%;
            max-width: 300px;
            max-height: 300px;
            transform: translate(-50%, -50%);
            border: 4px solid #34d399; /* ç¶ è‰²é‚Šæ¡† */
            z-index: 5;
        }
        .scan-frame::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, transparent, #34d399, transparent);
            animation: scan-line 2s infinite linear;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">ğŸ“ å­¸ç”Ÿ QR Code é»åç³»çµ±</h1>
            <p class="text-gray-500">ä½¿ç”¨æ‚¨çš„è¨­å‚™ç›¸æ©Ÿæƒæå­¸ç”Ÿçš„ QR Code ä»¥è¨˜éŒ„å‡ºå¸­ã€‚</p>
            <div id="auth-status" class="text-sm mt-2 p-2 rounded-md bg-yellow-100 text-yellow-800 hidden">
                èº«ä»½é©—è­‰ä¸­...
            </div>
            <div id="secure-context-warning" class="text-sm mt-2 p-2 rounded-md bg-red-100 text-red-800 hidden">
                è­¦å‘Šï¼šæ‚¨æœªåœ¨å®‰å…¨ç’°å¢ƒ (HTTPS) ä¸‹é‹è¡Œï¼Œç›¸æ©ŸåŠŸèƒ½å¯èƒ½è¢«ç€è¦½å™¨é˜»æ“‹ã€‚
            </div>
        </header>

        <!-- å°èˆªæ¨™ç±¤ -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button type="button" onclick="switchTab('scanner')" id="tab-scanner" class="tab-button inline-flex items-center px-4 py-2 border-b-2 font-medium text-sm focus:outline-none transition-colors duration-200 text-green-600 border-green-500">
                    é»åæƒæå™¨
                </button>
                <button type="button" onclick="switchTab('roster')" id="tab-roster" class="tab-button inline-flex items-center px-4 py-2 border-b-2 font-medium text-sm focus:outline-none transition-colors duration-200 text-gray-500 border-transparent hover:border-gray-300 hover:text-gray-700">
                    å­¸ç”Ÿåå–®ç®¡ç†
                </button>
                <button type="button" onclick="switchTab('records')" id="tab-records" class="tab-button inline-flex items-center px-4 py-2 border-b-2 font-medium text-sm focus:outline-none transition-colors duration-200 text-gray-500 border-transparent hover:border-gray-300 hover:text-gray-700">
                    é»åè¨˜éŒ„
                </button>
                <button type="button" onclick="switchTab('account')" id="tab-account" class="tab-button inline-flex items-center px-4 py-2 border-b-2 font-medium text-sm focus:outline-none transition-colors duration-200 text-gray-500 border-transparent hover:border-gray-300 hover:text-gray-700">
                    å¸³æˆ¶ç®¡ç†
                </button>
            </nav>
        </div>

        <!-- 1. é»åæƒæå™¨ (Tab) -->
        <div id="content-scanner" class="tab-content">
            <div class="lg:flex lg:space-x-8">
                <!-- æƒæå€åŸŸ -->
                <div class="lg:w-1/2 mb-6 lg:mb-0">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç›¸æ©Ÿæƒæ</h2>
                    <div id="scanner-area" class="scanner-container rounded-xl shadow-2xl relative">
                        <video id="video" playsinline autoplay></video>
                        <canvas id="canvas" class="hidden"></canvas>
                        <canvas id="highlightCanvas"></canvas>
                        <div class="scan-frame"></div>
                        <div id="camera-message" class="absolute inset-0 bg-gray-800/90 text-white flex items-center justify-center p-4 rounded-xl text-center z-20">
                            æ­£åœ¨è¼‰å…¥ç›¸æ©Ÿ...
                        </div>
                    </div>
                    <div id="scan-result" class="mt-4 p-4 bg-gray-800 rounded-xl text-white text-center text-lg shadow-inner">
                        è«‹å°‡ QR Code ç½®æ–¼æƒææ¡†å…§
                    </div>
                </div>

                <!-- é»åå³æ™‚çµæœ -->
                <div class="lg:w-1/2">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">æœ€æ–°é»å</h2>
                    <div id="latest-attendance" class="p-6 bg-white border border-green-500 rounded-xl shadow-lg space-y-4">
                        <p class="text-gray-500">ç­‰å¾…ç¬¬ä¸€æ¬¡æƒæ...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. å­¸ç”Ÿåå–®ç®¡ç† (Tab) -->
        <div id="content-roster" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">æ–°å¢æˆ–æ›´æ–°å­¸ç”Ÿåå–®</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <form id="add-student-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label for="studentId" class="block text-sm font-medium text-gray-700">å­¸è™Ÿ (ä½œç‚º QR Code å…§å®¹)</label>
                        <input type="text" id="studentId" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="e.g. S1001">
                    </div>
                    <div class="md:col-span-2">
                        <label for="studentName" class="block text-sm font-medium text-gray-700">å§“å</label>
                        <input type="text" id="studentName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="e.g. ç‹å°æ˜">
                    </div>
                    <button type="submit" class="md:col-span-1 w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-150 shadow-md">
                        æ–°å¢ / æ›´æ–°å­¸ç”Ÿ
                    </button>
                </form>
            </div>
            
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç•¶å‰å­¸ç”Ÿåå–®</h2>
            <div id="roster-list" class="bg-white rounded-xl shadow-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å­¸è™Ÿ (QR å…§å®¹)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å§“å</th>
                            <!-- å°‡æ“ä½œæ¬„æ¨™é¡Œå°é½Šå³å´ -->
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="roster-tbody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="3" class="text-center py-4 text-gray-500">æ­£åœ¨è¼‰å…¥åå–®...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 p-4 rounded-xl bg-blue-100 text-blue-800">
                <p>è«‹æ³¨æ„ï¼šå­¸è™Ÿæ¬„ä½çš„å€¼å°‡è¢«ç”¨ä½œå­¸ç”Ÿçš„ QR Code å…§å®¹ã€‚æ‚¨ç¾åœ¨å¯ä»¥ç›´æ¥é»æ“Šã€Œç”¢ç”Ÿ QR Codeã€æŒ‰éˆ•ç²å–åœ–åƒã€‚</p>
            </div>
        </div>

        <!-- 3. é»åè¨˜éŒ„ (Tab) -->
        <div id="content-records" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">æ‰€æœ‰é»åè¨˜éŒ„</h2>
                <button type="button" onclick="exportToCSV()" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-150 shadow-md flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2-8H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2z"></path></svg>
                    åŒ¯å‡ºç‚º Excel (CSV)
                </button>
            </div>
            <div id="records-list" class="bg-white rounded-xl shadow-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å­¸è™Ÿ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å§“å</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é»åæ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody id="records-tbody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="3" class="text-center py-4 text-gray-500">æ­£åœ¨è¼‰å…¥è¨˜éŒ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 4. å¸³æˆ¶ç®¡ç† (Tab) - æ–°å¢ -->
        <div id="content-account" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">å¸³æˆ¶ç®¡ç†èˆ‡å‡ç´š</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <div id="current-auth-info" class="mb-4 p-4 border rounded-lg bg-gray-50">
                    <p class="font-bold text-lg text-gray-700">ç•¶å‰èªè­‰ç‹€æ…‹ï¼š</p>
                    <p id="auth-type-display" class="text-gray-600"></p>
                    <p id="user-id-display" class="text-gray-600"></p>
                </div>
                
                <!-- *** æ–°å¢çš„ç™»å…¥å€å¡Š *** -->
                <div id="signin-section" class="bg-white p-6 rounded-xl shadow-lg mb-8 border border-gray-200">
                    <h3 class="text-xl font-bold text-gray-900 mb-3">ä½¿ç”¨æ°¸ä¹…å¸³è™Ÿç™»å…¥</h3>
                    <p class="text-gray-600 mb-4">å¦‚æœæ‚¨å·²ç¶“åœ¨å…¶ä»–è¨­å‚™ä¸Šå‰µå»ºäº†æ°¸ä¹…å¸³è™Ÿ (Email/Password)ï¼Œè«‹åœ¨æ­¤ç™»å…¥ä»¥ç¹¼æ‰¿æ‚¨çš„è³‡æ–™ã€‚</p>
                    <form id="signin-form" class="space-y-4">
                        <div>
                            <label for="signin-email" class="block text-sm font-medium text-gray-700">é›»å­éƒµä»¶</label>
                            <input type="email" id="signin-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                        <div>
                            <label for="signin-password" class="block text-sm font-medium text-gray-700">å¯†ç¢¼</label>
                            <input type="password" id="signin-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                        <button type="submit" id="signin-button" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-150 shadow-md">
                            ç™»å…¥
                        </button>
                    </form>
                </div>
                <!-- *** ç™»å…¥å€å¡ŠçµæŸ *** -->

                <!-- å¸³è™Ÿå‡ç´šå€å¡Š -->
                <div id="upgrade-section" class="pt-6 border-t border-yellow-200">
                    <h3 class="text-xl font-bold text-gray-900 mb-3">å‡ç´šåˆ°æ°¸ä¹…å¸³è™Ÿ</h3>
                    <p class="text-gray-600 mb-4">
                        å°‡æ‚¨ç•¶å‰çš„åŒ¿åå¸³è™Ÿé€£çµåˆ°é›»å­éƒµä»¶ï¼Œä»¥ç¢ºä¿æ‚¨çš„é»åè³‡æ–™æ°¸ä¹…ä¿å­˜ï¼Œä¸¦èƒ½åœ¨ä»»ä½•è£ç½®ä¸Šç™»å…¥ã€‚
                        <span class="font-semibold text-red-600">ï¼ˆè«‹ç¢ºä¿å·²å•Ÿç”¨ Firebase Email/Password ç™»å…¥ï¼‰</span>
                    </p>
                    <form id="upgrade-account-form" class="space-y-4">
                        <div>
                            <label for="upgrade-email" class="block text-sm font-medium text-gray-700">é›»å­éƒµä»¶</label>
                            <input type="email" id="upgrade-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                        <div>
                            <label for="upgrade-password" class="block text-sm font-medium text-gray-700">å¯†ç¢¼ (è‡³å°‘ 6 ä½å…ƒ)</label>
                            <input type="password" id="upgrade-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                        <button type="submit" id="upgrade-button" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-150 shadow-md">
                            å‡ç´šå¸³è™Ÿä¸¦ä¿ç•™è³‡æ–™
                        </button>
                    </form>
                </div>

                <!-- ç™»å‡ºå€å¡Š -->
                <div class="mt-8 pt-6 border-t border-gray-200" id="signout-section">
                    <button onclick="window.handleSignOut()" id="signout-button" class="w-full bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition duration-150 shadow-md">
                        ç™»å‡º
                    </button>
                    <p class="text-sm text-gray-500 mt-2 text-center">ç™»å‡ºå¾Œï¼Œéœ€è¦é‡æ–°æ•´ç†é é¢ä¸¦å†æ¬¡ç™»å…¥ã€‚</p>
                </div>

            </div>
        </div>
        <!-- å¸³æˆ¶ç®¡ç† (Tab) - çµæŸ -->

    </div>

    <!-- éŒ¯èª¤/æç¤ºè¨Šæ¯æ¨¡æ…‹æ¡† -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl space-y-4">
            <h3 id="modal-title" class="text-xl font-bold text-gray-900">æç¤º</h3>
            <p id="modal-message" class="text-gray-700"></p>
            <div class="flex justify-end">
                <button onclick="closeModal()" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-150">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- QR Code é¡¯ç¤ºæ¨¡æ…‹æ¡† -->
    <div id="qr-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-8 w-full max-w-md shadow-2xl space-y-6">
            <h3 id="qr-modal-title" class="text-2xl font-bold text-gray-900 text-center"></h3>
            <p class="text-center text-gray-600">è«‹å°‡æ­¤ QR Code åœ–åƒï¼ˆå³éµæˆ–é•·æŒ‰ï¼‰å„²å­˜æˆ–åˆ—å°çµ¦å­¸ç”Ÿä½¿ç”¨ã€‚</p>
            <div id="qrcode-container" class="flex justify-center p-4 border border-gray-200 rounded-lg bg-gray-50">
                <!-- QR Code å°‡è¢«ç¹ªè£½åˆ°æ­¤è™• -->
            </div>
            <p id="qr-content-display" class="text-center font-mono text-sm text-gray-800 break-all"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeQRModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 transition duration-150">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- è¼‰å…¥ Firebase SDK å’Œæ‡‰ç”¨ç¨‹å¼é‚è¼¯ -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            signOut,
            EmailAuthProvider,
            linkWithCredential,
            signInWithEmailAndPassword // <-- æ–°å¢çš„ç™»å…¥æ–¹æ³•
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, onSnapshot, collection, serverTimestamp, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 1. æ‚¨çš„ Firebase é…ç½® (è«‹åœ¨æ­¤è™•å¡«å…¥) ---
        // !!! VERY IMPORTANT !!!
        const MY_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAFM-0Hi6J1dtWltpCsGGObBxWtO2ZRRpY",
            authDomain: "dsevictory-attendance-system.firebaseapp.com",
            projectId: "dsevictory-attendance-system",
            storageBucket: "dsevictory-attendance-system.firebasestorage.app",
            messagingSenderId: "796565425082",
            appId: "1:796565425082:web:08babee5be08c0ffdc2b83"
        };
        // ------------------------------------------

        // --- è®Šæ•¸åˆå§‹åŒ– ---
        setLogLevel('debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let firebaseConfig = MY_FIREBASE_CONFIG;
        if (typeof __firebase_config !== 'undefined' && __firebase_config !== '') {
             try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.warn("è§£æ __firebase_config å¤±æ•—ï¼Œä½¿ç”¨ MY_FIREBASE_CONFIG ä½œç‚ºå‚™ç”¨ã€‚");
            }
        }
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' && __initial_auth_token !== '' ? __initial_auth_token : null;
        
        let app, db, auth, userId;
        let authMethodType = 'Unknown';
        let rosterData = {}; // ç”¨æ–¼å¿«å–åå–®ï¼ŒåŠ é€Ÿé»å

        // UI å…ƒç´ 
        const authStatusEl = document.getElementById('auth-status');
        const secureContextWarningEl = document.getElementById('secure-context-warning'); 
        const rosterTbody = document.getElementById('roster-tbody');
        const recordsTbody = document.getElementById('records-tbody');
        const upgradeSectionEl = document.getElementById('upgrade-section');
        const signinSectionEl = document.getElementById('signin-section');
        const signoutSectionEl = document.getElementById('signout-section'); // æ–°å¢

        // --- UI æ§åˆ¶å‡½å¼ ---
        // æ¨¡æ…‹æ¡†å‡½æ•¸ (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('modal').classList.add('hidden');
        };

        // QR Code æ¨¡æ…‹æ¡†å‡½æ•¸ (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.showQRCodeModal = (studentId, studentName) => {
            const modalEl = document.getElementById('qr-modal');
            const titleEl = document.getElementById('qr-modal-title');
            const containerEl = document.getElementById('qrcode-container');
            const contentDisplayEl = document.getElementById('qr-content-display');

            containerEl.innerHTML = '';
            
            titleEl.textContent = `${studentName} çš„ QR Code`;
            contentDisplayEl.textContent = `å…§å®¹ (å­¸è™Ÿ): ${studentId}`;

            // ç”¢ç”Ÿ QR Code
            new QRCode(containerEl, {
                text: studentId, 
                width: 256,
                height: 256,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            modalEl.classList.remove('hidden');
        };

        window.closeQRModal = () => {
            document.getElementById('qr-modal').classList.add('hidden');
        };

        // Tab åˆ‡æ› (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => {
                el.classList.remove('text-green-600', 'border-green-500');
                el.classList.add('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');
            });

            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            const button = document.getElementById(`tab-${tabName}`);
            button.classList.add('text-green-600', 'border-green-500');
            button.classList.remove('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');
            
            // å¦‚æœåˆ‡æ›åˆ°æƒæå™¨ï¼Œç¢ºä¿ç›¸æ©Ÿå•Ÿå‹• (é˜²æ­¢åœ¨å…¶ä»–æ¨™ç±¤æ™‚ä½”ç”¨ç›¸æ©Ÿ)
            const video = document.getElementById('video');
            if (tabName === 'scanner' && userId) {
                 // é‡æ–°å•Ÿå‹•ç›¸æ©Ÿ
                 startCamera();
            } else if (video.srcObject) {
                 // åœæ­¢ç›¸æ©Ÿæµï¼Œé‡‹æ”¾è³‡æº
                 video.srcObject.getTracks().forEach(track => track.stop());
            }
            
            // å¦‚æœåˆ‡æ›åˆ°å¸³æˆ¶ç®¡ç†ï¼Œæ›´æ–°è³‡è¨Š
            if (tabName === 'account' && auth.currentUser) {
                updateAccountInfo(auth.currentUser);
            }
        };

        // --- 2. Firebase èªè­‰å’Œåˆå§‹åŒ– ---
        const initializeFirebase = async () => {
            if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                authStatusEl.textContent = 'éŒ¯èª¤ï¼šFirebase é…ç½®éºå¤±ã€‚è«‹åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ‚¨çš„é…ç½®ã€‚';
                authStatusEl.classList.replace('bg-yellow-100', 'bg-red-100');
                authStatusEl.classList.replace('text-yellow-800', 'text-red-800');
                authStatusEl.classList.remove('hidden');
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                authStatusEl.textContent = 'èº«ä»½é©—è­‰ä¸­...';
                authStatusEl.classList.remove('hidden');

                
                try {
                    // åŸ·è¡Œèº«ä»½é©—è­‰ï¼šå„ªå…ˆä½¿ç”¨ Canvas æä¾›çš„è‡ªå®šç¾©ä»¤ç‰Œ
                    if (initialAuthToken) {
                        authMethodType = 'è‡ªå®šç¾©ä»¤ç‰Œ (Custom Token)';
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        // å¤–éƒ¨ç’°å¢ƒå›é€€åˆ°åŒ¿åç™»éŒ„
                        authMethodType = 'åŒ¿åç™»éŒ„ (Anonymous)';
                        await signInAnonymously(auth);
                    }
                } catch (authError) {
                    console.error("èº«ä»½é©—è­‰å¤±æ•—:", authError);
                    if (authError.code === 'auth/admin-restricted-operation') {
                        authStatusEl.textContent = `èº«ä»½é©—è­‰å¤±æ•—ï¼š(${authError.code})ã€‚
                            è«‹åœ¨ Firebase Console > Authentication > Sign-in method ä¸­ï¼Œç¢ºèªå·²å•Ÿç”¨ã€ŒåŒ¿åã€ç™»éŒ„ã€‚`;
                    } else {
                        authStatusEl.textContent = `èº«ä»½é©—è­‰å¤±æ•—ï¼š${authError.message}`;
                    }
                    authStatusEl.classList.replace('bg-yellow-100', 'bg-red-100');
                    authStatusEl.classList.replace('text-yellow-800', 'text-red-800');
                    return; 
                }
                
                // ç‹€æ…‹æ”¹è®Šå¾Œï¼Œç¢ºä¿ userId å­˜åœ¨æ‰é–‹å§‹ Firestore æ“ä½œ
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        
                        // åˆ¤æ–·æ˜¯å¦ç‚ºåŒ¿åå¸³è™Ÿï¼Œä¸¦æ›´æ–° authMethodType
                        const isAnonymous = user.isAnonymous;
                        if (isAnonymous && authMethodType !== 'è‡ªå®šç¾©ä»¤ç‰Œ (Custom Token)') {
                             authMethodType = 'åŒ¿åç™»éŒ„ (Anonymous)';
                        } else if (!isAnonymous) {
                             // æª¢æŸ¥ Email/Password ç™»å…¥é¡å‹
                             const emailProvider = user.providerData.find(p => p.providerId === 'password');
                             if (emailProvider) {
                                 authMethodType = 'é›»å­éƒµä»¶/å¯†ç¢¼ (Email/Password)';
                             } else if (authMethodType !== 'è‡ªå®šç¾©ä»¤ç‰Œ (Custom Token)') {
                                 authMethodType = 'æ°¸ä¹…å¸³è™Ÿ (Unknown)';
                             }
                        }

                        authStatusEl.textContent = `èªè­‰æˆåŠŸ (${authMethodType})ã€‚ä½¿ç”¨è€… ID: ${userId.substring(0, 8)}... (å®Œæ•´ ID: ${userId})`;
                        authStatusEl.classList.replace('bg-yellow-100', 'bg-green-100');
                        authStatusEl.classList.replace('text-yellow-800', 'text-green-800');
                        
                        // æ›´æ–°å¸³æˆ¶ç®¡ç†é é¢è³‡è¨Š
                        updateAccountInfo(user);
                        
                        // èªè­‰æˆåŠŸå¾Œå•Ÿå‹•æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒåŠŸèƒ½
                        startAppFeatures(); 
                    } else {
                        userId = null;
                        authMethodType = 'æœªèªè­‰';
                        authStatusEl.textContent = 'æœªèªè­‰ã€‚';
                        authStatusEl.classList.replace('bg-yellow-100', 'bg-red-100');
                        authStatusEl.classList.replace('text-yellow-800', 'text-red-800');
                        updateAccountInfo(null);
                    }
                });

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                authStatusEl.textContent = `éŒ¯èª¤ï¼š${error.message}`;
                authStatusEl.classList.replace('bg-yellow-100', 'bg-red-100');
                authStatusEl.classList.replace('text-yellow-800', 'text-red-800');
            }
        };

        // --- 3. å¸³è™Ÿç®¡ç†åŠŸèƒ½ ---

        const updateAccountInfo = (user) => {
            const authTypeDisplayEl = document.getElementById('auth-type-display');
            const userIdDisplayEl = document.getElementById('user-id-display');
            
            if (user) {
                authTypeDisplayEl.textContent = `é¡å‹: ${authMethodType}`;
                userIdDisplayEl.textContent = `UID: ${user.uid}`;
                
                // é‚è¼¯æ§åˆ¶ï¼šå·²ç™»å…¥ (ç„¡è«–åŒ¿åæˆ–æ°¸ä¹…)
                signinSectionEl.classList.add('hidden');
                signoutSectionEl.classList.remove('hidden');

                // åªæœ‰åœ¨åŒ¿åç™»éŒ„ä¸”é Canvas ä»¤ç‰Œæ™‚ï¼Œæ‰é¡¯ç¤ºå‡ç´šå€å¡Š
                if (user.isAnonymous && authMethodType === 'åŒ¿åç™»éŒ„ (Anonymous)') {
                    upgradeSectionEl.classList.remove('hidden');
                } else {
                    upgradeSectionEl.classList.add('hidden');
                }
            } else {
                // é‚è¼¯æ§åˆ¶ï¼šæœªç™»å…¥ (Logged Out)
                authTypeDisplayEl.textContent = `é¡å‹: æœªç™»å…¥`;
                userIdDisplayEl.textContent = `UID: N/A`;
                upgradeSectionEl.classList.add('hidden');
                signoutSectionEl.classList.add('hidden');
                
                // é¡¯ç¤ºç™»å…¥å€å¡Š
                signinSectionEl.classList.remove('hidden');
            }
        };
        
        // è™•ç†å¸³è™Ÿå‡ç´š
        document.getElementById('upgrade-account-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('upgrade-email').value.trim();
            const password = document.getElementById('upgrade-password').value.trim();
            const currentUser = auth.currentUser;
            
            if (!currentUser || !currentUser.isAnonymous) {
                showModal('éŒ¯èª¤', 'æ‚¨ç•¶å‰ä¸æ˜¯åŒ¿åå¸³è™Ÿï¼Œç„¡éœ€å‡ç´šã€‚');
                return;
            }

            if (password.length < 6) {
                showModal('éŒ¯èª¤', 'å¯†ç¢¼é•·åº¦å¿…é ˆè‡³å°‘ç‚º 6 å€‹å­—ç¬¦ã€‚');
                return;
            }

            // å‰µå»º Email/Password èªè­‰æ†‘è­‰
            const credential = EmailAuthProvider.credential(email, password);

            try {
                // å°‡åŒ¿åå¸³è™Ÿé€£çµåˆ°æ–°çš„èªè­‰æ†‘è­‰ï¼Œä»¥å¯¦ç¾å‡ç´šä¸¦ä¿ç•™è³‡æ–™
                await linkWithCredential(currentUser, credential);
                
                showModal('å‡ç´šæˆåŠŸ', 'æ‚¨çš„å¸³è™Ÿå·²æˆåŠŸå‡ç´šç‚ºæ°¸ä¹…çš„é›»å­éƒµä»¶/å¯†ç¢¼å¸³è™Ÿï¼Œæ‰€æœ‰è³‡æ–™å·²ä¿ç•™ï¼è«‹å‹¿å¿˜è¨˜æ‚¨çš„ç™»å…¥è³‡è¨Šã€‚');
                document.getElementById('upgrade-account-form').reset();
                updateAccountInfo(auth.currentUser); // æ›´æ–° UI
                
            } catch (error) {
                console.error("å¸³è™Ÿå‡ç´šå¤±æ•—:", error);
                let errorMessage = 'å‡ç´šå¤±æ•—ã€‚è«‹ç¢ºèªï¼š';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage += ' æ­¤é›»å­éƒµä»¶å·²è¢«å…¶ä»–å¸³è™Ÿä½¿ç”¨ã€‚';
                } else if (error.code === 'auth/weak-password') {
                     errorMessage += ' å¯†ç¢¼å¼·åº¦ä¸è¶³ã€‚';
                } else {
                    errorMessage += ` éŒ¯èª¤ä»£ç¢¼: ${error.code}ã€‚æ‚¨éœ€è¦åœ¨ Firebase Console ä¸­å•Ÿç”¨ Email/Password ç™»å…¥ã€‚`;
                }
                showModal('å‡ç´šéŒ¯èª¤', errorMessage);
            }
        });

        // è™•ç†æ°¸ä¹…å¸³è™Ÿç™»å…¥ (æ–°åŠŸèƒ½)
        document.getElementById('signin-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signin-email').value.trim();
            const password = document.getElementById('signin-password').value.trim();
            
            showModal('ç™»å…¥ä¸­', 'æ­£åœ¨å˜—è©¦ä½¿ç”¨é›»å­éƒµä»¶/å¯†ç¢¼ç™»å…¥...');

            try {
                // åŸ·è¡Œé›»å­éƒµä»¶å¯†ç¢¼ç™»å…¥
                await signInWithEmailAndPassword(auth, email, password);
                
                // ç™»å…¥æˆåŠŸå¾Œ onAuthStateChanged æœƒè‡ªå‹•æ›´æ–° UI
                closeModal(); // é—œé–‰ã€Œç™»å…¥ä¸­ã€çš„æ¨¡æ…‹æ¡†
                showModal('ç™»å…¥æˆåŠŸ', 'æ‚¨å·²æˆåŠŸç™»å…¥æ°¸ä¹…å¸³è™Ÿï¼Œæ­£åœ¨è¼‰å…¥æ‚¨çš„è³‡æ–™ï¼');
                document.getElementById('signin-form').reset();
                
            } catch (error) {
                console.error("ç™»å…¥å¤±æ•—:", error);
                let errorMessage = 'ç™»å…¥å¤±æ•—ã€‚';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage += ' é›»å­éƒµä»¶æˆ–å¯†ç¢¼éŒ¯èª¤ã€‚';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage += ' é›»å­éƒµä»¶æ ¼å¼ç„¡æ•ˆã€‚';
                } else {
                    errorMessage += ` éŒ¯èª¤ä»£ç¢¼: ${error.code}ã€‚è«‹æª¢æŸ¥æ§åˆ¶å°ã€‚`;
                }
                showModal('ç™»å…¥éŒ¯èª¤', errorMessage);
            }
        });

        // è™•ç†ç™»å‡º
        window.handleSignOut = async () => {
            try {
                await signOut(auth);
                // ç™»å‡ºå¾Œ onAuthStateChanged æœƒå°‡ç”¨æˆ¶è¨­ç‚º nullï¼Œä¸¦è§¸ç™¼é‡æ–°åŒ¿åç™»å…¥
                showModal('ç™»å‡ºæˆåŠŸ', 'æ‚¨å·²ç™»å‡ºã€‚é é¢å°‡é‡æ–°å˜—è©¦åŒ¿åç™»å…¥ã€‚');
            } catch (error) {
                console.error("ç™»å‡ºå¤±æ•—:", error);
                showModal('ç™»å‡ºéŒ¯èª¤', `ç™»å‡ºå¤±æ•—ï¼š${error.message}`);
            }
        };
        
        // --- 4. å­¸ç”Ÿåå–®ç®¡ç†åŠŸèƒ½ (Firestore) ---
        const getRosterCollectionRef = () => {
            if (!db || !userId) {
                console.error("Firestore æˆ– userId å°šæœªåˆå§‹åŒ–ã€‚");
                return null;
            }
            // ç§æœ‰è·¯å¾‘: /artifacts/{appId}/users/{userId}/roster
            const path = `/artifacts/${appId}/users/${userId}/roster`;
            return collection(db, path);
        };

        const renderRoster = (students) => {
            rosterTbody.innerHTML = '';
            rosterData = {}; 
            if (students.length === 0) {
                rosterTbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">åå–®ç‚ºç©ºã€‚è«‹æ–°å¢å­¸ç”Ÿã€‚</td></tr>';
                return;
            }
            
            students.forEach(student => {
                rosterData[student.studentId] = { name: student.name, studentId: student.studentId };
                
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors duration-100';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.studentId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex space-x-2 justify-end">
                        <button onclick="window.showQRCodeModal('${student.studentId}', '${student.name}')" class="text-blue-600 hover:text-blue-900 transition-colors duration-100 p-1 rounded-md bg-blue-50">ç”¢ç”Ÿ QR Code</button>
                        <button onclick="window.deleteStudent('${student.studentId}')" class="text-red-600 hover:text-red-900 transition-colors duration-100 p-1 rounded-md bg-red-50">åˆªé™¤</button>
                    </td>
                `;
                rosterTbody.appendChild(tr);
            });
        };

        const setupRosterListener = () => {
            const colRef = getRosterCollectionRef();
            if (!colRef) return;

            onSnapshot(colRef, (snapshot) => {
                const students = [];
                snapshot.forEach(doc => {
                    // ç¢ºä¿æˆ‘å€‘åªè™•ç†åŒ…å« studentId å’Œ name çš„æ–‡æª”
                    const data = doc.data();
                    if (data.studentId) {
                         students.push(data);
                    }
                });
                renderRoster(students);
            }, (error) => {
                console.error("ç›£è½åå–®å¤±æ•—:", error);
                // åªæœ‰åœ¨åˆå§‹åŒ–æ™‚å‡ºéŒ¯æ‰é¡¯ç¤ºæ¨¡æ…‹æ¡†
                if (rosterTbody.textContent.includes('æ­£åœ¨è¼‰å…¥åå–®')) {
                    showModal('éŒ¯èª¤', 'ç„¡æ³•è¼‰å…¥å­¸ç”Ÿåå–®ã€‚');
                }
            });
        };
        
        document.getElementById('add-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('studentId').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            
            if (!studentId || !studentName) {
                showModal('éŒ¯èª¤', 'å­¸è™Ÿå’Œå§“åä¸èƒ½ç‚ºç©ºã€‚');
                return;
            }

            const rosterRef = getRosterCollectionRef();
            if (!rosterRef) return;

            // ä½¿ç”¨å­¸è™Ÿä½œç‚ºæ–‡ä»¶ IDï¼Œä»¥ä¾¿æ–¼æŸ¥æ‰¾å’Œæ›´æ–°
            const docRef = doc(rosterRef, studentId); 
            const data = { studentId, name: studentName };

            try {
                await setDoc(docRef, data);
                showModal('æˆåŠŸ', `å­¸ç”Ÿ ${studentName} (${studentId}) å·²æ–°å¢/æ›´æ–°ã€‚`);
                document.getElementById('add-student-form').reset();
            } catch (e) {
                console.error("æ–°å¢/æ›´æ–°å­¸ç”Ÿå¤±æ•—:", e);
                showModal('éŒ¯èª¤', 'æ–°å¢/æ›´æ–°å­¸ç”Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚');
            }
        });
        
        // åˆªé™¤å­¸ç”Ÿ (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.deleteStudent = async (studentId) => {
            
            const rosterRef = getRosterCollectionRef();
            if (!rosterRef) return;

            const docRef = doc(rosterRef, studentId);
            try {
                // ä½¿ç”¨éé˜»å¡å¼çš„ UI æç¤º
                showModal('è™•ç†ä¸­', `æ­£åœ¨åˆªé™¤å­¸è™Ÿ ${studentId} çš„å­¸ç”Ÿ...`);
                
                await deleteDoc(docRef);
                // é‡æ–°æ‰“é–‹ä¸€å€‹æˆåŠŸçš„æ¨¡æ…‹æ¡†ï¼Œè®“ç”¨æˆ¶çŸ¥é“æ“ä½œå·²å®Œæˆ
                setTimeout(() => {
                    showModal('æˆåŠŸ', `å­¸ç”Ÿ ${studentId} å·²åˆªé™¤ã€‚`);
                }, 500); 
            } catch (e) {
                console.error("åˆªé™¤å­¸ç”Ÿå¤±æ•—:", e);
                showModal('éŒ¯èª¤', 'åˆªé™¤å­¸ç”Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚');
            }
        };

        // --- 5. é»åè¨˜éŒ„åŠŸèƒ½ (Firestore) ---
        const getAttendanceCollectionRef = () => {
            if (!db || !userId) {
                console.error("Firestore æˆ– userId å°šæœªåˆå§‹åŒ–ã€‚");
                return null;
            }
            // ç§æœ‰è·¯å¾‘: /artifacts/{appId}/users/{userId}/attendance_records
            const path = `/artifacts/${appId}/users/${userId}/attendance_records`; 
            return collection(db, path);
        };

        const renderRecords = (records) => {
            recordsTbody.innerHTML = '';
            if (records.length === 0) {
                recordsTbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">å°šç„¡é»åè¨˜éŒ„ã€‚</td></tr>';
                return;
            }

            records.forEach(record => {
                // å°‡ Firestore Timestamp è½‰æ›ç‚º Date ç‰©ä»¶
                const checkInDate = record.checkInTime && record.checkInTime.toDate ? new Date(record.checkInTime.toDate()).toLocaleString('zh-TW') : 'N/A';
                
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors duration-100';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.studentId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${checkInDate}</td>
                `;
                recordsTbody.appendChild(tr);
            });
        };

        const setupRecordsListener = () => {
            const colRef = getAttendanceCollectionRef();
            if (!colRef) return;
            
            onSnapshot(colRef, (snapshot) => {
                const records = [];
                snapshot.forEach(doc => {
                    records.push(doc.data());
                });
                // åœ¨å®¢æˆ¶ç«¯æ’åº (å€’åºï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
                records.sort((a, b) => {
                    const timeA = a.checkInTime && a.checkInTime.toDate ? a.checkInTime.toDate().getTime() : 0;
                    const timeB = b.checkInTime && b.checkInTime.toDate ? b.checkInTime.toDate().getTime() : 0;
                    return timeB - timeA; 
                });
                renderRecords(records);
            }, (error) => {
                console.error("ç›£è½é»åè¨˜éŒ„å¤±æ•—:", error);
                // åªæœ‰åœ¨åˆå§‹åŒ–æ™‚å‡ºéŒ¯æ‰é¡¯ç¤ºæ¨¡æ…‹æ¡†
                if (recordsTbody.textContent.includes('æ­£åœ¨è¼‰å…¥è¨˜éŒ„')) {
                    showModal('éŒ¯èª¤', 'ç„¡æ³•è¼‰å…¥é»åè¨˜éŒ„ã€‚');
                }
            });
        };

        // è¨˜éŒ„é»å (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.logAttendance = async (qrContent) => {
            const studentInfo = rosterData[qrContent];
            const scanResultEl = document.getElementById('scan-result');
            const latestAttendanceEl = document.getElementById('latest-attendance');

            if (!studentInfo) {
                const msg = `éŒ¯èª¤ï¼šå­¸è™Ÿ ${qrContent} æœªåœ¨åå–®ä¸­ã€‚`;
                scanResultEl.textContent = msg;
                scanResultEl.classList.replace('bg-gray-800', 'bg-red-600');
                latestAttendanceEl.innerHTML = `<p class="text-red-600 font-bold">${msg}</p>`;
                return false;
            }
            
            const attendanceRef = getAttendanceCollectionRef();
            if (!attendanceRef) return false;

            const attendanceRecord = {
                studentId: studentInfo.studentId,
                name: studentInfo.name,
                checkInTime: serverTimestamp() 
            };

            try {
                await addDoc(attendanceRef, attendanceRecord);
                
                const successMsg = `é»åæˆåŠŸï¼å­¸ç”Ÿï¼š${studentInfo.name} (${studentInfo.studentId})`;
                scanResultEl.textContent = successMsg;
                scanResultEl.classList.replace('bg-red-600', 'bg-gray-800');
                
                latestAttendanceEl.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <p class="text-xl font-bold text-green-700">${studentInfo.name}</p>
                    </div>
                    <p class="text-gray-600">å­¸è™Ÿ: ${studentInfo.studentId}</p>
                    <p class="text-sm text-gray-500">é»åæ™‚é–“: ${new Date().toLocaleTimeString('zh-TW')}</p>
                `;
                return true;
            } catch (e) {
                console.error("è¨˜éŒ„é»åå¤±æ•—:", e);
                showModal('éŒ¯èª¤', 'è¨˜éŒ„é»åå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°æˆ–ç¶²è·¯ã€‚');
                return false;
            }
        };

        // --- 6. è³‡æ–™åŒ¯å‡ºåŠŸèƒ½ (CSV) ---
        // åŒ¯å‡ºç‚º CSV (æš´éœ²çµ¦ HTML è¡Œå…§äº‹ä»¶)
        window.exportToCSV = async () => {
            const colRef = getAttendanceCollectionRef();
            if (!colRef) {
                showModal('éŒ¯èª¤', 'Firebase å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å€™ã€‚');
                return;
            }
            
            try {
                const snapshot = await getDocs(colRef);
                let records = [];
                snapshot.forEach(doc => records.push(doc.data()));
                
                if (records.length === 0) {
                    showModal('æç¤º', 'æ²’æœ‰é»åè¨˜éŒ„å¯ä»¥åŒ¯å‡ºã€‚');
                    return;
                }

                // åœ¨å®¢æˆ¶ç«¯æ’åº (å‡åº)
                records.sort((a, b) => {
                    const timeA = a.checkInTime && a.checkInTime.toDate ? a.checkInTime.toDate().getTime() : 0;
                    const timeB = b.checkInTime && b.checkInTime.toDate ? b.checkInTime.toDate().getTime() : 0;
                    return timeA - timeB; 
                });

                // æº–å‚™ CSV å…§å®¹
                let csvContent = "å­¸è™Ÿ,å§“å,é»åæ™‚é–“\n";

                records.forEach(record => {
                    const studentId = record.studentId || '';
                    const name = (record.name || '').replace(/"/g, '""'); // è™•ç†å§“åä¸­çš„å¼•è™Ÿ
                    const checkInDate = record.checkInTime && record.checkInTime.toDate ? new Date(record.checkInTime.toDate()).toLocaleString('zh-TW', {
                        year: 'numeric', month: '2-digit', day: '2-digit', 
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    }) : '';
                    
                    // ç¢ºä¿å§“åè¢«é›™å¼•è™ŸåŒ…åœï¼Œä»¥è™•ç†ä¸­æ–‡æˆ–é€—è™Ÿ
                    csvContent += `${studentId},"${name}",${checkInDate}\n`;
                });

                // å‰µå»º Blob ä¸¦ä¸‹è¼‰ (æ–°å¢ BOM ç¢ºä¿ Excel æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡)
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `é»åè¨˜éŒ„_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showModal('æˆåŠŸ', `å·²åŒ¯å‡º ${records.length} æ¢é»åè¨˜éŒ„ç‚º CSV æª”æ¡ˆã€‚`);

            } catch (e) {
                console.error("åŒ¯å‡ºå¤±æ•—:", e);
                showModal('éŒ¯èª¤', 'åŒ¯å‡ºé»åè¨˜éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚');
            }
        };


        // --- 7. QR Code æƒæå™¨é‚è¼¯ ---
        const video = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvas = canvasElement.getContext('2d');
        const highlightCanvas = document.getElementById('highlightCanvas');
        const highlightContext = highlightCanvas.getContext('2d');
        const cameraMessage = document.getElementById('camera-message');

        let lastScannedCode = null;
        let lastScanTime = 0;
        const scanCooldown = 3000; // 3 ç§’å†·å»æ™‚é–“

        const drawLine = (context, begin, end, color) => {
            context.beginPath();
            context.moveTo(begin.x, begin.y);
            context.lineTo(end.x, end.y);
            context.lineWidth = 4;
            context.strokeStyle = color;
            context.stroke();
        }

        const tick = () => {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                cameraMessage.classList.add('hidden'); 

                // è¨­ç½® canvas å°ºå¯¸èˆ‡ video ä¸€è‡´
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                highlightCanvas.height = video.videoHeight;
                highlightCanvas.width = video.videoWidth;

                // å°‡è¦–è¨Šå¹€ç¹ªè£½åˆ°éš±è—çš„ canvas ä¸Š
                // ç”±æ–¼ CSS ç¿»è½‰äº† videoï¼Œç¹ªè£½æ™‚ä¹Ÿéœ€è¦è€ƒæ…®ç¿»è½‰ä¾†æ­£ç¢ºè§£æ QR ç¢¼ä½ç½®
                canvas.save();
                canvas.scale(-1, 1);
                canvas.drawImage(video, -canvasElement.width, 0, canvasElement.width, canvasElement.height);
                canvas.restore();

                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                
                highlightContext.clearRect(0, 0, highlightCanvas.width, highlightCanvas.height);

                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    // ç¹ªè£½é«˜äº®æ¡†
                    drawLine(highlightContext, code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
                    drawLine(highlightContext, code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
                    drawLine(highlightContext, code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
                    drawLine(highlightContext, code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");
                    
                    document.getElementById('scan-result').textContent = `å·²æƒæï¼š${code.data}`;
                    
                    const currentTime = Date.now();
                    if (userId && (code.data !== lastScannedCode || currentTime - lastScanTime > scanCooldown)) {
                        
                        if (Object.keys(rosterData).length > 0) {
                            window.logAttendance(code.data);
                            lastScannedCode = code.data;
                            lastScanTime = currentTime;
                        } else {
                             document.getElementById('scan-result').textContent = `å·²æƒæï¼š${code.data} (è­¦å‘Šï¼šåå–®æœªè¼‰å…¥ï¼Œç„¡æ³•è¨˜éŒ„)`;
                             document.getElementById('scan-result').classList.replace('bg-gray-800', 'bg-yellow-600');
                        }
                    } else if (!userId) {
                        document.getElementById('scan-result').textContent = `å·²æƒæï¼š${code.data} (ç­‰å¾… Firebase èªè­‰...)`;
                    } else if (code.data === lastScannedCode && currentTime - lastScanTime < scanCooldown) {
                         document.getElementById('scan-result').textContent = `å·²æƒæï¼š${code.data} (å†·å»ä¸­...)`;
                    }
                } else {
                    document.getElementById('scan-result').textContent = "è«‹å°‡ QR Code ç½®æ–¼æƒææ¡†å…§";
                    document.getElementById('scan-result').classList.replace('bg-red-600', 'bg-gray-800');
                    document.getElementById('scan-result').classList.replace('bg-yellow-600', 'bg-gray-800');
                }
            }

            requestAnimationFrame(tick);
        }

        // å•Ÿå‹•ç›¸æ©Ÿ
        const startCamera = () => {
             // å¦‚æœç›¸æ©Ÿå·²ç¶“åœ¨é‹è¡Œï¼Œå…ˆåœæ­¢å®ƒ
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            
            // æª¢æŸ¥å®‰å…¨ç’°å¢ƒ (HTTPS)
            if (!window.isSecureContext) {
                 secureContextWarningEl.classList.remove('hidden');
                 cameraMessage.textContent = 'åš´é‡éŒ¯èª¤ï¼šå¿…é ˆé€é HTTPS å­˜å–æ‰èƒ½å•Ÿå‹•ç›¸æ©Ÿ (iOS/Safari é™åˆ¶)ã€‚';
                 document.getElementById('scan-result').textContent = "ç›¸æ©Ÿå­˜å–å¤±æ•— (HTTPS éŒ¯èª¤)ã€‚";
                 return; 
            } else {
                 secureContextWarningEl.classList.add('hidden');
            }


            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                cameraMessage.textContent = 'æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...';

                // å˜—è©¦ä½¿ç”¨å¾Œç½®é¡é ­
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment", // å„ªå…ˆä½¿ç”¨å¾Œç½®é¡é ­
                    } 
                }) 
                .then(function(stream) {
                    video.srcObject = stream;
                    video.play();
                    requestAnimationFrame(tick);
                })
                .catch(function(err) {
                    console.error("ç„¡æ³•å­˜å–ç›¸æ©Ÿè©³ç´°éŒ¯èª¤:", err);
                    let errorMessage = 'éŒ¯èª¤ï¼šç„¡æ³•å­˜å–ç›¸æ©Ÿã€‚';
                    
                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        errorMessage += ' è«‹æª¢æŸ¥ç€è¦½å™¨å’Œ iOS ç³»çµ±è¨­å®šä¸­çš„ç›¸æ©Ÿæ¬Šé™ï¼Œä¸¦ç¢ºèªæ‚¨çš„ç¶²ç«™æ˜¯é€é HTTPS è¼‰å…¥ã€‚';
                    } else if (err.name === 'NotFoundError') {
                        errorMessage += ' æœªæ‰¾åˆ°ç›¸æ©Ÿè¨­å‚™ã€‚';
                    } else if (err.name === 'NotReadableError') {
                         errorMessage += ' ç›¸æ©Ÿå¯èƒ½å·²è¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ã€‚è«‹é—œé–‰æ‰€æœ‰ä½¿ç”¨ç›¸æ©Ÿçš„ Appã€‚';
                    } else {
                        errorMessage += ` æœªçŸ¥éŒ¯èª¤é¡å‹: ${err.name || 'æœªçŸ¥'}`;
                    }

                    cameraMessage.textContent = errorMessage;
                    document.getElementById('scan-result').textContent = "ç›¸æ©Ÿå­˜å–å¤±æ•—ã€‚";
                    document.getElementById('scan-result').classList.replace('bg-gray-800', 'bg-red-600');
                });
            } else {
                cameraMessage.textContent = 'éŒ¯èª¤ï¼šæ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿå­˜å–ã€‚';
                document.getElementById('scan-result').textContent = "ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿã€‚";
                document.getElementById('scan-result').classList.replace('bg-gray-800', 'bg-red-600');
            }
        };

        // --- 8. å•Ÿå‹•æ‰€æœ‰åŠŸèƒ½ ---
        const startAppFeatures = () => {
            // ç¢ºä¿ä¾è³´ Firebase èªè­‰çš„æœå‹™å·²å•Ÿå‹•
            setupRosterListener();  
            setupRecordsListener(); 
            // åªæœ‰åœ¨æƒæå™¨æ¨™ç±¤å•Ÿç”¨æ™‚æ‰å•Ÿå‹•ç›¸æ©Ÿ
            if (document.getElementById('content-scanner').classList.contains('hidden') === false) {
                 startCamera();
            }
        };

        // åˆå§‹å•Ÿå‹•
        initializeFirebase();
        // é è¨­åˆ‡æ›åˆ°æƒæå™¨ï¼Œä¸¦è§¸ç™¼ camera å•Ÿå‹•é‚è¼¯
        window.switchTab('scanner'); 

    </script>
</body>
</html>
