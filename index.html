<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¸ç”Ÿ QR Code é»åç³»çµ± (Pro)</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ jsQR æƒæåº« -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.0.4/dist/jsQR.min.js"></script>
    <!-- è¼‰å…¥ qrcode.js ç”¢ç”Ÿ QR Code å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        /* æƒæå™¨å®¹å™¨ï¼šé‡å° iPad å„ªåŒ–é«˜åº¦ */
        .scanner-wrapper {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 75%; /* 4:3 æ¯”ä¾‹ï¼Œé©åˆ iPad */
            background-color: #000;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .scanner-wrapper video, 
        .scanner-wrapper canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* æƒæç·šç‰¹æ•ˆ */
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #00ff00;
            box-shadow: 0 0 4px #00ff00;
            top: 0;
            left: 0;
            animation: scan 2s infinite linear;
            z-index: 10;
        }

        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* æƒææ¡† */
        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 70%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.5); /*å‘¨åœè®Šæš—*/
            z-index: 5;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-20"> <!-- åº•éƒ¨ç•™ç™½çµ¦ iPad Home Bar -->

    <div id="app" class="max-w-4xl mx-auto p-4">
        
        <!-- é ‚éƒ¨æ¨™é¡Œèˆ‡ç‹€æ…‹ -->
        <header class="mb-6 bg-white p-4 rounded-2xl shadow-sm">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ“± å­¸ç”Ÿé»åç³»çµ± Pro</h1>
                    <p class="text-xs text-gray-500 mt-1">iPad/Mac è·¨å¹³å°é›²ç«¯åŒæ­¥ç‰ˆ</p>
                </div>
                <div id="auth-indicator" class="h-3 w-3 rounded-full bg-red-500 animate-pulse" title="é€£ç·šç‹€æ…‹"></div>
            </div>
            <div id="status-message" class="text-xs text-gray-500 mt-2 hidden">æ­£åœ¨é€£ç·šè³‡æ–™åº«...</div>
        </header>

        <!-- å°èˆªåˆ‡æ› (é¡ä¼¼ App çš„ Tab) -->
        <div class="flex space-x-2 mb-6 bg-gray-200 p-1 rounded-xl">
            <button onclick="switchTab('scanner')" id="tab-scanner" class="flex-1 py-2 text-sm font-bold rounded-lg bg-white shadow text-blue-600 transition-all">
                ğŸ“· æƒæé»å
            </button>
            <button onclick="switchTab('roster')" id="tab-roster" class="flex-1 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-all">
                ğŸ‘¥ å­¸ç”Ÿåå–®
            </button>
            <button onclick="switchTab('records')" id="tab-records" class="flex-1 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-all">
                ğŸ“Š é»åè¨˜éŒ„
            </button>
        </div>

        <!-- 1. æƒæå™¨é é¢ -->
        <div id="content-scanner" class="tab-content">
            <div class="bg-white p-4 rounded-2xl shadow-sm">
                <div class="scanner-wrapper mb-4">
                    <video id="video" playsinline muted autoplay></video>
                    <canvas id="canvas" class="hidden"></canvas>
                    <div class="scan-overlay">
                        <div class="scan-line"></div>
                    </div>
                    <!-- éŒ¯èª¤è¨Šæ¯å±¤ -->
                    <div id="camera-error" class="absolute inset-0 bg-gray-900 text-white flex flex-col items-center justify-center p-6 text-center z-20 hidden">
                        <svg class="w-12 h-12 text-red-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
                        <h3 class="font-bold text-lg mb-1">ç„¡æ³•å­˜å–ç›¸æ©Ÿ</h3>
                        <p class="text-sm text-gray-300 mb-4">è«‹ç¢ºä¿æ‚¨ä½¿ç”¨çš„æ˜¯ <span class="text-yellow-400 font-mono">https://</span> ç¶²å€ï¼Œä¸¦å·²åœ¨è¨­å‚™è¨­å®šä¸­å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚</p>
                        <button onclick="startCamera()" class="px-4 py-2 bg-blue-600 rounded-lg text-sm">é‡è©¦</button>
                    </div>
                </div>
                
                <div id="scan-feedback" class="text-center p-4 bg-gray-50 rounded-xl border border-gray-200">
                    <p class="text-gray-500 text-sm">è«‹å°‡ QR Code å°æº–æ¡†ç·šä¸­å¤®</p>
                </div>
            </div>
        </div>

        <!-- 2. åå–®ç®¡ç†é é¢ -->
        <div id="content-roster" class="tab-content hidden">
            <!-- æ–°å¢å­¸ç”Ÿè¡¨å–® -->
            <div class="bg-white p-6 rounded-2xl shadow-sm mb-6">
                <h2 class="font-bold text-gray-800 mb-4 flex items-center">
                    <span class="bg-blue-100 text-blue-600 p-1.5 rounded-lg mr-2 text-xs">NEW</span> æ–°å¢å­¸ç”Ÿ
                </h2>
                <form id="add-student-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">å­¸è™Ÿ (QRå…§å®¹)</label>
                            <input type="text" id="studentId" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="ä¾‹å¦‚: S001">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">å§“å</label>
                            <input type="text" id="studentName" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="ä¾‹å¦‚: é™³å¤§æ–‡">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">é›»è©± (é¸å¡«)</label>
                        <input type="tel" id="studentPhone" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="ä¾‹å¦‚: 0912345678">
                    </div>
                    <button type="submit" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-200 active:scale-95 transition-all">
                        å„²å­˜ä¸¦ä¸Šå‚³é›²ç«¯
                    </button>
                </form>
            </div>

            <!-- åå–®åˆ—è¡¨ -->
            <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                <div class="p-4 border-b border-gray-100">
                    <h2 class="font-bold text-gray-800">å­¸ç”Ÿç¸½è¡¨</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500">
                            <tr>
                                <th class="p-4">å­¸è™Ÿ</th>
                                <th class="p-4">å§“å/é›»è©±</th>
                                <th class="p-4 text-right">åŠŸèƒ½</th>
                            </tr>
                        </thead>
                        <tbody id="roster-tbody" class="divide-y divide-gray-100">
                            <tr><td colspan="3" class="p-8 text-center text-gray-400">è¼‰å…¥è³‡æ–™ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3. è¨˜éŒ„é é¢ -->
        <div id="content-records" class="tab-content hidden">
            <div class="bg-white p-4 rounded-2xl shadow-sm mb-4 flex justify-between items-center">
                <h2 class="font-bold text-gray-800">ä»Šæ—¥é»åæ¦‚æ³</h2>
                <button onclick="exportToCSV()" class="flex items-center space-x-1 px-4 py-2 bg-green-100 text-green-700 rounded-lg text-xs font-bold hover:bg-green-200 transition-colors">
                    <span>ğŸ“¥ åŒ¯å‡º Excel</span>
                </button>
            </div>

            <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500">
                            <tr>
                                <th class="p-4">æ™‚é–“</th>
                                <th class="p-4">å­¸ç”Ÿè³‡è¨Š</th>
                                <th class="p-4">ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="records-tbody" class="divide-y divide-gray-100">
                            <tr><td colspan="3" class="p-8 text-center text-gray-400">å°šç„¡è¨˜éŒ„</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- æ¨¡æ…‹æ¡†ï¼šé€šç”¨æç¤º -->
    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl transform transition-all">
            <h3 id="modal-title" class="text-lg font-bold text-gray-900 mb-2">æç¤º</h3>
            <p id="modal-message" class="text-gray-600 mb-6">å…§å®¹</p>
            <button onclick="closeModal()" class="w-full py-3 bg-gray-100 text-gray-800 font-bold rounded-xl hover:bg-gray-200">é—œé–‰</button>
        </div>
    </div>

    <!-- æ¨¡æ…‹æ¡†ï¼šQR Code é¡¯ç¤º -->
    <div id="qr-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl text-center">
            <h3 id="qr-modal-name" class="text-xl font-bold text-gray-900 mb-1">å­¸ç”Ÿå§“å</h3>
            <p id="qr-modal-id" class="text-sm text-gray-500 mb-4">ID: S001</p>
            
            <div id="qrcode-container" class="flex justify-center mb-4 p-4 bg-white border-2 border-dashed border-gray-200 rounded-xl"></div>
            
            <p class="text-xs text-gray-400 mb-6">è«‹é•·æŒ‰åœ–ç‰‡å„²å­˜ï¼Œæˆ–ç›´æ¥æˆªåœ–</p>
            <button onclick="closeQRModal()" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg">å®Œæˆ</button>
        </div>
    </div>

    <!-- é‚è¼¯è…³æœ¬ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, deleteDoc, onSnapshot, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- è¨­å®šèˆ‡ç‹€æ…‹ ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default';
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth, userId;
        let rosterMap = {}; // å­¸è™Ÿ -> å­¸ç”Ÿè³‡æ–™ (å¿«å–)

        // --- åˆå§‹åŒ– Firebase ---
        async function initApp() {
            if (!firebaseConfig.apiKey) {
                showModal('é…ç½®éŒ¯èª¤', 'æ‰¾ä¸åˆ° Firebase è¨­å®šã€‚');
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // èªè­‰æµç¨‹
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('auth-indicator').classList.replace('bg-red-500', 'bg-green-500');
                    document.getElementById('auth-indicator').classList.remove('animate-pulse');
                    console.log("å·²é€£ç·šï¼Œç”¨æˆ¶ID:", userId);
                    startListeners();
                } else {
                    document.getElementById('auth-indicator').classList.replace('bg-green-500', 'bg-red-500');
                    // å˜—è©¦ç™»å…¥
                    if (initialToken) signInWithCustomToken(auth, initialToken);
                    else signInAnonymously(auth);
                }
            });
        }

        // --- Firestore ç›£è½å™¨ ---
        function startListeners() {
            // 1. ç›£è½åå–®
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/roster`), snapshot => {
                const students = [];
                rosterMap = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    students.push(data);
                    rosterMap[data.studentId] = data;
                });
                renderRoster(students);
            });

            // 2. ç›£è½è¨˜éŒ„ (åªæŠ“ä»Šå¤©çš„ï¼Œæˆ–å…¨éƒ¨æŠ“å–å¾Œåœ¨å‰ç«¯éæ¿¾)
            // ç‚ºäº†æ•ˆèƒ½ï¼Œé€™è£¡æš«æ™‚æŠ“å–å…¨éƒ¨ï¼Œå¯¦éš›ç”Ÿç”¢ç’°å¢ƒå»ºè­°ç”¨ query é™åˆ¶æ—¥æœŸ
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/attendance_records`), snapshot => {
                const records = [];
                snapshot.forEach(doc => records.push(doc.data()));
                // æŒ‰æ™‚é–“å€’åº
                records.sort((a, b) => (b.checkInTime?.seconds || 0) - (a.checkInTime?.seconds || 0));
                renderRecords(records);
            });
        }

        // --- æ¸²æŸ“ UI ---
        function renderRoster(students) {
            const tbody = document.getElementById('roster-tbody');
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-400">ç›®å‰æ²’æœ‰å­¸ç”Ÿï¼Œè«‹ä¸Šæ–¹æ–°å¢</td></tr>';
                return;
            }
            tbody.innerHTML = students.map(s => `
                <tr class="border-b border-gray-50 hover:bg-gray-50">
                    <td class="p-4 font-mono text-blue-600 font-bold">${s.studentId}</td>
                    <td class="p-4">
                        <div class="font-bold text-gray-800">${s.name}</div>
                        <div class="text-xs text-gray-400">${s.phone || 'ç„¡é›»è©±'}</div>
                    </td>
                    <td class="p-4 text-right">
                        <button onclick="window.showQR('${s.studentId}', '${s.name}')" class="p-2 bg-blue-50 text-blue-600 rounded-lg mr-1 hover:bg-blue-100">QR</button>
                        <button onclick="window.delStudent('${s.studentId}')" class="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100">åˆª</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderRecords(records) {
            const tbody = document.getElementById('records-tbody');
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-400">å°šç„¡é»åè¨˜éŒ„</td></tr>';
                return;
            }
            tbody.innerHTML = records.map(r => {
                const date = r.checkInTime ? new Date(r.checkInTime.seconds * 1000) : new Date();
                const timeStr = date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute:'2-digit' });
                const dateStr = date.toLocaleDateString('zh-TW');
                return `
                <tr class="border-b border-gray-50">
                    <td class="p-4">
                        <div class="font-bold text-gray-800">${timeStr}</div>
                        <div class="text-xs text-gray-400">${dateStr}</div>
                    </td>
                    <td class="p-4">
                        <div class="font-bold text-gray-800">${r.name}</div>
                        <div class="text-xs text-gray-500">${r.studentId}</div>
                    </td>
                    <td class="p-4">
                        <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">å·²åˆ°</span>
                    </td>
                </tr>
            `}).join('');
        }

        // --- æ¥­å‹™é‚è¼¯ ---
        
        // æ–°å¢å­¸ç”Ÿ
        document.getElementById('add-student-form').addEventListener('submit', async e => {
            e.preventDefault();
            if(!userId) return showModal('éŒ¯èª¤', 'å°šæœªé€£ç·šåˆ°è³‡æ–™åº«');

            const id = document.getElementById('studentId').value.trim();
            const name = document.getElementById('studentName').value.trim();
            const phone = document.getElementById('studentPhone').value.trim();

            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/roster`, id), {
                    studentId: id, name, phone, createdAt: serverTimestamp()
                });
                showModal('æˆåŠŸ', `å·²æ–°å¢å­¸ç”Ÿï¼š${name}`);
                e.target.reset();
            } catch (err) {
                console.error(err);
                showModal('å¤±æ•—', 'å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
            }
        });

        // åˆªé™¤å­¸ç”Ÿ
        window.delStudent = async (id) => {
            if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½å­¸ç”Ÿå—ï¼Ÿ(é»åè¨˜éŒ„æœƒä¿ç•™)')) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/roster`, id));
            } catch(err) { showModal('éŒ¯èª¤', err.message); }
        };

        // è™•ç†æƒæçµæœ
        window.handleScan = async (code) => {
            if(!userId) return { success: false, msg: 'æœªé€£ç·š' };
            
            const student = rosterMap[code];
            if (!student) return { success: false, msg: 'ç„¡æ•ˆçš„ QR Code (æŸ¥ç„¡æ­¤äºº)' };

            // å¯«å…¥è¨˜éŒ„
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/attendance_records`), {
                    studentId: student.studentId,
                    name: student.name,
                    phone: student.phone || '',
                    checkInTime: serverTimestamp()
                });
                return { success: true, msg: `${student.name} é»åæˆåŠŸï¼`, student };
            } catch (err) {
                return { success: false, msg: 'å¯«å…¥å¤±æ•—' };
            }
        };

        // åŒ¯å‡º CSV
        window.exportToCSV = async () => {
            if(!userId) return;
            const snapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/attendance_records`));
            let csvContent = "\uFEFFæ™‚é–“,æ—¥æœŸ,å­¸è™Ÿ,å§“å,é›»è©±\n"; // BOM for Excel

            const records = [];
            snapshot.forEach(d => records.push(d.data()));
            records.sort((a,b) => (a.checkInTime?.seconds || 0) - (b.checkInTime?.seconds || 0));

            records.forEach(r => {
                const d = r.checkInTime ? new Date(r.checkInTime.seconds * 1000) : new Date();
                const date = d.toLocaleDateString('zh-TW');
                const time = d.toLocaleTimeString('zh-TW');
                csvContent += `${time},${date},${r.studentId},${r.name},${r.phone || ''}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `é»åè¡¨_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- UI äº’å‹• ---
        window.showQR = (id, name) => {
            const container = document.getElementById('qrcode-container');
            container.innerHTML = '';
            document.getElementById('qr-modal-name').textContent = name;
            document.getElementById('qr-modal-id').textContent = `ID: ${id}`;
            new QRCode(container, { text: id, width: 200, height: 200 });
            document.getElementById('qr-modal').classList.remove('hidden');
        };

        window.closeQRModal = () => document.getElementById('qr-modal').classList.add('hidden');
        window.showModal = (title, msg) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = msg;
            document.getElementById('modal').classList.remove('hidden');
        };
        window.closeModal = () => document.getElementById('modal').classList.add('hidden');

        // Tab åˆ‡æ›
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('button[id^="tab-"]').forEach(el => {
                el.classList.remove('bg-white', 'shadow', 'text-blue-600');
                el.classList.add('text-gray-600', 'hover:bg-gray-50');
            });
            
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            const btn = document.getElementById(`tab-${tab}`);
            btn.classList.add('bg-white', 'shadow', 'text-blue-600');
            btn.classList.remove('text-gray-600', 'hover:bg-gray-50');

            if(tab === 'scanner') startCamera();
            else stopCamera();
        };

        // --- ç›¸æ©Ÿé‚è¼¯ (ç´” JS) ---
        let videoStream = null;
        let isScanning = false;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const feedback = document.getElementById('scan-feedback');

        window.startCamera = async () => {
            const errorEl = document.getElementById('camera-error');
            errorEl.classList.add('hidden');
            
            try {
                // å¼·åˆ¶è«‹æ±‚å¾Œç½®é¡é ­ (environment)
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                video.srcObject = stream;
                // iOS å¿…é ˆ
                video.setAttribute("playsinline", true); 
                await video.play();
                videoStream = stream;
                isScanning = true;
                requestAnimationFrame(scanTick);
            } catch (err) {
                console.error("ç›¸æ©ŸéŒ¯èª¤", err);
                errorEl.classList.remove('hidden');
            }
        };

        window.stopCamera = () => {
            isScanning = false;
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
        };

        // å†·å»æ©Ÿåˆ¶
        let lastScanCode = null;
        let lastScanTime = 0;

        function scanTick() {
            if (!isScanning) return;
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

                if (code) {
                    const now = Date.now();
                    // é˜²æ­¢é‡è¤‡æƒæ (3ç§’å†·å»)
                    if (code.data !== lastScanCode || (now - lastScanTime > 3000)) {
                        lastScanCode = code.data;
                        lastScanTime = now;
                        
                        // æ’­æ”¾éŸ³æ•ˆ (å¯é¸)
                        // ...
                        
                        // è™•ç†è³‡æ–™
                        window.handleScan(code.data).then(res => {
                            if (res.success) {
                                feedback.innerHTML = `<span class="text-green-600 font-bold text-lg">âœ… ${res.msg}</span>`;
                                // 1.5ç§’å¾Œå¾©åŸ
                                setTimeout(() => feedback.innerHTML = '<p class="text-gray-500 text-sm">è«‹å°‡ QR Code å°æº–æ¡†ç·šä¸­å¤®</p>', 1500);
                            } else {
                                feedback.innerHTML = `<span class="text-red-500 font-bold">âŒ ${res.msg}</span>`;
                            }
                        });
                    }
                }
            }
            requestAnimationFrame(scanTick);
        }

        // å•Ÿå‹•
        initApp();
        switchTab('scanner');

    </script>
</body>
</html>
