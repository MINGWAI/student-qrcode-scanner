<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜é–€ä¸­æ–‡(DSE VICTORY) å­¸ç”Ÿè­‰é»åç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ jsQR æƒæåº« (ä½¿ç”¨ç©©å®šç‰ˆæœ¬) -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- è¼‰å…¥ qrcode.js ç”¢ç”Ÿ QR Code å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }

        /* --- DSE VICTORY å“ç‰Œè‰²ç³» --- */
        :root {
            --dse-dark-blue: #0E2A5D;
            --dse-gold: #FFD700;
            --dse-white: #FFFFFF;
        }

        /* æƒæå™¨å®¹å™¨ */
        .scanner-container {
            position: relative;
            width: 100%;
            background-color: #000;
            border-radius: 1rem;
            overflow: hidden;
            /* ä¿æŒé©ç•¶çš„å¯¬é«˜æ¯” */
            aspect-ratio: 4/3; 
        }
        .scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* æƒææ¡†å‹•ç•« */
        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 70%;
            height: 70%;
            transform: translate(-50%, -50%);
            border: 4px solid var(--dse-gold);
            box-shadow: 0 0 0 4000px rgba(0,0,0,0.5); /* é®ç½©æ•ˆæœ */
            z-index: 10;
        }
        .scan-line {
            position: absolute;
            width: 100%;
            height: 3px;
            background: #ef4444; /* ç´…è‰²æƒæç·šæ›´æ˜é¡¯ */
            animation: scan 2s infinite;
            box-shadow: 0 0 4px #ef4444;
        }
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }

        /* --- å­¸ç”Ÿè­‰æ¨£å¼ --- */
        .id-card {
            max-width: 380px;
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(14, 42, 93, 0.2);
            border: 1px solid var(--dse-gold);
        }
        .id-header {
            background-color: var(--dse-dark-blue);
            padding: 1.5rem;
            text-align: center;
            border-bottom: 4px solid var(--dse-gold);
        }
        .id-title {
            color: var(--dse-gold);
            font-weight: 900;
            font-size: 1.8rem;
            letter-spacing: 0.05em;
            line-height: 1.2;
        }
        .id-slogan {
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.2em;
            margin-top: 0.2rem;
        }
        .id-body {
            padding: 2rem 1.5rem;
            text-align: center;
        }
        .student-name {
            color: var(--dse-dark-blue);
            font-size: 2rem;
            font-weight: 800;
            line-height: 1.2;
            margin-bottom: 0.5rem;
        }
        .student-id-badge {
            display: inline-block;
            background-color: #f0f4f8;
            color: var(--dse-dark-blue);
            padding: 0.25rem 1rem;
            border-radius: 999px;
            font-family: monospace;
            font-size: 1.1rem;
            font-weight: 700;
            border: 1px dashed var(--dse-dark-blue);
            margin-bottom: 1.5rem;
        }
        .qr-frame {
            padding: 10px;
            background: white;
            border: 3px solid var(--dse-dark-blue);
            display: inline-block;
            border-radius: 8px;
        }
        
        /* éš±è—å…ƒç´  */
        .hidden { display: none !important; }
    </style>
</head>
<body class="min-h-screen pb-10">

    <div class="max-w-4xl mx-auto px-4 pt-6">
        
        <!-- Header -->
        <header class="mb-6 text-center md:text-left md:flex md:justify-between md:items-center">
            <div>
                <h1 class="text-3xl font-black text-gray-900" style="color: var(--dse-dark-blue);">
                    æ˜é–€ä¸­æ–‡ <span style="color: #d97706;">DSE VICTORY</span>
                </h1>
                <p class="text-sm text-gray-500 font-bold mt-1 tracking-wider">å°ˆæ¥­å­¸ç”Ÿè­‰é»åç³»çµ±</p>
            </div>
            <div id="auth-status-container" class="mt-2 md:mt-0">
                <span id="auth-status" class="text-xs px-3 py-1 rounded-full bg-gray-200 text-gray-600 inline-block font-bold">
                    ç³»çµ±åˆå§‹åŒ–ä¸­...
                </span>
            </div>
        </header>

        <!-- Tabs -->
        <div class="flex space-x-1 bg-white p-1 rounded-xl shadow-sm mb-6 border border-gray-200 overflow-x-auto sticky top-0 z-20">
            <button onclick="switchTab('scanner')" id="tab-scanner" class="flex-1 py-3 px-4 rounded-lg text-sm font-bold transition-colors text-white" style="background-color: var(--dse-dark-blue);">é»åæƒæ</button>
            <button onclick="switchTab('roster')" id="tab-roster" class="flex-1 py-3 px-4 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-100 transition-colors">å­¸ç”Ÿåå–®</button>
            <button onclick="switchTab('records')" id="tab-records" class="flex-1 py-3 px-4 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-100 transition-colors">é»åè¨˜éŒ„</button>
            <button onclick="switchTab('account')" id="tab-account" class="flex-1 py-3 px-4 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-100 transition-colors">å¸³æˆ¶ç®¡ç†</button>
        </div>

        <!-- 1. æƒæå™¨é é¢ -->
        <div id="view-scanner" class="view-section">
            <div class="bg-white rounded-2xl shadow-lg p-4 border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">ç›¸æ©Ÿæƒæ</h2>
                    <button onclick="toggleCamera()" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                        åˆ‡æ›å‰å¾Œé¡é ­
                    </button>
                </div>

                <!-- éŒ¯èª¤æç¤ºå€ -->
                <div id="camera-error" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm font-bold"></div>

                <div class="scanner-container">
                    <video id="video" playsinline autoplay muted></video>
                    <!-- ç”¨æ–¼ jsQR çš„éš±è— Canvas -->
                    <canvas id="scan-canvas" class="hidden"></canvas> 
                    
                    <div class="scan-frame">
                        <div class="scan-line"></div>
                    </div>
                    <div id="camera-loading" class="absolute inset-0 flex items-center justify-center bg-gray-900 text-white z-20">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"></div>
                            <p>å•Ÿå‹•ç›¸æ©Ÿä¸­...</p>
                        </div>
                    </div>
                </div>

                <div id="scan-result-container" class="mt-4 p-4 rounded-xl bg-gray-50 border border-gray-200 text-center min-h-[80px] flex items-center justify-center">
                    <p class="text-gray-500 font-medium">è«‹å°‡å­¸ç”Ÿè­‰ QR Code å°æº–æ¡†å…§</p>
                </div>
            </div>
        </div>

        <!-- 2. å­¸ç”Ÿåå–®é é¢ -->
        <div id="view-roster" class="view-section hidden">
            <!-- æ–°å¢å­¸ç”Ÿè¡¨å–® -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border-l-4" style="border-left-color: var(--dse-gold);">
                <h3 class="text-lg font-bold mb-4 flex items-center text-gray-800">
                    <span class="bg-yellow-100 text-yellow-800 p-1 rounded mr-2">â•</span> æ–°å¢å­¸ç”Ÿè³‡æ–™
                </h3>
                <form id="add-student-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">å­¸ç”Ÿè­‰ç·¨è™Ÿ / è‰²ç¢¼</label>
                        <input type="text" id="input-id" placeholder="e.g. VIP01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">å­¸ç”Ÿå§“å</label>
                        <input type="text" id="input-name" placeholder="e.g. ELKA" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition-transform active:scale-95" style="background-color: var(--dse-dark-blue);">
                            ç¢ºèªæ–°å¢
                        </button>
                    </div>
                </form>
            </div>

            <!-- åå–®åˆ—è¡¨ -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4 font-bold text-gray-600 text-sm whitespace-nowrap">ç·¨è™Ÿ</th>
                                <th class="p-4 font-bold text-gray-600 text-sm whitespace-nowrap">å§“å</th>
                                <th class="p-4 font-bold text-gray-600 text-sm text-right whitespace-nowrap">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="roster-list">
                            <tr><td colspan="3" class="p-8 text-center text-gray-400">æ­£åœ¨è¼‰å…¥è³‡æ–™åº«...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3. é»åè¨˜éŒ„é é¢ -->
        <div id="view-records" class="view-section hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">å‡ºå¸­è¨˜éŒ„</h2>
                <button onclick="exportCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-green-700 flex items-center gap-2 text-sm">
                    ğŸ“¥ åŒ¯å‡º Excel
                </button>
            </div>
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4 font-bold text-gray-600 text-sm whitespace-nowrap">æ™‚é–“</th>
                                <th class="p-4 font-bold text-gray-600 text-sm whitespace-nowrap">å­¸ç”Ÿ</th>
                                <th class="p-4 font-bold text-gray-600 text-sm whitespace-nowrap">ç·¨è™Ÿ</th>
                            </tr>
                        </thead>
                        <tbody id="records-list">
                            <tr><td colspan="3" class="p-8 text-center text-gray-400">å°šç„¡é»åè¨˜éŒ„</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 4. å¸³æˆ¶ç®¡ç† (å·²ä¿®æ­£ï¼šåŒ¿åæ™‚ä¹Ÿèƒ½ç™»å…¥) -->
        <div id="view-account" class="view-section hidden">
            <div class="max-w-md mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">å¸³æˆ¶ç®¡ç†</h2>
                
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                    <div class="mb-4">
                        <p class="text-xs font-bold text-gray-500 uppercase">ç•¶å‰ç‹€æ…‹</p>
                        <p id="account-status-text" class="text-lg font-bold text-gray-800">æª¢æŸ¥ä¸­...</p>
                        <p id="account-uid-text" class="text-xs font-mono text-gray-400 mt-1 break-all">UID: ...</p>
                    </div>

                    <!-- å‡ç´šå¸³è™Ÿ (åŒ¿å -> æ°¸ä¹…) -->
                    <div id="upgrade-section" class="hidden pt-4 border-t border-gray-100">
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                            <p class="text-sm text-yellow-800">âš ï¸ é€™æ˜¯<strong>åŒ¿åå¸³è™Ÿ</strong>ã€‚å¦‚éœ€ä¿ç•™è³‡æ–™ï¼Œè«‹å‡ç´šæˆ–ç™»å…¥ç¾æœ‰å¸³è™Ÿã€‚</p>
                        </div>
                        <h3 class="font-bold text-gray-800 mb-2">å‡ç´šç‚ºæ°¸ä¹…å¸³è™Ÿ (ä¿ç•™è³‡æ–™)</h3>
                        <form id="upgrade-form" class="space-y-3">
                            <input type="email" id="up-email" placeholder="è¨­å®š Email" class="w-full p-3 border rounded-lg" required>
                            <input type="password" id="up-password" placeholder="è¨­å®šå¯†ç¢¼ (6ä½ä»¥ä¸Š)" class="w-full p-3 border rounded-lg" required>
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">ç¢ºèªå‡ç´š</button>
                        </form>
                    </div>

                    <!-- ç™»å‡ºæŒ‰éˆ• (ç™»å…¥å¾Œæ‰é¡¯ç¤º) -->
                    <div id="logout-section" class="hidden pt-4 border-t border-gray-100 mt-4">
                        <button onclick="handleLogout()" class="w-full border border-red-500 text-red-500 py-3 rounded-lg font-bold hover:bg-red-50 transition">
                            ç™»å‡ºå¸³è™Ÿ
                        </button>
                    </div>
                </div>

                <!-- ç™»å…¥ç¾æœ‰å¸³è™Ÿ (åŒ¿åæˆ–æœªç™»å…¥æ™‚éƒ½é¡¯ç¤º) -->
                <div id="login-section" class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="font-bold text-gray-800 mb-4 text-lg">ç™»å…¥ç¾æœ‰å¸³è™Ÿ (åˆ‡æ›å¸³è™Ÿ)</h3>
                    <p class="text-sm text-gray-500 mb-4">å¦‚æœæ‚¨å·²ç¶“æœ‰æ°¸ä¹…å¸³è™Ÿï¼Œè«‹åœ¨æ­¤ç™»å…¥ä»¥å­˜å–æ‚¨çš„èˆŠè³‡æ–™ã€‚</p>
                    <form id="login-form" class="space-y-3">
                        <input type="email" id="in-email" placeholder="Email" class="w-full p-3 border rounded-lg" required>
                        <input type="password" id="in-password" placeholder="å¯†ç¢¼" class="w-full p-3 border rounded-lg" required>
                        <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700">ç™»å…¥</button>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <!-- å­¸ç”Ÿè­‰æ¨¡æ…‹æ¡† -->
    <div id="id-card-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal()">
        <div class="relative w-full max-w-[380px]" onclick="event.stopPropagation()">
            <div class="id-card animate-[zoomIn_0.3s_ease-out]">
                <div class="id-header">
                    <div class="id-title">æ˜é–€ä¸­æ–‡</div>
                    <div class="id-slogan">DSE VICTORY</div>
                </div>
                <div class="id-body">
                    <h2 id="modal-name" class="student-name">STUDENT</h2>
                    <div id="modal-id" class="student-id-badge">ID: ----</div>
                    <div class="flex justify-center">
                        <div id="modal-qrcode" class="qr-frame"></div>
                    </div>
                    <p class="mt-4 text-xs text-gray-400 font-mono">SCAN TO CHECK-IN</p>
                </div>
            </div>
            <button onclick="closeModal()" class="mt-4 w-full bg-white/20 text-white py-3 rounded-xl font-bold backdrop-blur-md hover:bg-white/30 transition">
                é—œé–‰
            </button>
        </div>
    </div>

    <!-- éŒ¯èª¤/æç¤ºæ¨¡æ…‹æ¡† -->
    <div id="alert-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl">
            <h3 id="alert-title" class="text-lg font-bold mb-2">æç¤º</h3>
            <p id="alert-msg" class="text-gray-600 mb-4">å…§å®¹</p>
            <button onclick="document.getElementById('alert-modal').classList.add('hidden')" class="w-full bg-gray-800 text-white py-2 rounded-lg font-bold">ç¢ºå®š</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithEmailAndPassword, 
            linkWithCredential, 
            EmailAuthProvider,
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, onSnapshot, query, orderBy, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "AIzaSyAFM-0Hi6J1dtWltpCsGGObBxWtO2ZRRpY",
            authDomain: "dsevictory-attendance-system.firebaseapp.com",
            projectId: "dsevictory-attendance-system",
            storageBucket: "dsevictory-attendance-system.firebasestorage.app",
            messagingSenderId: "796565425082",
            appId: "1:796565425082:web:08babee5be08c0ffdc2b83",
            measurementId: "G-4BCRYC7KKT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let rosterMap = {}; 
        let videoStream = null;
        let cameraFacingMode = 'environment'; 
        let scanActive = false;

        // --- å¸³æˆ¶ç®¡ç†èˆ‡ç‹€æ…‹ç›£è½ ---
        onAuthStateChanged(auth, (user) => {
            const statusText = document.getElementById('auth-status');
            const accountStatusText = document.getElementById('account-status-text');
            const accountUidText = document.getElementById('account-uid-text');
            const upgradeSection = document.getElementById('upgrade-section');
            const loginSection = document.getElementById('login-section');
            const logoutSection = document.getElementById('logout-section');

            if (user) {
                currentUser = user;
                statusText.textContent = "ç³»çµ±å·²é€£ç·š";
                statusText.className = "text-xs px-3 py-1 rounded-full bg-green-100 text-green-700 inline-block font-bold";
                accountUidText.textContent = `UID: ${user.uid}`;
                logoutSection.classList.remove('hidden');

                if (user.isAnonymous) {
                    // åŒ¿åç”¨æˆ¶ï¼šé¡¯ç¤ºå‡ç´š + é¡¯ç¤ºç™»å…¥(ç”¨æ–¼åˆ‡æ›)
                    accountStatusText.textContent = "åŒ¿åè¨ªå®¢";
                    upgradeSection.classList.remove('hidden');
                    loginSection.classList.remove('hidden'); // Fix: åŒ¿åæ™‚ä»å¯ç™»å…¥èˆŠå¸³è™Ÿ
                } else {
                    // æ°¸ä¹…ç”¨æˆ¶ï¼šéš±è—å‡ç´šå’Œç™»å…¥æ¡†
                    accountStatusText.textContent = "æ°¸ä¹…å¸³è™Ÿ (å·²ç™»å…¥)";
                    upgradeSection.classList.add('hidden');
                    loginSection.classList.add('hidden');
                }

                initListeners();
            } else {
                // æœªç™»å…¥ï¼šå˜—è©¦åŒ¿å
                currentUser = null;
                statusText.textContent = "æœªç™»å…¥";
                accountStatusText.textContent = "æœªç™»å…¥";
                upgradeSection.classList.add('hidden');
                logoutSection.classList.add('hidden');
                loginSection.classList.remove('hidden');

                signInAnonymously(auth).catch(err => console.error("Anon Auth Error", err));
            }
        });

        // ç™»å…¥
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('in-email').value;
            const password = document.getElementById('in-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showAlert("æˆåŠŸ", "ç™»å…¥æˆåŠŸï¼è³‡æ–™å·²åŒæ­¥ã€‚");
                document.getElementById('login-form').reset();
            } catch (error) {
                showAlert("ç™»å…¥å¤±æ•—", error.message);
            }
        });

        // å‡ç´š
        document.getElementById('upgrade-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('up-email').value;
            const password = document.getElementById('up-password').value;
            const credential = EmailAuthProvider.credential(email, password);
            try {
                await linkWithCredential(auth.currentUser, credential);
                showAlert("æˆåŠŸ", "å¸³è™Ÿå‡ç´šæˆåŠŸï¼");
                document.getElementById('upgrade-form').reset();
            } catch (error) {
                showAlert("éŒ¯èª¤", error.message);
            }
        });

        // ç™»å‡º
        window.handleLogout = () => {
            signOut(auth).then(() => window.location.reload());
        };

        // --- è³‡æ–™åº«ç›£è½ ---
        function initListeners() {
            const rosterRef = collection(db, `users/${currentUser.uid}/roster`);
            onSnapshot(query(rosterRef, orderBy('createdAt', 'desc')), (snapshot) => {
                const listEl = document.getElementById('roster-list');
                listEl.innerHTML = '';
                rosterMap = {}; 
                if (snapshot.empty) {
                    listEl.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-400">è«‹æ–°å¢å­¸ç”Ÿ</td></tr>';
                    return;
                }
                snapshot.forEach(docSnap => {
                    const s = docSnap.data();
                    const id = docSnap.id;
                    rosterMap[id] = s.name;
                    const row = document.createElement('tr');
                    row.className = "border-b hover:bg-gray-50";
                    row.innerHTML = `<td class="p-4 font-mono font-bold text-gray-700">${id}</td><td class="p-4 font-bold" style="color:var(--dse-dark-blue)">${s.name}</td><td class="p-4 text-right"><button onclick="window.openIdCard('${s.name}','${id}')" class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded text-xs font-bold mr-2">è­‰ä»¶</button><button onclick="window.deleteStudent('${id}')" class="text-red-400 text-xs font-bold">åˆªé™¤</button></td>`;
                    listEl.appendChild(row);
                });
            });

            const recordsRef = collection(db, `users/${currentUser.uid}/records`);
            onSnapshot(query(recordsRef, orderBy('timestamp', 'desc')), (snapshot) => {
                const listEl = document.getElementById('records-list');
                listEl.innerHTML = '';
                if (snapshot.empty) {
                    listEl.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-400">å°šç„¡è¨˜éŒ„</td></tr>';
                    return;
                }
                snapshot.forEach(docSnap => {
                    const r = docSnap.data();
                    const time = r.timestamp ? new Date(r.timestamp.toDate()).toLocaleString() : '';
                    const row = document.createElement('tr');
                    row.className = "border-b hover:bg-gray-50";
                    row.innerHTML = `<td class="p-4 text-sm text-gray-500">${time}</td><td class="p-4 font-bold text-gray-800">${r.studentName}</td><td class="p-4 font-mono text-sm text-gray-500">${r.studentId}</td>`;
                    listEl.appendChild(row);
                });
            });
        }

        // --- æƒæå™¨ ---
        const video = document.getElementById('video');
        const canvas = document.getElementById('scan-canvas');
        const ctx = canvas.getContext('2d');
        const overlay = document.getElementById('camera-loading');
        const errorEl = document.getElementById('camera-error');

        async function startCamera() {
            if (videoStream) videoStream.getTracks().forEach(t => t.stop());
            errorEl.classList.add('hidden');
            overlay.classList.remove('hidden');

            try {
                const constraints = { 
                    video: { 
                        facingMode: cameraFacingMode,
                        width: { ideal: 1280 }, height: { ideal: 720 }
                    } 
                };
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = videoStream;
                video.onloadedmetadata = () => {
                    video.play();
                    overlay.classList.add('hidden');
                    scanActive = true;
                    requestAnimationFrame(tick);
                };
            } catch (err) {
                console.error(err);
                errorEl.innerHTML = "ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿã€‚è«‹ç¢ºèª HTTPS åŠæ¬Šé™ã€‚";
                errorEl.classList.remove('hidden');
                overlay.classList.add('hidden');
            }
        }

        function tick() {
            if (!scanActive) return;
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
                if (code && code.data) handleScanSuccess(code.data);
            }
            requestAnimationFrame(tick);
        }

        let lastScanned = null;
        let lastTime = 0;

        async function handleScanSuccess(data) {
            if (data === lastScanned && Date.now() - lastTime < 3000) return;
            lastScanned = data;
            lastTime = Date.now();

            const name = rosterMap[data];
            const feedback = document.getElementById('scan-result-container');
            
            if (name) {
                feedback.className = "mt-4 p-4 rounded-xl bg-green-100 border border-green-300 text-center";
                feedback.innerHTML = `<div class="text-3xl">âœ…</div><div class="font-bold text-green-800 text-lg">${name}</div><div class="text-sm text-green-600">${data}</div>`;
                
                try {
                    await addDoc(collection(db, `users/${currentUser.uid}/records`), {
                        studentId: data, studentName: name, timestamp: serverTimestamp()
                    });
                } catch(e) { alert("å¯«å…¥å¤±æ•—"); }

                setTimeout(() => {
                    feedback.className = "mt-4 p-4 rounded-xl bg-gray-50 border border-gray-200 text-center";
                    feedback.innerHTML = '<p class="text-gray-500 font-medium">è«‹å°‡å­¸ç”Ÿè­‰ QR Code å°æº–æ¡†å…§</p>';
                }, 2000);
            } else {
                feedback.className = "mt-4 p-4 rounded-xl bg-red-100 border border-red-300 text-center";
                feedback.innerHTML = `<div class="text-2xl">âŒ</div><div class="font-bold text-red-800">ç„¡æ•ˆå­¸ç”Ÿè­‰</div><div class="text-xs text-red-600">${data}</div>`;
            }
        }

        // --- å…¨å±€å‡½å¼ ---
        window.switchTab = (id) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
            document.querySelectorAll('button[id^="tab-"]').forEach(btn => {
                btn.className = "flex-1 py-3 px-4 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-100 transition-colors";
                btn.style.backgroundColor = "";
                btn.style.color = "";
            });
            const active = document.getElementById(`tab-${id}`);
            active.className = "flex-1 py-3 px-4 rounded-lg text-sm font-bold text-white transition-colors";
            active.style.backgroundColor = "var(--dse-dark-blue)";

            if (id === 'scanner') { scanActive = true; startCamera(); } 
            else { scanActive = false; if(videoStream) videoStream.getTracks().forEach(t=>t.stop()); }
        };

        window.toggleCamera = () => {
            cameraFacingMode = (cameraFacingMode === 'environment') ? 'user' : 'environment';
            startCamera();
        };

        window.openIdCard = (name, id) => {
            document.getElementById('modal-name').textContent = name;
            document.getElementById('modal-id').textContent = `ID: ${id}`;
            document.getElementById('id-card-modal').classList.remove('hidden');
            document.getElementById('modal-qrcode').innerHTML = '';
            new QRCode(document.getElementById('modal-qrcode'), {
                text: id, width: 160, height: 160, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H
            });
        };

        window.closeModal = () => document.getElementById('id-card-modal').classList.add('hidden');
        
        window.deleteStudent = async (id) => {
            if(confirm("ç¢ºå®šåˆªé™¤?")) await deleteDoc(doc(db, `users/${currentUser.uid}/roster`, id));
        };

        window.exportCSV = () => {
            const rows = document.querySelectorAll('#records-list tr');
            if(rows.length===0 || rows[0].innerText.includes('å°šç„¡')) return showAlert("æç¤º","ç„¡è³‡æ–™");
            let csv = "\uFEFFæ™‚é–“,å§“å,ç·¨è™Ÿ\n";
            rows.forEach(r => {
                const c = r.querySelectorAll('td');
                if(c.length===3) csv += `${c[0].innerText},${c[1].innerText},${c[2].innerText}\n`;
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], {type:"text/csv;charset=utf-8;"}));
            link.download = "é»åè¨˜éŒ„.csv";
            link.click();
        };

        document.getElementById('add-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('input-id').value.trim();
            const name = document.getElementById('input-name').value.trim();
            if(!id || !name) return;
            try {
                await setDoc(doc(db, `users/${currentUser.uid}/roster`, id), { name, createdAt: serverTimestamp() });
                document.getElementById('add-student-form').reset();
                showAlert("æˆåŠŸ", "å·²æ–°å¢");
            } catch(e) { showAlert("éŒ¯èª¤", "æ–°å¢å¤±æ•—"); }
        });

        function showAlert(t, m) {
            document.getElementById('alert-title').textContent = t;
            document.getElementById('alert-msg').textContent = m;
            document.getElementById('alert-modal').classList.remove('hidden');
        }

        // å•Ÿå‹•
        window.switchTab('scanner');
    </script>
</body>
</html>
