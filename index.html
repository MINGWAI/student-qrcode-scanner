<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜é–€ä¸­æ–‡ - é»åç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ jsQR (æƒæ) -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.0.4/dist/jsQR.min.js"></script>
    <!-- è¼‰å…¥ qrcode.js (ç”Ÿæˆ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- å¼•å…¥è¥¯ç·šå­—é«”å¢åŠ é«˜ç´šæ„Ÿ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        /* å“ç‰Œå­—é«” */
        .font-serif-tc { font-family: 'Noto Serif TC', serif; }

        /* æƒæå™¨å®¹å™¨ */
        .scanner-wrapper {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 75%; 
            background-color: #000;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .scanner-wrapper video, .scanner-wrapper canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;
        }

        /* æƒæç·šå‹•ç•« */
        .scan-line {
            position: absolute; width: 100%; height: 2px; background: #D4AF37;
            box-shadow: 0 0 4px #D4AF37; top: 0; left: 0;
            animation: scan 2s infinite linear; z-index: 10;
        }
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        .scan-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 70%; height: 70%; border: 1px solid rgba(212, 175, 55, 0.5);
            border-radius: 12px; box-shadow: 0 0 0 4000px rgba(0, 32, 96, 0.8); z-index: 5;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-24">

    <div id="app" class="max-w-4xl mx-auto p-4">
        
        <!-- é ‚éƒ¨å“ç‰Œ Header -->
        <header class="mb-6 bg-white p-6 rounded-2xl shadow-sm border-t-4 border-[#D4AF37]">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-serif-tc font-bold text-[#002060]">æ˜é–€ä¸­æ–‡</h1>
                    <p class="text-xs text-gray-400 mt-1 tracking-widest">DSE VICTORY</p>
                </div>
                <!-- é€£ç·šç‹€æ…‹æŒ‡ç¤ºç‡ˆèˆ‡ç™»å…¥ç‹€æ…‹ -->
                <div class="flex flex-col items-end gap-1">
                    <div class="flex items-center gap-2">
                        <span id="status-text" class="text-xs text-gray-400">ç™»å…¥ä¸­...</span>
                        <div id="auth-indicator" class="h-3 w-3 rounded-full bg-gray-300 animate-pulse"></div>
                    </div>
                    <div id="auth-actions">
                        <!-- ç™»å…¥/ç™»å‡ºæŒ‰éˆ•æœƒåœ¨é€™è£¡å‹•æ…‹é¡¯ç¤º -->
                    </div>
                </div>
            </div>
        </header>

        <!-- åˆ‡æ›åˆ†é  -->
        <div id="main-tabs" class="hidden flex p-1 mb-6 bg-gray-200 rounded-xl">
            <button onclick="switchTab('scanner')" id="tab-scanner" class="flex-1 py-3 text-sm font-bold rounded-lg transition-all text-[#002060] bg-white shadow">
                ğŸ“· æƒæ
            </button>
            <button onclick="switchTab('roster')" id="tab-roster" class="flex-1 py-3 text-sm font-medium rounded-lg text-gray-500 hover:text-[#002060]">
                ğŸ‘¥ åå–®
            </button>
            <button onclick="switchTab('records')" id="tab-records" class="flex-1 py-3 text-sm font-medium rounded-lg text-gray-500 hover:text-[#002060]">
                ğŸ“Š è¨˜éŒ„
            </button>
        </div>

        <!-- 1. æƒæå™¨é é¢ -->
        <div id="content-scanner" class="tab-content">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                <div class="scanner-wrapper mb-4">
                    <video id="video" playsinline muted autoplay></video>
                    <canvas id="canvas" class="hidden"></canvas>
                    <div class="scan-overlay"><div class="scan-line"></div></div>
                    
                    <!-- æ¬Šé™éŒ¯èª¤æç¤º -->
                    <div id="camera-error" class="absolute inset-0 bg-[#002060] text-white flex flex-col items-center justify-center p-6 text-center z-20 hidden">
                        <h3 class="font-serif-tc font-bold text-xl mb-2 text-[#D4AF37]">ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ</h3>
                        <p class="text-sm text-gray-300 mb-6 leading-relaxed">
                            è«‹ç¢ºèªæ‚¨æ˜¯ä½¿ç”¨ HTTPS ç¶²å€é–‹å•Ÿï¼Œ<br>ä¸¦å·²åœ¨è¨­å®šä¸­å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚
                        </p>
                        <button onclick="startCamera()" class="px-6 py-2 bg-[#D4AF37] text-[#002060] font-bold rounded-full">é‡è©¦</button>
                    </div>
                </div>
                <div id="scan-feedback" class="text-center p-3 rounded-lg bg-blue-50 text-[#002060] text-sm font-medium">
                    ç­‰å¾…æƒæ...
                </div>
            </div>
        </div>

        <!-- 2. åå–®ç®¡ç†é é¢ -->
        <div id="content-roster" class="tab-content hidden">
            <!-- æ–°å¢å€å¡Š -->
            <div class="bg-white p-6 rounded-2xl shadow-sm mb-6 border-l-4 border-[#002060]">
                <h2 class="font-serif-tc font-bold text-lg text-[#002060] mb-4">æ–°å¢å­¸ç”Ÿè³‡æ–™</h2>
                <form id="add-student-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">å­¸è™Ÿ</label>
                            <input type="text" id="studentId" required class="w-full mt-1 p-3 bg-gray-50 border-gray-200 rounded-lg focus:border-[#002060] outline-none border" placeholder="S001">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">å§“å</label>
                            <input type="text" id="studentName" required class="w-full mt-1 p-3 bg-gray-50 border-gray-200 rounded-lg focus:border-[#002060] outline-none border" placeholder="å§“å">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">é›»è©±</label>
                        <input type="tel" id="studentPhone" class="w-full mt-1 p-3 bg-gray-50 border-gray-200 rounded-lg focus:border-[#002060] outline-none border" placeholder="0912-345-678">
                    </div>
                    <button type="submit" class="w-full py-3 bg-[#002060] text-white font-bold rounded-lg shadow-lg active:scale-95 transition-all">
                        å„²å­˜è³‡æ–™
                    </button>
                </form>
            </div>

            <!-- åˆ—è¡¨å€å¡Š -->
            <div class="space-y-3" id="roster-list">
                <!-- å‹•æ…‹ç”Ÿæˆå­¸ç”Ÿå¡ç‰‡ -->
                <div class="text-center py-10 text-gray-400">è«‹å…ˆç™»å…¥ä»¥è¼‰å…¥åå–®...</div>
            </div>
        </div>

        <!-- 3. è¨˜éŒ„é é¢ -->
        <div id="content-records" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-serif-tc font-bold text-[#002060] text-lg">ä»Šæ—¥è¨˜éŒ„</h2>
                <button onclick="exportToCSV()" class="px-4 py-2 bg-[#002060] text-white text-xs font-bold rounded-lg shadow hover:bg-blue-900">
                    åŒ¯å‡º Excel
                </button>
            </div>
            <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-500 font-bold">
                        <tr><th class="p-4">æ™‚é–“</th><th class="p-4">å­¸ç”Ÿ</th><th class="p-4">ç‹€æ…‹</th></tr>
                    </thead>
                    <tbody id="records-tbody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- å­¸ç”Ÿè­‰é è¦½æ¨¡æ…‹æ¡† -->
    <div id="card-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-[#002060]/90 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-4 bg-gray-100 border-b flex justify-between items-center">
                <h3 class="font-bold text-[#002060]">å­¸ç”Ÿè­‰é è¦½</h3>
                <button onclick="closeCardModal()" class="text-gray-500 hover:text-red-500 text-2xl">&times;</button>
            </div>
            
            <div class="flex-1 overflow-auto p-4 flex justify-center bg-gray-200">
                <!-- Canvas å°‡è¢«æ¸²æŸ“åœ¨é€™è£¡ -->
                <canvas id="id-card-canvas" class="shadow-xl rounded-lg max-w-full h-auto"></canvas>
            </div>

            <div class="p-4 bg-white border-t space-y-2">
                <p class="text-xs text-center text-gray-400 mb-2">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ä¸‹è¼‰åœ–ç‰‡</p>
                <button onclick="downloadCard()" class="w-full py-3 bg-[#D4AF37] text-[#002060] font-bold rounded-xl shadow-lg hover:bg-yellow-500">
                    ä¸‹è¼‰å­¸ç”Ÿè­‰ (åœ–ç‰‡)
                </button>
            </div>
        </div>
    </div>

    <!-- ç™»å…¥/è¨»å†Š æ¨¡æ…‹æ¡† (æ–°å¢) -->
    <div id="auth-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4 bg-[#002060]/90 backdrop-blur-sm">
        <div class="bg-white rounded-xl p-8 shadow-2xl max-w-md w-full">
            <h3 class="font-serif-tc font-bold text-2xl text-[#002060] mb-4 text-center" id="auth-title">ç™»å…¥ç³»çµ±</h3>
            <p class="text-sm text-gray-500 mb-6 text-center">è«‹ä½¿ç”¨æ‚¨çš„æ•™å¸«å¸³è™Ÿç™»å…¥æˆ–è¨»å†Šã€‚åªæœ‰ç™»å…¥æ‰èƒ½å­˜å–è³‡æ–™åº«ã€‚</p>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">é›»å­éƒµä»¶</label>
                    <input type="email" id="auth-email" required class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:ring-[#002060] focus:border-[#002060] outline-none" placeholder="your@email.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">å¯†ç¢¼</label>
                    <input type="password" id="auth-password" required class="w-full mt-1 p-3 border border-gray-300 rounded-lg focus:ring-[#002060] focus:border-[#002060] outline-none" placeholder="è‡³å°‘å…­ä½æ•¸">
                </div>
                <p id="auth-error-message" class="text-red-500 text-sm hidden"></p>
                
                <div class="flex gap-4">
                    <button type="button" onclick="handleAuth(true)" id="register-btn" class="flex-1 py-3 bg-[#D4AF37] text-[#002060] font-bold rounded-lg shadow active:scale-95 transition-all">
                        è¨»å†Šæ–°å¸³è™Ÿ
                    </button>
                    <button type="button" onclick="handleAuth(false)" id="login-btn" class="flex-1 py-3 bg-[#002060] text-white font-bold rounded-lg shadow active:scale-95 transition-all">
                        ç™»å…¥
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- éš±è—çš„ QR Code ç”Ÿæˆå€ (ç”¨æ–¼ Canvas ç¹ªè£½) -->
    <div id="hidden-qr" class="hidden"></div>

    <!-- é€šç”¨æç¤ºæ¡† -->
    <div id="modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/40">
        <div class="bg-white rounded-xl p-6 shadow-xl max-w-xs w-full text-center">
            <h3 id="modal-title" class="font-bold text-lg mb-2">æç¤º</h3>
            <p id="modal-message" class="text-gray-600 mb-4 text-sm"></p>
            <button onclick="document.getElementById('modal').classList.add('hidden')" class="w-full py-2 bg-gray-100 rounded-lg font-bold">é—œé–‰</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // åŒ¯å…¥ Email/Password ç›¸é—œçš„å‡½æ•¸
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, deleteDoc, onSnapshot, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =======================================================
        // ã€é‡è¦ã€‘è«‹å°‡ä¸‹æ–¹çš„ firebaseConfig ç‰©ä»¶æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„è¨­å®š
        // =======================================================
        const firebaseConfig = {
            // è«‹åœ¨æ­¤è™•è²¼ä¸Šæ‚¨çš„ Firebase è¨­å®šä»£ç¢¼
            // ä¾‹å¦‚:
            // apiKey: "AIzaSyD...",
            // authDomain: "your-project.firebaseapp.com",
            // projectId: "your-project-id",
            // storageBucket: "your-project.appspot.com",
            // messagingSenderId: "123456789",
            // appId: "1:123456789:web:abcdef"
        };
        // =======================================================

        const appId = 'student-system'; // å›ºå®š App ID
        
        let db, auth, userId;
        let rosterMap = {}; 

        // --- ç™»å…¥/è¨»å†Š è™•ç† ---
        window.handleAuth = async (isRegister) => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorElement = document.getElementById('auth-error-message');
            errorElement.classList.add('hidden');
            
            if (!email || password.length < 6) {
                errorElement.textContent = "è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»éƒµåœ°å€å’Œè‡³å°‘å…­ä½æ•¸çš„å¯†ç¢¼ã€‚";
                errorElement.classList.remove('hidden');
                return;
            }

            try {
                if (isRegister) {
                    // è¨»å†Š
                    await createUserWithEmailAndPassword(auth, email, password);
                    showModal('æˆåŠŸ', 'è¨»å†ŠæˆåŠŸï¼æ‚¨å·²è‡ªå‹•ç™»å…¥ã€‚');
                } else {
                    // ç™»å…¥
                    await signInWithEmailAndPassword(auth, email, password);
                    showModal('æˆåŠŸ', 'ç™»å…¥æˆåŠŸï¼');
                }
                document.getElementById('auth-modal').classList.add('hidden');
            } catch (error) {
                console.error(error);
                let msg = 'ç™»å…¥/è¨»å†Šå¤±æ•—ã€‚';
                if (error.code === 'auth/email-already-in-use') {
                    msg = 'æ­¤é›»éƒµå·²è¢«è¨»å†Šï¼Œè«‹ç›´æ¥ç™»å…¥æˆ–ä½¿ç”¨å…¶ä»–é›»éƒµã€‚';
                } else if (error.code === 'auth/invalid-credential') {
                    msg = 'é›»éƒµæˆ–å¯†ç¢¼éŒ¯èª¤ã€‚';
                } else if (error.code === 'auth/weak-password') {
                    msg = 'å¯†ç¢¼å¼·åº¦å¤ªå¼±ï¼Œè«‹ä½¿ç”¨è‡³å°‘å…­ä½æ•¸ã€‚';
                }
                errorElement.textContent = msg;
                errorElement.classList.remove('hidden');
            }
        }

        window.handleSignOut = async () => {
            if (!confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿç™»å‡ºå¾Œå°‡ç„¡æ³•å­˜å–è³‡æ–™ã€‚')) return;
            await signOut(auth);
        }


        // --- åˆå§‹åŒ– ---
        async function initApp() {
            // æª¢æŸ¥æ˜¯å¦å·²è¨­å®š Config
            if (!firebaseConfig.apiKey) {
                return showModal('âš ï¸ è¨­å®šæœªå®Œæˆ', 'è«‹åƒè€ƒæ•™å­¸ï¼Œå°‡ Firebase Config è²¼å…¥ index.html ç¨‹å¼ç¢¼ä¸­ã€‚');
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, user => {
                const indicator = document.getElementById('auth-indicator');
                const statusText = document.getElementById('status-text');
                const authActions = document.getElementById('auth-actions');
                const mainTabs = document.getElementById('main-tabs');
                
                // æ¸…é™¤ä¹‹å‰çš„ç›£è½å™¨å’Œç‹€æ…‹
                userId = null;
                authActions.innerHTML = '';
                mainTabs.classList.add('hidden');

                if (user) {
                    // å·²ç™»å…¥
                    userId = user.uid;
                    indicator.classList.remove('bg-gray-300', 'animate-pulse', 'bg-red-500');
                    indicator.classList.add('bg-green-500');
                    statusText.textContent = user.email || "å·²ç™»å…¥";
                    statusText.classList.add('text-green-600');
                    authActions.innerHTML = `<button onclick="handleSignOut()" class="mt-1 px-3 py-1 bg-red-100 text-red-600 text-xs font-bold rounded-lg hover:bg-red-200">ç™»å‡º</button>`;
                    mainTabs.classList.remove('hidden');
                    document.getElementById('auth-modal').classList.add('hidden');
                    startListeners(); // ç™»å…¥å¾Œæ‰é–‹å§‹ç›£è½è³‡æ–™åº«
                } else {
                    // æœªç™»å…¥
                    indicator.classList.remove('bg-gray-300', 'animate-pulse', 'bg-green-500');
                    indicator.classList.add('bg-red-500');
                    statusText.textContent = "æœªç™»å…¥";
                    statusText.classList.add('text-red-600');
                    authActions.innerHTML = `<button onclick="document.getElementById('auth-modal').classList.remove('hidden')" class="mt-1 px-3 py-1 bg-[#002060] text-white text-xs font-bold rounded-lg hover:bg-blue-900">ç™»å…¥</button>`;
                    document.getElementById('roster-list').innerHTML = '<div class="text-center py-10 text-gray-400">è«‹å…ˆç™»å…¥ä»¥è¼‰å…¥åå–®...</div>';
                    document.getElementById('records-tbody').innerHTML = '<tr><td colspan="3" class="p-6 text-center text-gray-400">è«‹å…ˆç™»å…¥</td></tr>';
                    document.getElementById('auth-modal').classList.remove('hidden'); // é¡¯ç¤ºç™»å…¥æ¡†
                }
            });
        }

        function startListeners() {
            // ç¢ºä¿åªåœ¨ç™»å…¥ç‹€æ…‹ä¸‹åŸ·è¡Œ
            if (!userId) return; 

            // ç›£è½åå–®
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/roster`), snapshot => {
                const students = [];
                rosterMap = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    students.push(data);
                    rosterMap[data.studentId] = data;
                });
                renderRoster(students);
            });
            // ç›£è½è¨˜éŒ„
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/attendance_records`), snapshot => {
                const records = [];
                snapshot.forEach(doc => records.push(doc.data()));
                records.sort((a, b) => (b.checkInTime?.seconds || 0) - (a.checkInTime?.seconds || 0));
                renderRecords(records);
            });
        }

        // --- æ¸²æŸ“åå–®åˆ—è¡¨ ---
        function renderRoster(students) {
            const list = document.getElementById('roster-list');
            if (students.length === 0) {
                list.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">æš«ç„¡å­¸ç”Ÿè³‡æ–™</div>';
                return;
            }
            list.innerHTML = students.map(s => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="bg-blue-50 text-[#002060] font-mono text-xs px-2 py-1 rounded font-bold">${s.studentId}</span>
                            <span class="font-bold text-gray-800">${s.name}</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">${s.phone || 'ç„¡é›»è©±'}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.previewCard('${s.studentId}', '${s.name}', '${s.phone||''}')" class="px-3 py-2 bg-[#002060] text-white text-xs font-bold rounded-lg shadow hover:bg-blue-900">
                            å­¸ç”Ÿè­‰
                        </button>
                        <button onclick="window.delStudent('${s.studentId}')" class="p-2 text-red-400 hover:text-red-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderRecords(records) {
            const tbody = document.getElementById('records-tbody');
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="p-6 text-center text-gray-400">å°šç„¡è¨˜éŒ„</td></tr>';
                return;
            }
            tbody.innerHTML = records.map(r => {
                const date = r.checkInTime ? new Date(r.checkInTime.seconds * 1000) : new Date();
                return `
                <tr class="border-b border-gray-50">
                    <td class="p-4">
                        <div class="font-bold text-gray-800">${date.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'})}</div>
                        <div class="text-xs text-gray-400">${date.toLocaleDateString('zh-TW')}</div>
                    </td>
                    <td class="p-4">
                        <div class="font-bold text-[#002060]">${r.name}</div>
                        <div class="text-xs text-gray-400">${r.studentId}</div>
                    </td>
                    <td class="p-4"><span class="text-green-500 font-bold">âœ”</span></td>
                </tr>
            `}).join('');
        }

        // --- æ¥­å‹™é‚è¼¯ ---
        document.getElementById('add-student-form').addEventListener('submit', async e => {
            e.preventDefault();
            if (!userId) return showModal('éŒ¯èª¤', 'è«‹å…ˆç™»å…¥ç³»çµ±');
            const id = document.getElementById('studentId').value.trim();
            const name = document.getElementById('studentName').value.trim();
            const phone = document.getElementById('studentPhone').value.trim();
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/roster`, id), { studentId: id, name, phone });
                showModal('æˆåŠŸ', `å·²æ–°å¢ï¼š${name}`);
                e.target.reset();
            } catch (err) { console.error(err); showModal('éŒ¯èª¤', `å„²å­˜å¤±æ•—: ${err.message}`); }
        });

        window.delStudent = async (id) => {
            if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            try { await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/roster`, id)); } catch(e){}
        };

        // --- æ ¸å¿ƒï¼šç”¢ç”Ÿæ ¼èª¿å­¸ç”Ÿè­‰ (Canvas) ---
        window.previewCard = (id, name, phone) => {
            const modal = document.getElementById('card-modal');
            const canvas = document.getElementById('id-card-canvas');
            const ctx = canvas.getContext('2d');
            
            const W = 600;
            const H = 1066;
            canvas.width = W;
            canvas.height = H;

            // 1. ç¹ªè£½èƒŒæ™¯ (ç™½è‰²)
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(0, 0, W, H);

            // 2. ç¹ªè£½é ‚éƒ¨ Header (æ·±è—è‰²)
            const headerH = 200;
            ctx.fillStyle = "#002060";
            ctx.fillRect(0, 0, W, headerH);

            // 3. ç¹ªè£½ Logo æ–‡å­— (é‡‘è‰²)
            ctx.fillStyle = "#D4AF37";
            ctx.font = "bold 60px 'Noto Serif TC', serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("æ˜é–€ä¸­æ–‡", W/2, headerH/2 - 20);
            
            ctx.font = "20px sans-serif";
            ctx.letterSpacing = "4px";
            ctx.fillText("DSE VICTORY", W/2, headerH/2 + 40);

            // 4. ç¹ªè£½å­¸ç”Ÿè³‡è¨Š (ä¸­é–“)
            // å§“å
            ctx.fillStyle = "#002060";
            ctx.font = "bold 80px 'Noto Serif TC', serif";
            ctx.fillText(name, W/2, headerH + 150);
            
            // è£é£¾ç·š
            ctx.strokeStyle = "#D4AF37";
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(W/2 - 50, headerH + 200);
            ctx.lineTo(W/2 + 50, headerH + 200);
            ctx.stroke();

            // é›»è©±
            ctx.fillStyle = "#666666";
            ctx.font = "30px sans-serif";
            ctx.fillText(phone || "", W/2, headerH + 250);
            ctx.fillText(`ID: ${id}`, W/2, headerH + 300);

            // 5. ç”Ÿæˆ QR Code ä¸¦ç¹ªè£½åˆ° Canvas åº•éƒ¨
            // å…ˆåœ¨éš±è—å€ç”Ÿæˆ QR
            const qrContainer = document.getElementById('hidden-qr');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: id,
                width: 400, // ç”¢ç”Ÿå¤§ä¸€é»
                height: 400,
                colorDark : "#002060", // QR Code ç”¨æ·±è—è‰²
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            // ç­‰å¾… QR code åœ–ç‰‡ç”Ÿæˆå¾Œç¹ªè£½
            setTimeout(() => {
                const qrImg = qrContainer.querySelector('img');
                if (qrImg && qrImg.src) {
                    const img = new Image();
                    img.onload = () => {
                        // QR Code å€åŸŸ (åº•éƒ¨ 40%)
                        const qrSize = W * 0.6; 
                        const qrX = (W - qrSize) / 2;
                        const qrY = H - qrSize - 100; 

                        // ç¹ªè£½ QR é‚Šæ¡† (é‡‘è‰²)
                        ctx.strokeStyle = "#D4AF37";
                        ctx.lineWidth = 10;
                        ctx.strokeRect(qrX - 20, qrY - 20, qrSize + 40, qrSize + 40);

                        ctx.drawImage(img, qrX, qrY, qrSize, qrSize);
                    };
                    img.src = qrImg.src;
                }
            }, 100);

            // åº•éƒ¨è£é£¾æ¢
            ctx.fillStyle = "#D4AF37";
            ctx.fillRect(0, H - 20, W, 20);

            modal.classList.remove('hidden');
        };

        window.closeCardModal = () => document.getElementById('card-modal').classList.add('hidden');

        window.downloadCard = () => {
            const canvas = document.getElementById('id-card-canvas');
            const link = document.createElement('a');
            link.download = `å­¸ç”Ÿè­‰_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        };

        // --- æƒæèˆ‡å…¶ä»–é‚è¼¯ ---
        let videoStream;
        let isScanning = false;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        window.startCamera = async () => {
            document.getElementById('camera-error').classList.add('hidden');
            try {
                // ä½¿ç”¨å‰ç½®é¡é ­
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                await video.play();
                isScanning = true;
                requestAnimationFrame(scanTick);
            } catch (err) {
                console.error(err);
                document.getElementById('camera-error').classList.remove('hidden');
            }
        };

        window.stopCamera = () => {
            isScanning = false;
            if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
        };

        let lastCode, lastTime = 0;
        function scanTick() {
            if (!isScanning) return;
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
                
                if (code) {
                    const now = Date.now();
                    // 3ç§’å…§åŒä¸€ QR Code ä¸é‡è¤‡é»å
                    if (code.data !== lastCode || (now - lastTime > 3000)) { 
                        lastCode = code.data;
                        lastTime = now;
                        handleScan(code.data);
                    }
                }
            }
            requestAnimationFrame(scanTick);
        }

        async function handleScan(code) {
            const feedback = document.getElementById('scan-feedback');
            if (!rosterMap[code]) {
                feedback.textContent = `âŒ ç„¡æ•ˆä»£ç¢¼: ${code}`;
                feedback.className = "text-center p-3 rounded-lg bg-red-100 text-red-700 text-sm font-medium";
                setTimeout(() => {
                    feedback.textContent = "ç­‰å¾…æƒæ...";
                    feedback.className = "text-center p-3 rounded-lg bg-blue-50 text-[#002060] text-sm font-medium";
                }, 2000);
                return;
            }
            const s = rosterMap[code];
            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/attendance_records`), {
                studentId: s.studentId, name: s.name, checkInTime: serverTimestamp()
            });
            feedback.innerHTML = `âœ… <b>${s.name}</b> é»åæˆåŠŸ`;
            feedback.className = "text-center p-3 rounded-lg bg-green-100 text-green-700 text-sm font-medium";
            setTimeout(() => {
                feedback.textContent = "ç­‰å¾…æƒæ...";
                feedback.className = "text-center p-3 rounded-lg bg-blue-50 text-[#002060] text-sm font-medium";
            }, 2000);
        }

        window.exportToCSV = async () => {
            if (!userId) return showModal('éŒ¯èª¤', 'è«‹å…ˆç™»å…¥æ‰èƒ½åŒ¯å‡º');
            const snap = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/attendance_records`));
            let csv = "\uFEFFæ™‚é–“,æ—¥æœŸ,å­¸è™Ÿ,å§“å\n";
            const recs = [];
            snap.forEach(d => recs.push(d.data()));
            recs.sort((a,b) => (a.checkInTime?.seconds||0)-(b.checkInTime?.seconds||0));
            recs.forEach(r => {
                const d = r.checkInTime ? new Date(r.checkInTime.seconds*1000) : new Date();
                csv += `${d.toLocaleTimeString()},${d.toLocaleDateString()},${r.studentId},${r.name}\n`;
            });
            const url = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
            const a = document.createElement('a'); a.href = url; a.download = 'é»å.csv'; a.click();
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.querySelectorAll('button[id^="tab-"]').forEach(btn => {
                btn.classList.remove('bg-white', 'shadow', 'text-[#002060]');
                btn.classList.add('text-gray-500');
            });
            const activeBtn = document.getElementById(`tab-${tab}`);
            activeBtn.classList.add('bg-white', 'shadow', 'text-[#002060]');
            activeBtn.classList.remove('text-gray-500');

            if (tab === 'scanner' && userId) startCamera(); else stopCamera();
        };
        
        window.showModal = (t, m) => {
            document.getElementById('modal-title').textContent = t;
            document.getElementById('modal-message').textContent = m;
            document.getElementById('modal').classList.remove('hidden');
        };

        // å•Ÿå‹•
        initApp();
        switchTab('scanner');
    </script>
</body>
</html>
