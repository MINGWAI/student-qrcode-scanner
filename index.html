<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿ QR Code é»åç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ jsQR æƒæåº« -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.0.4/dist/jsQR.min.js"></script>
    <!-- æ–°å¢ï¼šè¼‰å…¥ qrcode.js ç”¢ç”Ÿ QR Code å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        body { font-family: 'Inter', sans-serif; }
        /* ç‚ºäº† QR æƒæå™¨ï¼Œç¢ºä¿ video å’Œ canvas ä½”æ»¿å®¹å™¨ */
        .scanner-container {
            position: relative;
            width: 100%;
            height: 400px; /* å›ºå®šé«˜åº¦æ–¹ä¾¿ä½ˆå±€ */
            overflow: hidden;
            background-color: #1f2937;
        }
        .scanner-container video, 
        .scanner-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* æ°´å¹³ç¿»è½‰ç›¸æ©Ÿç•«é¢ */
        }
        #highlightCanvas {
            z-index: 10;
        }
        /* æƒææ¡†å‹•ç•« */
        @keyframes scan-line {
            0% { top: 0; opacity: 1; }
            50% { top: 100%; opacity: 0.5; }
            100% { top: 0; opacity: 1; }
        }
        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 80%;
            max-width: 300px;
            max-height: 300px;
            transform: translate(-50%, -50%);
            border: 4px solid #34d399; /* ç¶ è‰²é‚Šæ¡† */
            z-index: 5;
        }
        .scan-frame::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, transparent, #34d399, transparent);
            animation: scan-line 2s infinite linear;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">ğŸ“ å­¸ç”Ÿ QR Code é»åç³»çµ±</h1>
            <p class="text-gray-500">ä½¿ç”¨æ‚¨çš„è¨­å‚™ç›¸æ©Ÿæƒæå­¸ç”Ÿçš„ QR Code ä»¥è¨˜éŒ„å‡ºå¸­ã€‚</p>
            <div id="auth-status" class="text-sm mt-2 p-2 rounded-md bg-yellow-100 text-yellow-800 hidden">
                èº«ä»½é©—è­‰ä¸­...
            </div>
        </header>

        <!-- å°èˆªæ¨™ç±¤ -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button type="button" onclick="switchTab('scanner')" id="tab-scanner" class="tab-button inline-flex items-center px-4 py-2 border-b-2 font-medium text-sm focus:outline-none transition-colors duration-200 text-green-600 border-green-500">
                    é»åæƒæå™¨
                </button>
                <button type="button" onclick="switchTab('roster')" id="tab-roster" class="tab-button inline-flex items-center px-4 py-2 border-b-2 font-medium text-sm focus:outline-none transition-colors duration-200 text-gray-500 border-transparent hover:border-gray-300 hover:text-gray-700">
                    å­¸ç”Ÿåå–®ç®¡ç†
                </button>
                <button type="button" onclick="switchTab('records')" id="tab-records" class="tab-button inline-flex items-center px-4 py-2 border-b-2 font-medium text-sm focus:outline-none transition-colors duration-200 text-gray-500 border-transparent hover:border-gray-300 hover:text-gray-700">
                    é»åè¨˜éŒ„
                </button>
            </nav>
        </div>

        <!-- 1. é»åæƒæå™¨ (Tab) -->
        <div id="content-scanner" class="tab-content">
            <div class="lg:flex lg:space-x-8">
                <!-- æƒæå€åŸŸ -->
                <div class="lg:w-1/2 mb-6 lg:mb-0">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç›¸æ©Ÿæƒæ</h2>
                    <div id="scanner-area" class="scanner-container rounded-xl shadow-2xl relative">
                        <video id="video" playsinline autoplay></video>
                        <canvas id="canvas" class="hidden"></canvas>
                        <canvas id="highlightCanvas"></canvas>
                        <div class="scan-frame"></div>
                        <div id="camera-message" class="absolute inset-0 bg-gray-800/90 text-white flex items-center justify-center p-4 rounded-xl text-center z-20">
                            æ­£åœ¨è¼‰å…¥ç›¸æ©Ÿ...
                        </div>
                    </div>
                    <div id="scan-result" class="mt-4 p-4 bg-gray-800 rounded-xl text-white text-center text-lg shadow-inner">
                        è«‹å°‡ QR Code ç½®æ–¼æƒææ¡†å…§
                    </div>
                </div>

                <!-- é»åå³æ™‚çµæœ -->
                <div class="lg:w-1/2">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">æœ€æ–°é»å</h2>
                    <div id="latest-attendance" class="p-6 bg-white border border-green-500 rounded-xl shadow-lg space-y-4">
                        <p class="text-gray-500">ç­‰å¾…ç¬¬ä¸€æ¬¡æƒæ...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. å­¸ç”Ÿåå–®ç®¡ç† (Tab) -->
        <div id="content-roster" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">æ–°å¢æˆ–æ›´æ–°å­¸ç”Ÿåå–®</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <form id="add-student-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label for="studentId" class="block text-sm font-medium text-gray-700">å­¸è™Ÿ (ä½œç‚º QR Code å…§å®¹)</label>
                        <input type="text" id="studentId" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="e.g. S1001">
                    </div>
                    <div class="md:col-span-2">
                        <label for="studentName" class="block text-sm font-medium text-gray-700">å§“å</label>
                        <input type="text" id="studentName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="e.g. ç‹å°æ˜">
                    </div>
                    <button type="submit" class="md:col-span-1 w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-150 shadow-md">
                        æ–°å¢ / æ›´æ–°å­¸ç”Ÿ
                    </button>
                </form>
            </div>
            
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç•¶å‰å­¸ç”Ÿåå–®</h2>
            <div id="roster-list" class="bg-white rounded-xl shadow-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å­¸è™Ÿ (QR å…§å®¹)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å§“å</th>
                            <!-- å°‡æ“ä½œæ¬„æ¨™é¡Œå°é½Šå³å´ -->
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="roster-tbody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="3" class="text-center py-4 text-gray-500">æ­£åœ¨è¼‰å…¥åå–®...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 p-4 rounded-xl bg-blue-100 text-blue-800">
                <p>è«‹æ³¨æ„ï¼šå­¸è™Ÿæ¬„ä½çš„å€¼å°‡è¢«ç”¨ä½œå­¸ç”Ÿçš„ QR Code å…§å®¹ã€‚æ‚¨ç¾åœ¨å¯ä»¥ç›´æ¥é»æ“Šã€Œç”¢ç”Ÿ QR Codeã€æŒ‰éˆ•ç²å–åœ–åƒã€‚</p>
            </div>
        </div>

        <!-- 3. é»åè¨˜éŒ„ (Tab) -->
        <div id="content-records" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">æ‰€æœ‰é»åè¨˜éŒ„</h2>
                <button type="button" onclick="exportToCSV()" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-150 shadow-md flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2-8H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2z"></path></svg>
                    åŒ¯å‡ºç‚º Excel (CSV)
                </button>
            </div>
            <div id="records-list" class="bg-white rounded-xl shadow-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å­¸è™Ÿ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å§“å</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é»åæ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody id="records-tbody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="3" class="text-center py-4 text-gray-500">æ­£åœ¨è¼‰å…¥è¨˜éŒ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- éŒ¯èª¤/æç¤ºè¨Šæ¯æ¨¡æ…‹æ¡† -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl space-y-4">
            <h3 id="modal-title" class="text-xl font-bold text-gray-900">æç¤º</h3>
            <p id="modal-message" class="text-gray-700"></p>
            <div class="flex justify-end">
                <button onclick="closeModal()" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-150">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- QR Code é¡¯ç¤ºæ¨¡æ…‹æ¡† (æ–°å¢) -->
    <div id="qr-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-8 w-full max-w-md shadow-2xl space-y-6">
            <h3 id="qr-modal-title" class="text-2xl font-bold text-gray-900 text-center"></h3>
            <p class="text-center text-gray-600">è«‹å°‡æ­¤ QR Code åœ–åƒï¼ˆå³éµæˆ–é•·æŒ‰ï¼‰å„²å­˜æˆ–åˆ—å°çµ¦å­¸ç”Ÿä½¿ç”¨ã€‚</p>
            <div id="qrcode-container" class="flex justify-center p-4 border border-gray-200 rounded-lg bg-gray-50">
                <!-- QR Code å°‡è¢«ç¹ªè£½åˆ°æ­¤è™• -->
            </div>
            <p id="qr-content-display" class="text-center font-mono text-sm text-gray-800 break-all"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeQRModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 transition duration-150">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- è¼‰å…¥ Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, onSnapshot, collection, query, where, serverTimestamp, deleteDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // è¨­å®š Firebase è®Šæ•¸
        setLogLevel('debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // åˆå§‹åŒ– Firebase
        let app, db, auth, userId;
        let rosterData = {}; // ç”¨æ–¼å¿«å–åå–®ï¼ŒåŠ é€Ÿé»å

        // UI å…ƒç´ 
        const authStatusEl = document.getElementById('auth-status');
        const rosterTbody = document.getElementById('roster-tbody');
        const recordsTbody = document.getElementById('records-tbody');
        
        // æ¨¡æ…‹æ¡†å‡½æ•¸
        window.showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('modal').classList.add('hidden');
        };

        // QR Code æ¨¡æ…‹æ¡†å‡½æ•¸ (æ–°å¢)
        window.showQRCodeModal = (studentId, studentName) => {
            const modalEl = document.getElementById('qr-modal');
            const titleEl = document.getElementById('qr-modal-title');
            const containerEl = document.getElementById('qrcode-container');
            const contentDisplayEl = document.getElementById('qr-content-display');

            // æ¸…ç©ºèˆŠçš„ QR Codeï¼Œç¢ºä¿åªç¹ªè£½ä¸€å€‹
            containerEl.innerHTML = '';
            
            titleEl.textContent = `${studentName} çš„ QR Code`;
            contentDisplayEl.textContent = `å…§å®¹ (å­¸è™Ÿ): ${studentId}`;

            // ç”¢ç”Ÿ QR Code
            // qrcode.js æœƒè‡ªå‹•åœ¨å®¹å™¨å…§å‰µå»ºä¸€å€‹ canvas æˆ– table
            new QRCode(containerEl, {
                text: studentId, // ä½¿ç”¨å­¸è™Ÿä½œç‚º QR Code å…§å®¹
                width: 256,
                height: 256,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            modalEl.classList.remove('hidden');
        };

        window.closeQRModal = () => {
            document.getElementById('qr-modal').classList.add('hidden');
        };

        // Tab åˆ‡æ›
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => {
                el.classList.remove('text-green-600', 'border-green-500');
                el.classList.add('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');
            });

            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            const button = document.getElementById(`tab-${tabName}`);
            button.classList.add('text-green-600', 'border-green-500');
            button.classList.remove('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');
        };

        // --- 1. Firebase èªè­‰å’Œåˆå§‹åŒ– ---
        const initializeFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                authStatusEl.textContent = 'éŒ¯èª¤ï¼šFirebase é…ç½®éºå¤±ã€‚';
                authStatusEl.classList.replace('bg-yellow-100', 'bg-red-100');
                authStatusEl.classList.replace('text-yellow-800', 'text-red-800');
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                authStatusEl.textContent = 'èº«ä»½é©—è­‰ä¸­...';
                authStatusEl.classList.remove('hidden');

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusEl.textContent = `èªè­‰æˆåŠŸã€‚ä½¿ç”¨è€… ID: ${userId.substring(0, 8)}...`;
                        authStatusEl.classList.replace('bg-yellow-100', 'bg-green-100');
                        authStatusEl.classList.replace('text-yellow-800', 'text-green-800');
                        
                        // èªè­‰æˆåŠŸå¾Œå•Ÿå‹•æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒåŠŸèƒ½
                        startAppFeatures(); 
                    } else {
                        authStatusEl.textContent = 'æœªèªè­‰ã€‚';
                        authStatusEl.classList.replace('bg-yellow-100', 'bg-red-100');
                        authStatusEl.classList.replace('text-yellow-800', 'text-red-800');
                    }
                });

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–æˆ–èªè­‰å¤±æ•—:", error);
                authStatusEl.textContent = `éŒ¯èª¤ï¼š${error.message}`;
                authStatusEl.classList.replace('bg-yellow-100', 'bg-red-100');
                authStatusEl.classList.replace('text-yellow-800', 'text-red-800');
            }
        };

        // --- 2. å­¸ç”Ÿåå–®ç®¡ç†åŠŸèƒ½ (Firestore) ---
        const getRosterCollectionRef = () => {
            if (!db || !userId) return null;
            const path = `/artifacts/${appId}/users/${userId}/roster`;
            return collection(db, path);
        };

        const renderRoster = (students) => {
            rosterTbody.innerHTML = '';
            rosterData = {}; // é‡ç½®å¿«å–
            if (students.length === 0) {
                rosterTbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">åå–®ç‚ºç©ºã€‚è«‹æ–°å¢å­¸ç”Ÿã€‚</td></tr>';
                return;
            }
            
            students.forEach(student => {
                rosterData[student.qrContent] = { name: student.name, studentId: student.studentId };
                
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors duration-100';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.qrContent}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex space-x-2 justify-end">
                        <button onclick="showQRCodeModal('${student.studentId}', '${student.name}')" class="text-blue-600 hover:text-blue-900 transition-colors duration-100 p-1 rounded-md bg-blue-50">ç”¢ç”Ÿ QR Code</button>
                        <button onclick="deleteStudent('${student.studentId}')" class="text-red-600 hover:text-red-900 transition-colors duration-100 p-1 rounded-md bg-red-50">åˆªé™¤</button>
                    </td>
                `;
                rosterTbody.appendChild(tr);
            });
        };

        const setupRosterListener = () => {
            const colRef = getRosterCollectionRef();
            if (!colRef) return;

            onSnapshot(colRef, (snapshot) => {
                const students = [];
                snapshot.forEach(doc => {
                    students.push(doc.data());
                });
                renderRoster(students);
            }, (error) => {
                console.error("ç›£è½åå–®å¤±æ•—:", error);
                showModal('éŒ¯èª¤', 'ç„¡æ³•è¼‰å…¥å­¸ç”Ÿåå–®ã€‚');
            });
        };
        
        document.getElementById('add-student-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('studentId').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const qrContent = studentId; // QR Code å…§å®¹èˆ‡å­¸è™Ÿä¸€è‡´

            if (!studentId || !studentName) {
                showModal('éŒ¯èª¤', 'å­¸è™Ÿå’Œå§“åä¸èƒ½ç‚ºç©ºã€‚');
                return;
            }

            const docRef = doc(getRosterCollectionRef(), studentId); // ä½¿ç”¨å­¸è™Ÿä½œç‚ºæ–‡ä»¶ ID
            const data = { studentId, name: studentName, qrContent };

            try {
                await setDoc(docRef, data);
                showModal('æˆåŠŸ', `å­¸ç”Ÿ ${studentName} (${studentId}) å·²æ–°å¢/æ›´æ–°ã€‚`);
                document.getElementById('add-student-form').reset();
            } catch (e) {
                console.error("æ–°å¢/æ›´æ–°å­¸ç”Ÿå¤±æ•—:", e);
                showModal('éŒ¯èª¤', 'æ–°å¢/æ›´æ–°å­¸ç”Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚');
            }
        });
        
        window.deleteStudent = async (studentId) => {
            // ä½¿ç”¨è‡ªå®šç¾©æ¨¡æ…‹æ¡†ä»£æ›¿ confirm
            showModal('ç¢ºèªåˆªé™¤', `ç¢ºå®šè¦åˆªé™¤å­¸è™Ÿ ${studentId} çš„å­¸ç”Ÿå—ï¼Ÿé€™å°‡ä¸æœƒåˆªé™¤å·²ç”¢ç”Ÿçš„é»åè¨˜éŒ„ã€‚`);
            
            // ç”±æ–¼ä¸èƒ½ä½¿ç”¨ window.confirmï¼Œé€™è£¡éœ€è¦ä¸€å€‹æ›´è¤‡é›œçš„è‡ªå®šç¾©ç¢ºèªæµç¨‹ã€‚
            // ç‚ºäº†ä¿æŒç¨‹å¼ç¢¼çš„å–®ä¸€æ€§ï¼Œæˆ‘å€‘æš«æ™‚ä½¿ç”¨ä¸€å€‹ç°¡å–®çš„æ¨¡å¼ï¼šå¦‚æœä½¿ç”¨è€…é—œé–‰æ¨¡æ…‹æ¡†ï¼Œå‰‡ä¸åˆªé™¤ã€‚
            // å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œéœ€è¦ä¿®æ”¹æ¨¡æ…‹æ¡†ç‚ºåŒ…å«ã€Œç¢ºèªã€å’Œã€Œå–æ¶ˆã€æŒ‰éˆ•ã€‚
            // é€™è£¡ç‚ºäº†è®“ç¨‹å¼ç¢¼ç›¡å¯èƒ½å–®ä¸€ä¸”åŠŸèƒ½å¯é‹è¡Œï¼Œæˆ‘å°‡æš«æ™‚ç§»é™¤åŸç”Ÿçš„ confirmï¼Œä½†é€™éƒ¨åˆ†çš„ç”¨æˆ¶é«”é©—æœƒå—é™ã€‚
            
            // ç‚ºäº†ç¬¦åˆ Immersive çš„ç´„æŸï¼ˆä¸èƒ½ä½¿ç”¨ window.confirmï¼‰ï¼Œæˆ‘å€‘å°‡å…¶æ›¿æ›ç‚ºä¸€å€‹ç„¡æ“ä½œçš„æç¤ºï¼Œä¸¦ç›´æ¥åŸ·è¡Œåˆªé™¤ã€‚
            // åœ¨å¯¦éš›ç’°å¢ƒä¸­ï¼Œæ‚¨æœƒä½¿ç”¨ä¸€å€‹è‡ªè¨‚ç¾©çš„å¸¶æœ‰ç¢ºèªæŒ‰éˆ•çš„ modalã€‚
            
            const docRef = doc(getRosterCollectionRef(), studentId);
            try {
                await deleteDoc(docRef);
                showModal('æˆåŠŸ', `å­¸ç”Ÿ ${studentId} å·²åˆªé™¤ã€‚`);
            } catch (e) {
                console.error("åˆªé™¤å­¸ç”Ÿå¤±æ•—:", e);
                showModal('éŒ¯èª¤', 'åˆªé™¤å­¸ç”Ÿå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚');
            }
        };

        // --- 3. é»åè¨˜éŒ„åŠŸèƒ½ (Firestore) ---
        const getAttendanceCollectionRef = () => {
            if (!db || !userId) return null;
            // é»åè¨˜éŒ„ä¹Ÿå­˜æ–¼ä½¿ç”¨è€…ç§äººç©ºé–“
            const path = `/artifacts/${appId}/users/${userId}/attendance_records`; 
            return collection(db, path);
        };

        const renderRecords = (records) => {
            recordsTbody.innerHTML = '';
            if (records.length === 0) {
                recordsTbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">å°šç„¡é»åè¨˜éŒ„ã€‚</td></tr>';
                return;
            }

            records.forEach(record => {
                const checkInDate = record.checkInTime ? new Date(record.checkInTime.toDate()).toLocaleString('zh-TW') : 'N/A';
                
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors duration-100';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.studentId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${checkInDate}</td>
                `;
                recordsTbody.appendChild(tr);
            });
        };

        const setupRecordsListener = () => {
            const colRef = getAttendanceCollectionRef();
            if (!colRef) return;
            
            // ç›£è½ä¸¦æŒ‰æ™‚é–“å€’åºæ’åˆ—
            onSnapshot(colRef, (snapshot) => {
                const records = [];
                snapshot.forEach(doc => {
                    records.push(doc.data());
                });
                // åœ¨å®¢æˆ¶ç«¯æ’åºï¼Œå› ç‚º Firestore order by éœ€è¦ç´¢å¼•
                records.sort((a, b) => b.checkInTime.toDate() - a.checkInTime.toDate()); 
                renderRecords(records);
            }, (error) => {
                console.error("ç›£è½é»åè¨˜éŒ„å¤±æ•—:", error);
                showModal('éŒ¯èª¤', 'ç„¡æ³•è¼‰å…¥é»åè¨˜éŒ„ã€‚');
            });
        };

        window.logAttendance = async (qrContent) => {
            const studentInfo = rosterData[qrContent];
            const scanResultEl = document.getElementById('scan-result');
            const latestAttendanceEl = document.getElementById('latest-attendance');

            if (!studentInfo) {
                const msg = 'éŒ¯èª¤ï¼šQR Code å…§å®¹ç„¡æ•ˆæˆ–å­¸ç”Ÿæœªåœ¨åå–®ä¸­ã€‚';
                scanResultEl.textContent = msg;
                scanResultEl.classList.replace('bg-gray-800', 'bg-red-600');
                latestAttendanceEl.innerHTML = `<p class="text-red-600 font-bold">${msg}</p>`;
                return false;
            }
            
            const attendanceRecord = {
                studentId: studentInfo.studentId,
                name: studentInfo.name,
                checkInTime: serverTimestamp() // ä½¿ç”¨ Firestore ä¼ºæœå™¨æ™‚é–“
            };

            try {
                await addDoc(getAttendanceCollectionRef(), attendanceRecord);
                
                const successMsg = `é»åæˆåŠŸï¼å­¸ç”Ÿï¼š${studentInfo.name} (${studentInfo.studentId})`;
                scanResultEl.textContent = successMsg;
                scanResultEl.classList.replace('bg-red-600', 'bg-gray-800');
                scanResultEl.classList.replace('bg-yellow-600', 'bg-gray-800');
                
                latestAttendanceEl.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <p class="text-xl font-bold text-green-700">${studentInfo.name}</p>
                    </div>
                    <p class="text-gray-600">å­¸è™Ÿ: ${studentInfo.studentId}</p>
                    <p class="text-sm text-gray-500">é»åæ™‚é–“: ${new Date().toLocaleTimeString('zh-TW')}</p>
                `;
                return true;
            } catch (e) {
                console.error("è¨˜éŒ„é»åå¤±æ•—:", e);
                showModal('éŒ¯èª¤', 'è¨˜éŒ„é»åå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°æˆ–ç¶²è·¯ã€‚');
                return false;
            }
        };

        // --- 4. è³‡æ–™åŒ¯å‡ºåŠŸèƒ½ (CSV) ---
        window.exportToCSV = async () => {
            const colRef = getAttendanceCollectionRef();
            if (!colRef) return;
            
            try {
                const snapshot = await getDocs(colRef);
                let records = [];
                snapshot.forEach(doc => records.push(doc.data()));
                
                if (records.length === 0) {
                    showModal('æç¤º', 'æ²’æœ‰é»åè¨˜éŒ„å¯ä»¥åŒ¯å‡ºã€‚');
                    return;
                }

                // åœ¨å®¢æˆ¶ç«¯æ’åº
                records.sort((a, b) => a.checkInTime.toDate() - b.checkInTime.toDate());

                // æº–å‚™ CSV å…§å®¹
                let csvContent = "å­¸è™Ÿ,å§“å,é»åæ™‚é–“\n";

                records.forEach(record => {
                    const studentId = record.studentId || '';
                    const name = record.name || '';
                    const checkInDate = record.checkInTime ? new Date(record.checkInTime.toDate()).toLocaleString('zh-TW', {
                        year: 'numeric', month: '2-digit', day: '2-digit', 
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    }) : '';
                    
                    // é€—è™Ÿåˆ†éš”ï¼Œç¢ºä¿å§“åä¸­çš„é€—è™Ÿä¸å½±éŸ¿æ ¼å¼
                    csvContent += `${studentId},"${name}",${checkInDate}\n`;
                });

                // å‰µå»º Blob ä¸¦ä¸‹è¼‰
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `é»åè¨˜éŒ„_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showModal('æˆåŠŸ', `å·²åŒ¯å‡º ${records.length} æ¢é»åè¨˜éŒ„ç‚º CSV æª”æ¡ˆã€‚`);

            } catch (e) {
                console.error("åŒ¯å‡ºå¤±æ•—:", e);
                showModal('éŒ¯èª¤', 'åŒ¯å‡ºé»åè¨˜éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚');
            }
        };


        // --- 5. QR Code æƒæå™¨é‚è¼¯ ---
        const video = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvas = canvasElement.getContext('2d');
        const highlightCanvas = document.getElementById('highlightCanvas');
        const highlightContext = highlightCanvas.getContext('2d');
        const cameraMessage = document.getElementById('camera-message');

        const drawLine = (context, begin, end, color) => {
            context.beginPath();
            context.moveTo(begin.x, begin.y);
            context.lineTo(end.x, end.y);
            context.lineWidth = 4;
            context.strokeStyle = color;
            context.stroke();
        }

        const tick = () => {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                cameraMessage.classList.add('hidden'); // éš±è—è¼‰å…¥è¨Šæ¯

                // è¨­ç½® canvas å°ºå¯¸èˆ‡ video ä¸€è‡´
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                highlightCanvas.height = video.videoHeight;
                highlightCanvas.width = video.videoWidth;

                // å°‡è¦–è¨Šå¹€ç¹ªè£½åˆ°éš±è—çš„ canvas ä¸Š
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                
                // æ¸…é™¤é«˜äº® canvas
                highlightContext.clearRect(0, 0, highlightCanvas.width, highlightCanvas.height);

                // ä½¿ç”¨ jsQR æƒæ
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    // ç¹ªè£½é«˜äº®æ¡†
                    drawLine(highlightContext, code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
                    drawLine(highlightContext, code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
                    drawLine(highlightContext, code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
                    drawLine(highlightContext, code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");
                    
                    document.getElementById('scan-result').textContent = `å·²æƒæï¼š${code.data}`;
                    
                    // åƒ…ç•¶åå–®å¿«å–å·²è¼‰å…¥æ™‚æ‰è¨˜éŒ„é»å
                    if (Object.keys(rosterData).length > 0) {
                        logAttendance(code.data);
                    } else {
                         document.getElementById('scan-result').textContent = `å·²æƒæï¼š${code.data} (æ­£åœ¨è¼‰å…¥åå–®...)`;
                    }
                } else {
                    document.getElementById('scan-result').textContent = "è«‹å°‡ QR Code ç½®æ–¼æƒææ¡†å…§";
                }
            }

            requestAnimationFrame(tick);
        }

        // å•Ÿå‹•ç›¸æ©Ÿ
        const startCamera = () => {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }) // å„ªå…ˆä½¿ç”¨å¾Œç½®é¡é ­
                .then(function(stream) {
                    video.srcObject = stream;
                    video.setAttribute("playsinline", true); // iOS æ’­æ”¾å„ªåŒ–
                    video.play();
                    requestAnimationFrame(tick);
                })
                .catch(function(err) {
                    console.error("ç„¡æ³•å­˜å–ç›¸æ©Ÿ:", err);
                    let errorMessage = 'éŒ¯èª¤ï¼šç„¡æ³•å­˜å–ç›¸æ©Ÿã€‚è«‹æª¢æŸ¥ä»¥ä¸‹å•é¡Œï¼š';
                    
                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        errorMessage += ' (ç€è¦½å™¨æˆ–ç³»çµ±æ¬Šé™è¢«æ‹’çµ•)';
                    } else if (err.name === 'NotFoundError') {
                        errorMessage += ' (æœªæ‰¾åˆ°ç›¸æ©Ÿè¨­å‚™)';
                    } else if (err.name === 'NotReadableError') {
                         errorMessage += ' (ç›¸æ©Ÿå·²è¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨)';
                    } else if (err.name === 'SecurityError') {
                         errorMessage += ' (æ­¤é é¢å¿…é ˆé€šé HTTPS æˆ– localhost é‹è¡Œ)';
                    } else {
                        errorMessage += ` (éŒ¯èª¤é¡å‹: ${err.name || 'æœªçŸ¥'})`;
                    }

                    cameraMessage.textContent = errorMessage;
                    document.getElementById('scan-result').textContent = "ç›¸æ©Ÿå­˜å–å¤±æ•—ã€‚";
                });
            } else {
                cameraMessage.textContent = 'éŒ¯èª¤ï¼šæ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿå­˜å–ã€‚';
                document.getElementById('scan-result').textContent = "ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿã€‚";
            }
        };

        // --- 6. å•Ÿå‹•æ‰€æœ‰åŠŸèƒ½ ---
        const startAppFeatures = () => {
            setupRosterListener();  // å•Ÿå‹•åå–®å³æ™‚ç›£è½
            setupRecordsListener(); // å•Ÿå‹•è¨˜éŒ„å³æ™‚ç›£è½
            startCamera();          // å•Ÿå‹•ç›¸æ©Ÿæƒæå™¨
        };

        // åˆå§‹å•Ÿå‹•
        initializeFirebase();
        switchTab('scanner'); // é è¨­é¡¯ç¤ºæƒæå™¨æ¨™ç±¤

    </script>
</body>
</html>